<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>í‚¤ì›Œë“œ ë¶„ì„ ëŒ€ì‹œë³´ë“œ - TrendStream</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3.0.0/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/wordcloud@1.2.2/src/WordCloud.min.js"></script>
    <style>
        .keyword-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
        }
        .stats-card {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            border-left: 4px solid #667eea;
        }
        .chart-container {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
        }
        .wordcloud-container {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            text-align: center;
        }
        .keyword-badge {
            display: inline-block;
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            margin: 4px;
            font-size: 14px;
            font-weight: 500;
        }
        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }
        .refresh-btn {
            background: linear-gradient(45deg, #667eea, #764ba2);
            border: none;
            color: white;
            padding: 10px 20px;
            border-radius: 25px;
            font-weight: 500;
        }
        .refresh-btn:hover {
            background: linear-gradient(45deg, #5a6fd8, #6a4190);
            color: white;
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <!-- í—¤ë” -->
        <div class="row">
            <div class="col-12">
                <div class="keyword-card">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h2><i class="fas fa-chart-line me-2"></i>í‚¤ì›Œë“œ ë¶„ì„ ëŒ€ì‹œë³´ë“œ</h2>
                            <p class="mb-0">ì»¤ë®¤ë‹ˆí‹° ê²Œì‹œë¬¼ì˜ í‚¤ì›Œë“œ íŠ¸ë Œë“œë¥¼ ì‹¤ì‹œê°„ìœ¼ë¡œ ë¶„ì„í•©ë‹ˆë‹¤</p>
                        </div>
                        <button class="btn refresh-btn" onclick="refreshData()">
                            <i class="fas fa-sync-alt me-2"></i>ìƒˆë¡œê³ ì¹¨
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- í•„í„° ì„¹ì…˜ -->
        <div class="row">
            <div class="col-12">
                <div class="stats-card">
                    <h5><i class="fas fa-filter me-2"></i>ë¶„ì„ í•„í„°</h5>
                    <div class="row">
                        <div class="col-md-3">
                            <label class="form-label">ì‹œì‘ ë‚ ì§œ</label>
                            <input type="datetime-local" class="form-control" id="startDate">
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">ì¢…ë£Œ ë‚ ì§œ</label>
                            <input type="datetime-local" class="form-control" id="endDate">
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">ì»¤ë®¤ë‹ˆí‹°</label>
                            <select class="form-select" id="communityFilter">
                                <option value="">ì „ì²´</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">ê²Œì‹œíŒ</label>
                            <select class="form-select" id="boardFilter">
                                <option value="">ì „ì²´</option>
                            </select>
                        </div>
                    </div>
                    <div class="row mt-3">
                        <div class="col-md-6">
                            <label class="form-label">í‚¤ì›Œë“œ (ì‰¼í‘œë¡œ êµ¬ë¶„)</label>
                            <input type="text" class="form-control" id="keywords" placeholder="ì˜ˆ: AI,ì°½ì‘,ë“œë˜ê³¤">
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">ì§‘ê³„ ë‹¨ìœ„</label>
                            <select class="form-select" id="granularity">
                                <option value="1h">1ì‹œê°„</option>
                                <option value="1d" selected>1ì¼</option>
                                <option value="1w">1ì£¼</option>
                            </select>
                        </div>
                        <div class="col-md-3 d-flex align-items-end">
                            <button class="btn btn-primary w-100" onclick="applyFilters()">
                                <i class="fas fa-search me-2"></i>ë¶„ì„ ì‹¤í–‰
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- í†µê³„ ì¹´ë“œ -->
        <div class="row" id="statsRow">
            <div class="col-md-3">
                <div class="stats-card">
                    <div class="d-flex align-items-center">
                        <div class="me-3">
                            <i class="fas fa-file-alt fa-2x text-primary"></i>
                        </div>
                        <div>
                            <h6 class="text-muted mb-1">ì´ ê²Œì‹œê¸€</h6>
                            <h4 class="mb-0" id="totalPosts">-</h4>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stats-card">
                    <div class="d-flex align-items-center">
                        <div class="me-3">
                            <i class="fas fa-comments fa-2x text-success"></i>
                        </div>
                        <div>
                            <h6 class="text-muted mb-1">ì´ ëŒ“ê¸€</h6>
                            <h4 class="mb-0" id="totalComments">-</h4>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stats-card">
                    <div class="d-flex align-items-center">
                        <div class="me-3">
                            <i class="fas fa-tags fa-2x text-warning"></i>
                        </div>
                        <div>
                            <h6 class="text-muted mb-1">ì¶”ì¶œëœ í‚¤ì›Œë“œ</h6>
                            <h4 class="mb-0" id="totalKeywords">-</h4>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stats-card">
                    <div class="d-flex align-items-center">
                        <div class="me-3">
                            <i class="fas fa-fire fa-2x text-danger"></i>
                        </div>
                        <div>
                            <h6 class="text-muted mb-1">ì¸ê¸° í‚¤ì›Œë“œ</h6>
                            <h4 class="mb-0" id="topKeyword">-</h4>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ì›Œë“œí´ë¼ìš°ë“œ -->
        <div class="row">
            <div class="col-12">
                <div class="wordcloud-container">
                    <h5><i class="fas fa-cloud me-2"></i>ì›Œë“œí´ë¼ìš°ë“œ</h5>
                    <div id="wordcloud" style="height: 400px;"></div>
                </div>
            </div>
        </div>

        <!-- í‚¤ì›Œë“œ íƒ€ì„ë¼ì¸ -->
        <div class="row">
            <div class="col-12">
                <div class="chart-container">
                    <h5><i class="fas fa-chart-line me-2"></i>í‚¤ì›Œë“œ íƒ€ì„ë¼ì¸</h5>
                    <canvas id="timelineChart" height="100"></canvas>
                </div>
            </div>
        </div>

        <!-- ìƒìœ„ í‚¤ì›Œë“œ -->
        <div class="row">
            <div class="col-12">
                <div class="chart-container">
                    <h5><i class="fas fa-trophy me-2"></i>ìƒìœ„ í‚¤ì›Œë“œ</h5>
                    <div id="topKeywords"></div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const API_BASE = 'http://localhost:8000';
        const API_KEY = 'dev_api_key_12345';
        
        let timelineChart = null;
        let wordcloudInstance = null;

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
        document.addEventListener('DOMContentLoaded', function() {
            initializeDates();
            loadCommunities();
            refreshData();
        });

        // ë‚ ì§œ ì´ˆê¸°í™” (ìµœê·¼ 7ì¼)
        function initializeDates() {
            const now = new Date();
            const weekAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
            
            document.getElementById('startDate').value = weekAgo.toISOString().slice(0, 16);
            document.getElementById('endDate').value = now.toISOString().slice(0, 16);
        }

        // ì»¤ë®¤ë‹ˆí‹° ëª©ë¡ ë¡œë“œ
        async function loadCommunities() {
            try {
                const response = await fetch(`${API_BASE}/v1/community/communities?api_key=${API_KEY}`);
                const communities = await response.json();
                
                const select = document.getElementById('communityFilter');
                select.innerHTML = '<option value="">ì „ì²´</option>';
                
                communities.forEach(community => {
                    const option = document.createElement('option');
                    option.value = community.community_name;
                    option.textContent = `${community.community_name} (${community.post_count}ê°œ ê²Œì‹œê¸€)`;
                    select.appendChild(option);
                });
            } catch (error) {
                console.error('ì»¤ë®¤ë‹ˆí‹° ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨:', error);
            }
        }

        // ë°ì´í„° ìƒˆë¡œê³ ì¹¨
        async function refreshData() {
            await Promise.all([
                loadWordcloud(),
                loadTimeline(),
                loadStats()
            ]);
        }

        // ì›Œë“œí´ë¼ìš°ë“œ ë¡œë“œ
        async function loadWordcloud() {
            try {
                const start = document.getElementById('startDate').value;
                const end = document.getElementById('endDate').value;
                const community = document.getElementById('communityFilter').value;
                const board = document.getElementById('boardFilter').value;

                if (!start || !end) {
                    showError('ì‹œì‘ ë‚ ì§œì™€ ì¢…ë£Œ ë‚ ì§œë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.');
                    return;
                }

                const params = new URLSearchParams({
                    start: new Date(start).toISOString(),
                    end: new Date(end).toISOString(),
                    top_k: 50
                });

                if (community) params.append('community', community);
                if (board) params.append('board', board);

                const response = await fetch(`${API_BASE}/v1/community/wordcloud?${params}&api_key=${API_KEY}`);
                const data = await response.json();

                if (data.words && data.words.length > 0) {
                    renderWordcloud(data.words);
                    updateStats(data.total_posts, data.total_comments, data.words.length);
                } else {
                    document.getElementById('wordcloud').innerHTML = '<p class="text-muted">ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
                }
            } catch (error) {
                console.error('ì›Œë“œí´ë¼ìš°ë“œ ë¡œë“œ ì‹¤íŒ¨:', error);
                showError('ì›Œë“œí´ë¼ìš°ë“œ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
            }
        }

        // ì›Œë“œí´ë¼ìš°ë“œ ë Œë”ë§
        function renderWordcloud(words) {
            const container = document.getElementById('wordcloud');
            container.innerHTML = '';

            if (wordcloudInstance) {
                wordcloudInstance = null;
            }

            if (words.length === 0) {
                container.innerHTML = '<p class="text-muted">í‘œì‹œí•  í‚¤ì›Œë“œê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
                return;
            }

            // WordCloud.js ì„¤ì •
            const wordcloudData = words.map(word => [word.word, word.frequency]);
            
            wordcloudInstance = WordCloud(container, {
                list: wordcloudData,
                weightFactor: 20,
                fontFamily: 'Noto Sans KR, sans-serif',
                color: function() {
                    const colors = ['#667eea', '#764ba2', '#f093fb', '#f5576c', '#4facfe', '#00f2fe'];
                    return colors[Math.floor(Math.random() * colors.length)];
                },
                backgroundColor: '#ffffff',
                gridSize: 8,
                minSize: 12,
                maxSize: 60
            });
        }

        // íƒ€ì„ë¼ì¸ ë¡œë“œ
        async function loadTimeline() {
            try {
                const start = document.getElementById('startDate').value;
                const end = document.getElementById('endDate').value;
                const keywords = document.getElementById('keywords').value;
                const granularity = document.getElementById('granularity').value;
                const community = document.getElementById('communityFilter').value;
                const board = document.getElementById('boardFilter').value;

                if (!start || !end) {
                    return;
                }

                if (!keywords.trim()) {
                    document.getElementById('timelineChart').style.display = 'none';
                    return;
                }

                const params = new URLSearchParams({
                    start: new Date(start).toISOString(),
                    end: new Date(end).toISOString(),
                    keywords: keywords,
                    granularity: granularity
                });

                if (community) params.append('community', community);
                if (board) params.append('board', board);

                const response = await fetch(`${API_BASE}/v1/community/timeline?${params}&api_key=${API_KEY}`);
                const data = await response.json();

                if (data.series && data.series.length > 0) {
                    renderTimeline(data.series);
                } else {
                    document.getElementById('timelineChart').style.display = 'none';
                }
            } catch (error) {
                console.error('íƒ€ì„ë¼ì¸ ë¡œë“œ ì‹¤íŒ¨:', error);
            }
        }

        // íƒ€ì„ë¼ì¸ ì°¨íŠ¸ ë Œë”ë§
        function renderTimeline(series) {
            const ctx = document.getElementById('timelineChart').getContext('2d');
            document.getElementById('timelineChart').style.display = 'block';

            if (timelineChart) {
                timelineChart.destroy();
            }

            const colors = [
                '#667eea', '#764ba2', '#f093fb', '#f5576c', 
                '#4facfe', '#00f2fe', '#43e97b', '#38f9d7'
            ];

            const datasets = series.map((s, index) => ({
                label: s.keyword,
                data: s.points.map(point => ({
                    x: point.ts,
                    y: point.count
                })),
                borderColor: colors[index % colors.length],
                backgroundColor: colors[index % colors.length] + '20',
                fill: false,
                tension: 0.1
            }));

            timelineChart = new Chart(ctx, {
                type: 'line',
                data: { datasets },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            type: 'time',
                            time: {
                                unit: series[0]?.points[0]?.ts.includes('T') ? 'day' : 'hour'
                            }
                        },
                        y: {
                            beginAtZero: true
                        }
                    },
                    plugins: {
                        legend: {
                            position: 'top'
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false
                        }
                    }
                }
            });
        }

        // í†µê³„ ë¡œë“œ
        async function loadStats() {
            // ì´ë¯¸ ì›Œë“œí´ë¼ìš°ë“œì—ì„œ ë¡œë“œë¨
        }

        // í†µê³„ ì—…ë°ì´íŠ¸
        function updateStats(totalPosts, totalComments, keywordCount) {
            document.getElementById('totalPosts').textContent = totalPosts.toLocaleString();
            document.getElementById('totalComments').textContent = totalComments.toLocaleString();
            document.getElementById('totalKeywords').textContent = keywordCount;
        }

        // ìƒìœ„ í‚¤ì›Œë“œ í‘œì‹œ
        function showTopKeywords(words) {
            const container = document.getElementById('topKeywords');
            container.innerHTML = '';

            words.slice(0, 20).forEach(word => {
                const badge = document.createElement('span');
                badge.className = 'keyword-badge';
                badge.textContent = `${word.word} (${word.frequency})`;
                badge.style.fontSize = Math.max(12, Math.min(20, word.frequency / 5)) + 'px';
                container.appendChild(badge);
            });
        }

        // í•„í„° ì ìš©
        function applyFilters() {
            refreshData();
        }

        // ì—ëŸ¬ í‘œì‹œ
        function showError(message) {
            alert('ì˜¤ë¥˜: ' + message);
        }

        // ìë™ ìƒˆë¡œê³ ì¹¨ (5ë¶„ë§ˆë‹¤)
        setInterval(refreshData, 5 * 60 * 1000);

        console.log('ğŸ“Š í‚¤ì›Œë“œ ë¶„ì„ ëŒ€ì‹œë³´ë“œ ë¡œë“œ ì™„ë£Œ!');
        console.log('ğŸ”„ 5ë¶„ë§ˆë‹¤ ìë™ ìƒˆë¡œê³ ì¹¨ë©ë‹ˆë‹¤.');
    </script>
</body>
</html>
