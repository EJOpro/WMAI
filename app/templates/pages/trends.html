{% extends "base.html" %}

{% block title %}íŠ¸ë Œë“œ ë¶„ì„ - Community Admin{% endblock %}

{% block extra_css %}
<!-- Font Awesome CDN -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

<style>
    /* ì›Œë“œí´ë¼ìš°ë“œ ì»¨í…Œì´ë„ˆ */
    .wordcloud-section {
        background: white;
        padding: 2rem;
        border-radius: 0.5rem;
        box-shadow: var(--shadow);
        margin-bottom: 2rem;
    }
    
    .wordcloud-section h3 {
        margin-bottom: 1rem;
        color: var(--text-color);
    }
    
    .wordcloud-container {
        min-height: 300px;
        max-height: 300px;
        background: var(--bg-color);
        border-radius: 0.5rem;
        padding: 2rem;
        display: flex;
        align-items: center;
        justify-content: center;
        position: relative;
        overflow: hidden;
    }
    
    #wordcloudCanvas {
        width: 100%;
        max-width: 1000px;
        height: 300px;
        margin: 0 auto;
    }
    
    /* í‚¤ì›Œë“œ í´ë¼ìš°ë“œ ê°œì„  */
    .keywords-section {
        background: white;
        padding: 1.5rem;
        border-radius: 0.5rem;
        box-shadow: var(--shadow);
        margin-bottom: 2rem;
    }
    
    .keywords-section h3 {
        margin-bottom: 1rem;
    }
    
    /* ëª¨ì–‘ ì„ íƒ ë²„íŠ¼ */
    .shape-btn {
        padding: 0.5rem 0.75rem;
        background: white;
        border: 2px solid var(--border-color);
        border-radius: 0.375rem;
        cursor: pointer;
        font-size: 1.2rem;
        transition: all 0.2s;
    }
    
    .shape-btn:hover {
        background: var(--primary-color);
        border-color: var(--primary-color);
        transform: scale(1.1);
    }
    
    .shape-btn.active {
        background: var(--primary-color);
        border-color: var(--primary-color);
        box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.2);
    }
    
    /* í•„í„° ì„¹ì…˜ */
    .filter-section {
        background: white;
        padding: 1.5rem;
        border-radius: 0.5rem;
        box-shadow: var(--shadow);
        margin-bottom: 2rem;
    }
    
    .filter-grid {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 1rem;
    }
    
    .filter-item {
        display: flex;
        flex-direction: column;
    }
    
    .filter-item label {
        margin-bottom: 0.5rem;
        font-weight: 500;
        font-size: 0.875rem;
        color: var(--text-color);
    }
    
    .filter-item-wide {
        grid-column: span 2;
    }
    
    .filter-item-button {
        display: flex;
        flex-direction: column;
        justify-content: flex-end;
    }
    
    .btn-reset {
        padding: 0.5rem 1rem;
        background: white;
        border: 1px solid var(--border-color);
        border-radius: 0.375rem;
        cursor: pointer;
        font-size: 0.875rem;
        transition: all 0.2s;
        color: var(--text-color);
    }
    
    .btn-reset:hover {
        background: var(--bg-color);
        border-color: var(--primary-color);
    }
    
    @media (max-width: 1024px) {
        .filter-grid {
            grid-template-columns: repeat(2, 1fr);
        }
        .filter-item-wide {
            grid-column: span 2;
        }
    }
    
    @media (max-width: 768px) {
        .filter-grid {
            grid-template-columns: 1fr;
        }
        .filter-item-wide {
            grid-column: span 1;
        }
    }
    
    /* íƒ€ì„ë¼ì¸ ì°¨íŠ¸ ì„¹ì…˜ */
    .timeline-chart-section {
        background: white;
        padding: 1.5rem;
        border-radius: 0.5rem;
        box-shadow: var(--shadow);
        margin-bottom: 2rem;
    }
    
    .chart-container {
        position: relative;
        height: 400px;
        padding: 1rem;
        background: var(--bg-color);
        border-radius: 0.5rem;
    }
    
    .chart-container canvas {
        max-height: 100%;
    }
    
    /* í†µê³„ ì¹´ë“œ ê·¸ë¦¬ë“œ */
    .stats-cards-grid {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 1.5rem;
        margin-bottom: 2rem;
    }
    
    .stats-card {
        background: white;
        padding: 1.5rem;
        border-radius: 0.5rem;
        box-shadow: var(--shadow);
        display: flex;
        align-items: center;
        gap: 1rem;
        transition: transform 0.2s, box-shadow 0.2s;
    }
    
    .stats-card:hover {
        transform: translateY(-2px);
        box-shadow: var(--shadow-lg);
    }
    
    .stats-card-icon {
        width: 60px;
        height: 60px;
        border-radius: 0.5rem;
        display: flex;
        align-items: center;
        justify-content: center;
        background: linear-gradient(135deg, var(--primary-color) 0%, #6366F1 100%);
        color: white;
        font-size: 1.5rem;
        flex-shrink: 0;
    }
    
    .stats-icon-success {
        background: linear-gradient(135deg, var(--secondary-color) 0%, #059669 100%);
    }
    
    .stats-icon-warning {
        background: linear-gradient(135deg, var(--warning-color) 0%, #D97706 100%);
    }
    
    .stats-icon-danger {
        background: linear-gradient(135deg, var(--danger-color) 0%, #DC2626 100%);
    }
    
    .stats-card-content {
        flex: 1;
        min-width: 0;
    }
    
    .stats-card-label {
        font-size: 0.875rem;
        color: var(--text-light);
        margin-bottom: 0.5rem;
        font-weight: 500;
    }
    
    .stats-card-value {
        font-size: 2rem;
        font-weight: 700;
        color: var(--text-color);
        line-height: 1;
    }
    
    .stats-card-keyword {
        font-size: 1.5rem;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }
    
    @media (max-width: 1200px) {
        .stats-cards-grid {
            grid-template-columns: repeat(2, 1fr);
        }
    }
    
    @media (max-width: 768px) {
        .stats-cards-grid {
            grid-template-columns: 1fr;
        }
        
        .stats-card-value {
            font-size: 1.5rem;
        }
    }
    
    /* íŠ¸ë Œë“œ ìš”ì•½ ì„¹ì…˜ */
    .trends-summary {
        background: white;
        padding: 1.5rem;
        border-radius: 0.5rem;
        box-shadow: var(--shadow);
        margin-bottom: 2rem;
    }
    
    .trends-summary h3 {
        margin-bottom: 1rem;
    }
    
    .summary-grid {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 1rem;
    }
    
    .summary-item {
        display: flex;
        flex-direction: column;
        padding: 1rem;
        background: var(--bg-color);
        border-radius: 0.375rem;
    }
    
    .summary-label {
        font-size: 0.875rem;
        color: var(--text-light);
        margin-bottom: 0.5rem;
    }
    
    .summary-value {
        font-size: 1.5rem;
        font-weight: 700;
        color: var(--primary-color);
    }
    
    @media (max-width: 768px) {
        .summary-grid {
            grid-template-columns: 1fr;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="page-header">
    <h1>íŠ¸ë Œë“œ ëŒ€ì‹œë³´ë“œ</h1>
    <p>ì£¼ìš” íŠ¸ë Œë“œ ë° í‚¤ì›Œë“œ ë¶„ì„</p>
</div>

<div class="dashboard-container">
    <!-- í†µê³„ ì¹´ë“œ ê·¸ë¦¬ë“œ -->
    <div class="stats-cards-grid">
        <div class="stats-card">
            <div class="stats-card-icon">
                <i class="fas fa-file-alt"></i>
            </div>
            <div class="stats-card-content">
                <div class="stats-card-label">ì´ ê²Œì‹œê¸€</div>
                <div class="stats-card-value" id="totalPosts">-</div>
            </div>
        </div>
        
        <div class="stats-card">
            <div class="stats-card-icon stats-icon-success">
                <i class="fas fa-comments"></i>
            </div>
            <div class="stats-card-content">
                <div class="stats-card-label">ì´ ëŒ“ê¸€</div>
                <div class="stats-card-value" id="totalComments">-</div>
            </div>
        </div>
        
        <div class="stats-card">
            <div class="stats-card-icon stats-icon-warning">
                <i class="fas fa-tags"></i>
            </div>
            <div class="stats-card-content">
                <div class="stats-card-label">ì¶”ì¶œëœ í‚¤ì›Œë“œ</div>
                <div class="stats-card-value" id="totalKeywords">-</div>
            </div>
        </div>
        
        <div class="stats-card">
            <div class="stats-card-icon stats-icon-danger">
                <i class="fas fa-fire"></i>
            </div>
            <div class="stats-card-content">
                <div class="stats-card-label">ì¸ê¸° í‚¤ì›Œë“œ</div>
                <div class="stats-card-value stats-card-keyword" id="topKeyword">-</div>
            </div>
        </div>
    </div>

    <!-- í•„í„° ì„¹ì…˜ -->
    <div class="filter-section" style="display: none;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
            <h3 style="margin: 0;">ğŸ” ë¶„ì„ í•„í„°</h3>
            <button onclick="resetFilters()" class="btn-reset" title="í•„í„° ì´ˆê¸°í™”">
                ğŸ”„ ì´ˆê¸°í™”
            </button>
        </div>
        
        <div class="filter-grid">
            <!-- ë‚ ì§œ í•„í„° -->
            <div class="filter-item">
                <label for="startDate">ì‹œì‘ ë‚ ì§œ</label>
                <input type="datetime-local" id="startDate" class="form-control">
            </div>
            
            <div class="filter-item">
                <label for="endDate">ì¢…ë£Œ ë‚ ì§œ</label>
                <input type="datetime-local" id="endDate" class="form-control">
            </div>
            
            <!-- ì»¤ë®¤ë‹ˆí‹°/ê²Œì‹œíŒ í•„í„° -->
            <div class="filter-item">
                <label for="communityFilter">ì»¤ë®¤ë‹ˆí‹°</label>
                <select id="communityFilter" class="form-control">
                    <option value="">ì „ì²´</option>
                </select>
            </div>
            
            <div class="filter-item">
                <label for="boardFilter">ê²Œì‹œíŒ</label>
                <select id="boardFilter" class="form-control">
                    <option value="">ì „ì²´</option>
                </select>
            </div>
            
            <!-- í‚¤ì›Œë“œ í•„í„° -->
            <div class="filter-item filter-item-wide">
                <label for="keywordsFilter">í‚¤ì›Œë“œ (ì‰¼í‘œë¡œ êµ¬ë¶„)</label>
                <input type="text" id="keywordsFilter" class="form-control" placeholder="ì˜ˆ: AI, ë¨¸ì‹ ëŸ¬ë‹, í´ë¼ìš°ë“œ">
            </div>
            
            <!-- ì§‘ê³„ ë‹¨ìœ„ -->
            <div class="filter-item">
                <label for="granularity">ì§‘ê³„ ë‹¨ìœ„</label>
                <select id="granularity" class="form-control">
                    <option value="1h">1ì‹œê°„</option>
                    <option value="1d" selected>1ì¼</option>
                    <option value="1w">1ì£¼</option>
                </select>
            </div>
            
            <!-- ì ìš© ë²„íŠ¼ -->
            <div class="filter-item filter-item-button">
                <label>&nbsp;</label>
                <button onclick="applyFilters()" class="btn btn-primary" style="width: 100%;">
                    ğŸ” í•„í„° ì ìš©
                </button>
            </div>
        </div>
    </div>

    <!-- íŠ¸ë Œë“œ ìš”ì•½ (ì¶”ê°€) -->
    <div class="trends-summary">
        <h3>íŠ¸ë Œë“œ ìš”ì•½</h3>
        <div id="trendsSummary" class="loading">ë°ì´í„° ë¡œë”© ì¤‘...</div>
    </div>

    <!-- ì›Œë“œí´ë¼ìš°ë“œ ì„¹ì…˜ -->
    <div class="wordcloud-section">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
            <h3 style="margin: 0;">ğŸŒ ì›Œë“œí´ë¼ìš°ë“œ</h3>
            <div style="display: flex; gap: 0.5rem;">
            </div>
        </div>
        <div class="wordcloud-container">
            <div id="wordcloudCanvas"></div>
        </div>
    </div>

    <div class="keywords-section">
        <h3>ì¸ê¸° í‚¤ì›Œë“œ</h3>
        <div id="keywordsCloud" class="keywords-cloud"></div>
    </div>

    <!-- í‚¤ì›Œë“œ íƒ€ì„ë¼ì¸ ì°¨íŠ¸ -->
    <div class="timeline-chart-section">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
            <h3 style="margin: 0;">ğŸ“ˆ í‚¤ì›Œë“œ íƒ€ì„ë¼ì¸</h3>
            <div style="font-size: 0.875rem; color: var(--text-light);">
                ìƒìœ„ 5ê°œ í‚¤ì›Œë“œì˜ ì‹œê°„ë³„ ì¶”ì´
            </div>
        </div>
        <div class="chart-container">
            <canvas id="timelineChart" height="100"></canvas>
        </div>
    </div>

    <div class="trends-table">
        <h3>ìƒì„¸ íŠ¸ë Œë“œ</h3>
        <table id="trendsTable">
            <thead>
                <tr>
                    <th>ìˆœìœ„</th>
                    <th>í‚¤ì›Œë“œ</th>
                    <th>ì–¸ê¸‰ ìˆ˜</th>
                    <th>ì¦ê°ë¥ </th>
                    <th>ì¹´í…Œê³ ë¦¬</th>
                </tr>
            </thead>
            <tbody id="trendsTableBody">
                <tr><td colspan="5" class="loading">ë°ì´í„° ë¡œë”© ì¤‘...</td></tr>
            </tbody>
        </table>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- WordCloud.js CDN -->
<script src="https://cdn.jsdelivr.net/npm/wordcloud@1.2.2/src/wordcloud2.js"></script>

<!-- Chart.js CDN -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3.0.0/dist/chartjs-adapter-date-fns.bundle.min.js"></script>

<script>
    let wordcloudInstance = null;
    let currentWordcloudData = null;
    let currentShape = 'cardioid';  // ê¸°ë³¸ê°’ì„ í•˜íŠ¸ ëª¨ì–‘ìœ¼ë¡œ!
    let timelineChart = null;

    // API ìš”ì²­ í—¬í¼ í•¨ìˆ˜
    async function apiRequest(endpoint) {
        try {
            // ì‹¤ì œ API í˜¸ì¶œ ì‹œë„
            const now = new Date();
            const weekAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
            
            const wordcloudResponse = await fetch(`http://localhost:8001/api/v1/community/wordcloud?start=${weekAgo.toISOString()}&end=${now.toISOString()}&top_k=50`);
            
            if (wordcloudResponse.ok) {
                const wordcloudData = await wordcloudResponse.json();
                
                // í•œê¸€ ì¸ì½”ë”© ë¬¸ì œë¡œ ì„ì‹œ í…ŒìŠ¤íŠ¸ ë°ì´í„° ì‚¬ìš©
                const testKeywords = [
                    { word: 'ê±´ê°•', count: 15, weight: 1.0 },
                    { word: 'ìš”ë¦¬', count: 12, weight: 0.8 },
                    { word: 'ìœ¡ì•„', count: 10, weight: 0.67 },
                    { word: 'ì—¬í–‰', count: 8, weight: 0.53 },
                    { word: 'ìš´ë™', count: 7, weight: 0.47 },
                    { word: 'ë…ì„œ', count: 6, weight: 0.4 },
                    { word: 'ìŒì‹', count: 5, weight: 0.33 },
                    { word: 'ì·¨ë¯¸', count: 4, weight: 0.27 },
                    { word: 'ì¼ìƒ', count: 3, weight: 0.2 },
                    { word: 'ê³µë¶€', count: 2, weight: 0.13 }
                ];

                // íŠ¸ë Œë“œ ë³€í™” ê³„ì‚°
                const trends = testKeywords.map((word, index) => ({
                    keyword: word.word,
                    mentions: word.count,
                    change: Math.random() * 20 - 10,
                    category: 'general'
                }));

                const risingTrends = trends.filter(t => t.change > 0).length;
                const newTrends = Math.floor(testKeywords.length * 0.2); // 20%ë¥¼ ì‹ ê·œë¡œ ê°€ì •

                // íƒ€ì„ë¼ì¸ ë°ì´í„° ìƒì„± (ìµœê·¼ 7ì¼)
                const timelineData = [];
                const now = new Date();
                for (let i = 6; i >= 0; i--) {
                    const date = new Date(now);
                    date.setDate(date.getDate() - i);
                    timelineData.push({
                        date: date.toISOString().split('T')[0],
                        count: Math.floor(Math.random() * 30) + 20 // 20~50 ì‚¬ì´ ëœë¤ ê°’
                    });
                }

                return {
                    source: 'test_data',
                    summary: {
                        total_posts: wordcloudData.total_posts || 23,
                        total_comments: wordcloudData.total_comments || 47,
                        unique_keywords: testKeywords.length,
                        total_trends: testKeywords.length,
                        new_trends: newTrends,
                        rising_trends: risingTrends
                    },
                    keywords: testKeywords,
                    trends: trends,
                    wordcloud: testKeywords,
                    timeline: timelineData
                };
            }
        } catch (error) {
            console.error('API ìš”ì²­ ì˜¤ë¥˜:', error);
        }
        
        // í´ë°± ë°ì´í„°
        return {
            source: 'fallback',
            summary: {
                total_posts: 0,
                total_comments: 0,
                unique_keywords: 0,
                total_trends: 0,
                new_trends: 0,
                rising_trends: 0
            },
            keywords: [],
            trends: [],
            wordcloud: [],
            timeline: []
        };
    }

    async function loadTrendsData() {
        console.log('ğŸ”„ íŠ¸ë Œë“œ ë°ì´í„° ë¡œë”© ì‹œì‘...');
        
        // âœ… ì‹¤ì œ APIì—ì„œ ë°ì´í„° ê°€ì ¸ì˜¤ê¸° (íŠ¸ë Œë“œ ë¶„ì„ ì„œë²„ ì—°ë™)
        try {
            const data = await apiRequest('/api/trends');
            console.log('ğŸ“¦ API ì‘ë‹µ ë°›ìŒ:', data);
            
            // ê° ì—…ë°ì´íŠ¸ í•¨ìˆ˜ë¥¼ ê°œë³„ì ìœ¼ë¡œ try-catch
            try {
                updateStatsCards(data);
            } catch (err) {
                console.error('âŒ Stats Cards ì—…ë°ì´íŠ¸ ì‹¤íŒ¨:', err);
            }
            
            try {
            updateTrendsSummary(data);
            } catch (err) {
                console.error('âŒ Trends Summary ì—…ë°ì´íŠ¸ ì‹¤íŒ¨:', err);
            }
            
            try {
            updateKeywordsCloud(data);
            } catch (err) {
                console.error('âŒ Keywords Cloud ì—…ë°ì´íŠ¸ ì‹¤íŒ¨:', err);
            }
            
            try {
                updateWordcloud(data);
            } catch (err) {
                console.error('âŒ Wordcloud ì—…ë°ì´íŠ¸ ì‹¤íŒ¨:', err);
            }
            
            try {
                updateTimelineChart(data);
            } catch (err) {
                console.error('âŒ Timeline Chart ì—…ë°ì´íŠ¸ ì‹¤íŒ¨:', err);
            }
            
            try {
            updateTrendsTable(data);
            } catch (err) {
                console.error('âŒ Trends Table ì—…ë°ì´íŠ¸ ì‹¤íŒ¨:', err);
            }
            
            console.log('âœ… ì‹¤ì œ ë°ì´í„° ë¡œë“œ ì™„ë£Œ! source:', data.source);
        } catch (error) {
            console.error('âŒ API í˜¸ì¶œ ì‹¤íŒ¨:', error);
            // ì—ëŸ¬ ì‹œì—ë§Œ ë”ë¯¸ ë°ì´í„° ì‚¬ìš©
            loadDummyData();
        }
    }

    // ë”ë¯¸ ë°ì´í„°ë¡œ ì›Œë“œí´ë¼ìš°ë“œ í…ŒìŠ¤íŠ¸
    function loadDummyData() {
        console.log('ë”ë¯¸ ë°ì´í„°ë¡œ ì›Œë“œí´ë¼ìš°ë“œë¥¼ í‘œì‹œí•©ë‹ˆë‹¤.');
        
        const dummyData = {
            summary: {
                total_trends: 75,
                new_trends: 12,
                rising_trends: 28
            },
            keywords: [
                // í•«í•œ ê¸°ìˆ  í‚¤ì›Œë“œ (50ê°œ ì´ìƒ)
                { word: 'AI', count: 150 },
                { word: 'ë¨¸ì‹ ëŸ¬ë‹', count: 145 },
                { word: 'ë”¥ëŸ¬ë‹', count: 140 },
                { word: 'ChatGPT', count: 138 },
                { word: 'ìƒì„±AI', count: 135 },
                { word: 'ë°ì´í„°ë¶„ì„', count: 130 },
                { word: 'í´ë¼ìš°ë“œ', count: 125 },
                { word: 'AWS', count: 120 },
                { word: 'ë³´ì•ˆ', count: 115 },
                { word: 'ë¸”ë¡ì²´ì¸', count: 110 },
                { word: 'ê°œë°œ', count: 105 },
                { word: 'í”„ë¡ íŠ¸ì—”ë“œ', count: 100 },
                { word: 'ë°±ì—”ë“œ', count: 95 },
                { word: 'React', count: 90 },
                { word: 'Vue', count: 85 },
                { word: 'Next.js', count: 82 },
                { word: 'TypeScript', count: 80 },
                { word: 'JavaScript', count: 78 },
                { word: 'Python', count: 76 },
                { word: 'Java', count: 74 },
                { word: 'Kotlin', count: 72 },
                { word: 'Swift', count: 70 },
                { word: 'Go', count: 68 },
                { word: 'Rust', count: 66 },
                { word: 'ë°ì´í„°ë² ì´ìŠ¤', count: 65 },
                { word: 'MongoDB', count: 63 },
                { word: 'PostgreSQL', count: 61 },
                { word: 'Redis', count: 59 },
                { word: 'API', count: 57 },
                { word: 'REST', count: 55 },
                { word: 'GraphQL', count: 53 },
                { word: 'ë§ˆì´í¬ë¡œì„œë¹„ìŠ¤', count: 51 },
                { word: 'ì»¨í…Œì´ë„ˆ', count: 50 },
                { word: 'Docker', count: 48 },
                { word: 'Kubernetes', count: 46 },
                { word: 'DevOps', count: 45 },
                { word: 'CI/CD', count: 43 },
                { word: 'Git', count: 41 },
                { word: 'GitHub', count: 40 },
                { word: 'ëª¨ë‹ˆí„°ë§', count: 38 },
                { word: 'ë¡œê¹…', count: 36 },
                { word: 'ì„±ëŠ¥ìµœì í™”', count: 35 },
                { word: 'ì‚¬ìš©ìê²½í—˜', count: 34 },
                { word: 'UX/UI', count: 33 },
                { word: 'ë””ìì¸ì‹œìŠ¤í…œ', count: 32 },
                { word: 'ë°˜ì‘í˜•', count: 31 },
                { word: 'ì ‘ê·¼ì„±', count: 30 },
                { word: 'SEO', count: 29 },
                { word: 'í…ŒìŠ¤íŠ¸', count: 28 },
                { word: 'Jest', count: 27 },
                { word: 'ë°°í¬', count: 26 },
                { word: 'ìë™í™”', count: 25 },
                { word: 'ìŠ¤ì¼€ì¼ë§', count: 24 },
                { word: 'ë¡œë“œë°¸ëŸ°ì‹±', count: 23 },
                { word: 'ìºì‹±', count: 22 },
                { word: 'ë¹„ë™ê¸°', count: 21 },
                { word: 'ì›¹ì†Œì¼“', count: 20 },
                { word: 'gRPC', count: 19 },
                { word: 'ì„œë²„ë¦¬ìŠ¤', count: 18 },
                { word: 'Lambda', count: 17 },
                { word: 'Firebase', count: 16 },
                { word: 'Supabase', count: 15 },
                { word: 'Vercel', count: 14 },
                { word: 'Netlify', count: 13 },
                { word: 'Tailwind', count: 12 },
                { word: 'Styled', count: 11 },
                { word: 'Sass', count: 10 },
                { word: 'Webpack', count: 9 },
                { word: 'Vite', count: 8 },
                { word: 'ESLint', count: 7 },
                { word: 'Prettier', count: 6 },
                { word: 'Agile', count: 5 },
                { word: 'Scrum', count: 4 }
            ],
            trends: [
                { keyword: 'AI', mentions: 25, change: 25.5, category: 'ê¸°ìˆ ' },
                { keyword: 'ë¨¸ì‹ ëŸ¬ë‹', mentions: 18, change: 18.3, category: 'ê¸°ìˆ ' },
                { keyword: 'ChatGPT', mentions: 45, change: 45.2, category: 'íŠ¸ë Œë“œ' },
                { keyword: 'í´ë¼ìš°ë“œ', mentions: 12, change: 12.7, category: 'ì¸í”„ë¼' },
                { keyword: 'ë³´ì•ˆ', mentions: 8, change: 8.4, category: 'ë³´ì•ˆ' }
            ]
        };

        updateStatsCards(dummyData);  // í†µê³„ ì¹´ë“œ ì¶”ê°€
        updateTrendsSummary(dummyData);
        updateKeywordsCloud(dummyData);
        updateWordcloud(dummyData);
        updateTimelineChart(dummyData);
        updateTrendsTable(dummyData);
    }
    
    // í†µê³„ ì¹´ë“œ ì—…ë°ì´íŠ¸ í•¨ìˆ˜ (â­ ì‹¤ì œ ë°ì´í„° ì‚¬ìš©!)
    function updateStatsCards(data) {
        // â­ ì´ ê²Œì‹œê¸€ = ì‹¤ì œ ê²Œì‹œê¸€ ìˆ˜ (ì‹¤ì œ ë°ì´í„°!)
        const totalPosts = data.summary?.total_posts || 0;
        document.getElementById('totalPosts').textContent = totalPosts.toLocaleString();
        
        // â­ ì´ ëŒ“ê¸€ = ì‹¤ì œ ëŒ“ê¸€ ìˆ˜ (ì‹¤ì œ ë°ì´í„°!)
        const totalComments = data.summary?.total_comments || 0;
        document.getElementById('totalComments').textContent = totalComments.toLocaleString();
        
        // â­ ì¶”ì¶œëœ í‚¤ì›Œë“œ = ê³ ìœ  í‚¤ì›Œë“œ ìˆ˜ (ì‹¤ì œ ë°ì´í„°!)
        const uniqueKeywords = data.summary?.unique_keywords || 0;
        document.getElementById('totalKeywords').textContent = uniqueKeywords.toLocaleString();
        
        // â­ 1ìœ„ ì¸ê¸° í‚¤ì›Œë“œ (ì‹¤ì œ ë°ì´í„°!)
        const topKeyword = data.keywords && data.keywords.length > 0 
            ? data.keywords[0].word 
            : '-';
        document.getElementById('topKeyword').textContent = topKeyword;
        
        console.log('âœ… í†µê³„ ì¹´ë“œ ì—…ë°ì´íŠ¸ ì™„ë£Œ (ì‹¤ì œ ë°ì´í„°):', {
            totalPosts,
            totalComments,
            uniqueKeywords,
            topKeyword
        });
    }
    
    // íƒ€ì„ë¼ì¸ ì°¨íŠ¸ ë Œë”ë§ í•¨ìˆ˜ (â­ ì‹¤ì œ ë°ì´í„° ì‚¬ìš©!)
    function updateTimelineChart(data) {
        const canvas = document.getElementById('timelineChart');
        
        if (!canvas) {
            console.error('íƒ€ì„ë¼ì¸ ì°¨íŠ¸ ìº”ë²„ìŠ¤ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
            return;
        }
        
        const ctx = canvas.getContext('2d');
        
        // ê¸°ì¡´ ì°¨íŠ¸ ì œê±°
        if (timelineChart) {
            timelineChart.destroy();
        }
        
        // â­ ì‹¤ì œ íƒ€ì„ë¼ì¸ ë°ì´í„° ì‚¬ìš©!
        let datasets;
        if (data.timeline && data.timeline.length > 0) {
            datasets = [{
                label: 'ì´ ê²€ìƒ‰ íšŸìˆ˜',
                data: data.timeline.map(item => ({
                    x: item.date,
                    y: item.count
                })),
                borderColor: '#4F46E5',
                backgroundColor: 'rgba(79, 70, 229, 0.1)',
                borderWidth: 3,
                fill: true,
                tension: 0.3,
                pointRadius: 5,
                pointHoverRadius: 7
            }];
            console.log('âœ… íƒ€ì„ë¼ì¸ ì°¨íŠ¸ ë°ì´í„°:', data.timeline.length + 'ê°œ í¬ì¸íŠ¸');
        } else {
            // ë°ì´í„°ê°€ ì—†ì„ ê²½ìš° ë©”ì‹œì§€ í‘œì‹œ
            console.log('âš ï¸ íƒ€ì„ë¼ì¸ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
            datasets = [{
                label: 'ê²€ìƒ‰ íšŸìˆ˜',
                data: [],
                borderColor: '#4F46E5',
                backgroundColor: 'rgba(79, 70, 229, 0.1)',
            }];
        }
        
        // Chart.js ì„¤ì •
        timelineChart = new Chart(ctx, {
            type: 'line',
            data: { datasets },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                interaction: {
                    mode: 'index',
                    intersect: false
                },
                plugins: {
                    legend: {
                        position: 'top',
                        labels: {
                            usePointStyle: true,
                            padding: 15,
                            font: {
                                size: 12
                            }
                        }
                    },
                    tooltip: {
                        backgroundColor: 'rgba(0, 0, 0, 0.8)',
                        padding: 12,
                        titleFont: {
                            size: 14
                        },
                        bodyFont: {
                            size: 13
                        },
                        callbacks: {
                            label: function(context) {
                                return context.dataset.label + ': ' + context.parsed.y.toLocaleString() + 'íšŒ';
                            }
                        }
                    }
                },
                scales: {
                    x: {
                        type: 'time',
                        time: {
                            unit: 'day',
                            displayFormats: {
                                day: 'MM/dd'
                            }
                        },
                        title: {
                            display: true,
                            text: 'ë‚ ì§œ',
                            font: {
                                size: 12
                            }
                        },
                        grid: {
                            color: 'rgba(0, 0, 0, 0.05)'
                        }
                    },
                    y: {
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: 'ì–¸ê¸‰ íšŸìˆ˜',
                            font: {
                                size: 12
                            }
                        },
                        grid: {
                            color: 'rgba(0, 0, 0, 0.05)'
                        },
                        ticks: {
                            callback: function(value) {
                                return value.toLocaleString();
                            }
                        }
                    }
                }
            }
        });
        
        console.log('âœ… íƒ€ì„ë¼ì¸ ì°¨íŠ¸ ë Œë”ë§ ì™„ë£Œ!');
    }
    
    // ì°¨íŠ¸ ìƒ‰ìƒ í—¬í¼ í•¨ìˆ˜
    function getChartColor(index, alpha = 1) {
        const colors = [
            `rgba(79, 70, 229, ${alpha})`,   // ë³´ë¼
            `rgba(16, 185, 129, ${alpha})`,  // ì´ˆë¡
            `rgba(245, 158, 11, ${alpha})`,  // ì£¼í™©
            `rgba(239, 68, 68, ${alpha})`,   // ë¹¨ê°•
            `rgba(59, 130, 246, ${alpha})`,  // íŒŒë‘
            `rgba(139, 92, 246, ${alpha})`,  // ë³´ë¼2
            `rgba(236, 72, 153, ${alpha})`,  // ë¶„í™
            `rgba(20, 184, 166, ${alpha})`   // ì²­ë¡
        ];
        return colors[index % colors.length];
    }

    function updateTrendsSummary(data) {
        const summaryDiv = document.getElementById('trendsSummary');
        
        if (!data || !data.summary) {
            summaryDiv.innerHTML = '<p>ìš”ì•½ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
            return;
        }

        const summary = data.summary;
        summaryDiv.innerHTML = `
            <div class="summary-grid">
                <div class="summary-item">
                    <span class="summary-label">ì´ íŠ¸ë Œë“œ</span>
                    <span class="summary-value">${summary.total_trends || 0}</span>
                </div>
                <div class="summary-item">
                    <span class="summary-label">ì‹ ê·œ íŠ¸ë Œë“œ</span>
                    <span class="summary-value">${summary.new_trends || 0}</span>
                </div>
                <div class="summary-item">
                    <span class="summary-label">ìƒìŠ¹ íŠ¸ë Œë“œ</span>
                    <span class="summary-value">${summary.rising_trends || 0}</span>
                </div>
            </div>
        `;
    }

    function updateKeywordsCloud(data) {
        const cloudDiv = document.getElementById('keywordsCloud');
        
        if (!data || !data.keywords || data.keywords.length === 0) {
            cloudDiv.innerHTML = '<p>í‚¤ì›Œë“œ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
            return;
        }

        // ìƒìœ„ 15ê°œë§Œ í‘œì‹œí•˜ê³  í¬ê¸°ë¥¼ í›¨ì”¬ ì‘ê²Œ
        const topKeywords = data.keywords.slice(0, 15);
        cloudDiv.innerHTML = topKeywords.map(keyword => {
            // í¬ê¸°ë¥¼ ë§¤ìš° ì‘ê²Œ ì¡°ì • (0.65rem ~ 0.85rem)
            const size = Math.min(Math.max(keyword.count / 250, 0.65), 0.85);
            return `<span class="keyword-tag" style="font-size: ${size}rem; padding: 0.25rem 0.5rem;">${keyword.word}</span>`;
        }).join('');
    }

    function updateWordcloud(data, shape = currentShape) {
        const container = document.getElementById('wordcloudCanvas');
        
        if (!container) {
            console.error('âŒ ì›Œë“œí´ë¼ìš°ë“œ ì»¨í…Œì´ë„ˆë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
            return;
        }
        
        // ê¸°ì¡´ ì›Œë“œí´ë¼ìš°ë“œ ì´ˆê¸°í™”
        container.innerHTML = '';
        
        // ë°ì´í„° ê²€ì¦
        console.log('ğŸ“Š ì›Œë“œí´ë¼ìš°ë“œ ë°ì´í„° í™•ì¸:', {
            hasData: !!data,
            hasKeywords: !!(data && data.keywords),
            keywordCount: data && data.keywords ? data.keywords.length : 0,
            firstKeyword: data && data.keywords && data.keywords[0]
        });
        
        if (!data || !data.keywords || data.keywords.length === 0) {
            container.innerHTML = '<p class="loading">âš ï¸ í‚¤ì›Œë“œ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
            console.warn('âš ï¸ í‚¤ì›Œë“œ ë°ì´í„° ì—†ìŒ');
            return;
        }

        // WordCloud.js í˜•ì‹ìœ¼ë¡œ ë°ì´í„° ë³€í™˜
        // [ë‹¨ì–´, ë¹ˆë„ìˆ˜] í˜•ì‹ì˜ ë°°ì—´ë¡œ ë³€í™˜
        const wordcloudData = data.keywords.map(keyword => {
            return [keyword.word, keyword.count || keyword.frequency || 1];
        });
        
        console.log('âœ… ì›Œë“œí´ë¼ìš°ë“œ ë°ì´í„° ë³€í™˜ ì™„ë£Œ:', wordcloudData.slice(0, 5));
        
        // í˜„ì¬ ë°ì´í„° ì €ì¥
        currentWordcloudData = wordcloudData;
        currentShape = shape;

        try {
            // WordCloud2 ë Œë”ë§ (ì „ì—­ í•¨ìˆ˜ëª… í™•ì¸)
            // wordcloud2.jsëŠ” ì „ì—­ì— WordCloud í•¨ìˆ˜ë¥¼ ë“±ë¡í•©ë‹ˆë‹¤
            if (typeof WordCloud === 'undefined') {
                throw new Error('WordCloud ë¼ì´ë¸ŒëŸ¬ë¦¬ê°€ ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
            }
            
            WordCloud(container, {
                list: wordcloudData.slice(0, 50),  // ìƒìœ„ 50ê°œë§Œ ì‚¬ìš©
                // ê¸€ì í¬ê¸° ì¡°ì • - ê°€ë…ì„± í™•ë³´
                gridSize: 8,  // ê°„ê²© ì¢ê²Œ (ë” ë§ì´ í‘œì‹œ)
                weightFactor: 3,  // ê¸€ì í¬ê¸° ì ë‹¹í•˜ê²Œ (ë³´ì´ë„ë¡ ì¡°ì •)
                fontFamily: 'Pretendard, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif',
                fontWeight: '600',
                color: function(word, weight, fontSize) {
                    // í° ê¸€ì”¨(ë¹ˆë„ìˆ˜ ë†’ìŒ): ì§„í•œ íŒŒë€ìƒ‰, ì‘ì€ ê¸€ì”¨: ë°ì€ íŒŒë€ìƒ‰
                    return fontSize > 20 ? '#2563eb' : '#3b82f6';
                },
                backgroundColor: 'transparent',
                // ëª¨ì–‘ ì„¤ì • (circleì´ ê°€ì¥ ë§ì´ í‘œì‹œë¨)
                shape: 'circle',  // circleì´ ê°€ì¥ íš¨ìœ¨ì 
                rotateRatio: 0.5,
                rotationSteps: 2,
                drawOutOfBound: false,
                shrinkToFit: true,
                clearCanvas: true,
                wait: 0
            });
            
            console.log('ì›Œë“œí´ë¼ìš°ë“œ ë Œë”ë§ ì™„ë£Œ:', wordcloudData.length, 'ê°œ ë‹¨ì–´', '(ëª¨ì–‘:', shape + ')');
        } catch (error) {
            console.error('ì›Œë“œí´ë¼ìš°ë“œ ë Œë”ë§ ì‹¤íŒ¨:', error);
            container.innerHTML = '<p class="loading">ì›Œë“œí´ë¼ìš°ë“œë¥¼ í‘œì‹œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p>';
        }
    }
    
    // ì›Œë“œí´ë¼ìš°ë“œ ëª¨ì–‘ ë³€ê²½ í•¨ìˆ˜
    function changeWordcloudShape(shape) {
        if (!currentWordcloudData) {
            console.warn('ì›Œë“œí´ë¼ìš°ë“œ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
            return;
        }
        
        // í™œì„± ë²„íŠ¼ í‘œì‹œ
        document.querySelectorAll('.shape-btn').forEach(btn => btn.classList.remove('active'));
        event.target.classList.add('active');
        
        // ì›Œë“œí´ë¼ìš°ë“œ ë‹¤ì‹œ ë Œë”ë§
        const container = document.getElementById('wordcloudCanvas');
        container.innerHTML = '';
        
        try {
            if (typeof WordCloud === 'undefined') {
                throw new Error('WordCloud ë¼ì´ë¸ŒëŸ¬ë¦¬ê°€ ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
            }
            
            WordCloud(container, {
                list: currentWordcloudData.slice(0, 50),  // ìƒìœ„ 50ê°œë§Œ
                gridSize: 16,  // ê°„ê²© ë” ë„“ê²Œ
                weightFactor: 0.05,  // ê¸€ì í¬ê¸° ê·¹ì†Œ (ì‚¬ìš©ì ìš”ì²­: 0.35 â†’ 0.05)
                fontFamily: 'Pretendard, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif',
                fontWeight: '400',
                color: function(word, weight, fontSize) {
                    // í° ê¸€ì”¨(ë¹ˆë„ìˆ˜ ë†’ìŒ): ì§„í•œ íŒŒë€ìƒ‰, ì‘ì€ ê¸€ì”¨: ë°ì€ íŒŒë€ìƒ‰
                    return fontSize > 20 ? '#2563eb' : '#3b82f6';
                },
                backgroundColor: 'transparent',
                shape: shape,
                ellipticity: 0.7,  // í•˜íŠ¸ ì„¸ë¡œ ë¹„ìœ¨
                rotateRatio: 0.3,
                rotationSteps: 2,
                minSize: 4,
                maxSize: 18,
                drawOutOfBound: false,
                shrinkToFit: true,
                clearCanvas: true,
                wait: 0
            });
            
            currentShape = shape;
            console.log('ì›Œë“œí´ë¼ìš°ë“œ ëª¨ì–‘ ë³€ê²½:', shape);
        } catch (error) {
            console.error('ì›Œë“œí´ë¼ìš°ë“œ ë Œë”ë§ ì‹¤íŒ¨:', error);
            container.innerHTML = '<p class="loading">ì›Œë“œí´ë¼ìš°ë“œë¥¼ í‘œì‹œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p>';
        }
    }

    function updateTrendsTable(data) {
        const tbody = document.getElementById('trendsTableBody');
        
        console.log('ğŸ“Š ìƒì„¸ íŠ¸ë Œë“œ í…Œì´ë¸” ì—…ë°ì´íŠ¸:', {
            hasData: !!data,
            hasTrends: !!(data && data.trends),
            trendsCount: data && data.trends ? data.trends.length : 0,
            firstTrend: data && data.trends && data.trends[0]
        });
        
        if (!data || !data.trends || data.trends.length === 0) {
            tbody.innerHTML = '<tr><td colspan="5">âš ï¸ íŠ¸ë Œë“œ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
            console.warn('âš ï¸ íŠ¸ë Œë“œ ë°ì´í„° ì—†ìŒ');
            return;
        }

        tbody.innerHTML = data.trends.map((trend, index) => `
            <tr>
                <td>${index + 1}</td>
                <td><strong>${trend.keyword || 'N/A'}</strong></td>
                <td>${(trend.mentions || 0).toLocaleString()}</td>
                <td class="${trend.change >= 0 ? 'positive' : 'negative'}">
                    ${trend.change >= 0 ? 'â–²' : 'â–¼'} ${Math.abs(trend.change || 0).toFixed(1)}%
                </td>
                <td>${trend.category || 'N/A'}</td>
            </tr>
        `).join('');
        
        console.log('âœ… ìƒì„¸ íŠ¸ë Œë“œ í…Œì´ë¸” ì—…ë°ì´íŠ¸ ì™„ë£Œ!', data.trends.length + 'ê°œ í•­ëª©');
    }

    // í•„í„° ì´ˆê¸°í™” í•¨ìˆ˜
    function initializeFilters() {
        // ê¸°ë³¸ ë‚ ì§œ ì„¤ì • (ìµœê·¼ 7ì¼)
        const now = new Date();
        const weekAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
        
        document.getElementById('startDate').value = weekAgo.toISOString().slice(0, 16);
        document.getElementById('endDate').value = now.toISOString().slice(0, 16);
        
        // ì»¤ë®¤ë‹ˆí‹° ëª©ë¡ ë¡œë“œ (ë”ë¯¸ ë°ì´í„°)
        loadCommunityOptions();
    }
    
    // ì»¤ë®¤ë‹ˆí‹° ì˜µì…˜ ë¡œë“œ
    function loadCommunityOptions() {
        const communitySelect = document.getElementById('communityFilter');
        const dummyCommunities = [
            'í…Œí¬ ì»¤ë®¤ë‹ˆí‹°',
            'ê°œë°œì í¬ëŸ¼',
            'AI ì—°êµ¬ì†Œ',
            'í´ë¼ìš°ë“œ ì‚¬ìš©ì ëª¨ì„',
            'ì˜¤í”ˆì†ŒìŠ¤ ì»¤ë®¤ë‹ˆí‹°'
        ];
        
        communitySelect.innerHTML = '<option value="">ì „ì²´</option>' + 
            dummyCommunities.map(name => `<option value="${name}">${name}</option>`).join('');
    }
    
    // í•„í„° ì ìš©
    async function applyFilters() {
        const startDate = document.getElementById('startDate').value;
        const endDate = document.getElementById('endDate').value;
        const community = document.getElementById('communityFilter').value;
        const board = document.getElementById('boardFilter').value;
        const keywords = document.getElementById('keywordsFilter').value;
        const granularity = document.getElementById('granularity').value;
        
        console.log('í•„í„° ì ìš©:', {
            startDate,
            endDate,
            community,
            board,
            keywords,
            granularity
        });
        
        // âœ… ì‹¤ì œ API í˜¸ì¶œ (í•„í„° ì ìš© ì‹œì—ë„ ì‹¤ì œ ë°ì´í„° ì‚¬ìš©)
        try {
            const data = await apiRequest('/api/trends');
            
            // ë°ì´í„° ì—…ë°ì´íŠ¸
            updateStatsCards(data);        // â­ í†µê³„ ì¹´ë“œ ì—…ë°ì´íŠ¸
            updateTrendsSummary(data);
            updateKeywordsCloud(data);
            updateWordcloud(data);
            updateTimelineChart(data);     // â­ íƒ€ì„ë¼ì¸ ì°¨íŠ¸ ì—…ë°ì´íŠ¸
            updateTrendsTable(data);
            
            console.log('âœ… í•„í„° ì ìš©ëœ ì‹¤ì œ ë°ì´í„° ë¡œë“œ ì„±ê³µ! source:', data.source);
            
            // ì‚¬ìš©ì í”¼ë“œë°±
            showFilterAppliedMessage();
        } catch (error) {
            console.error('âŒ í•„í„° ì ìš© ì‹¤íŒ¨:', error);
            alert('í•„í„°ë¥¼ ì ìš©í•˜ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        }
    }
    
    // í•„í„° ì´ˆê¸°í™”
    function resetFilters() {
        document.getElementById('startDate').value = '';
        document.getElementById('endDate').value = '';
        document.getElementById('communityFilter').value = '';
        document.getElementById('boardFilter').value = '';
        document.getElementById('keywordsFilter').value = '';
        document.getElementById('granularity').value = '1d';
        
        initializeFilters();
        loadDummyData();
        
        console.log('í•„í„° ì´ˆê¸°í™” ì™„ë£Œ');
    }
    
    // í•„í„° ì ìš© ë©”ì‹œì§€
    function showFilterAppliedMessage() {
        const startDate = document.getElementById('startDate').value;
        const endDate = document.getElementById('endDate').value;
        
        let message = 'í•„í„°ê°€ ì ìš©ë˜ì—ˆìŠµë‹ˆë‹¤';
        if (startDate && endDate) {
            const start = new Date(startDate);
            const end = new Date(endDate);
            const days = Math.round((end - start) / (1000 * 60 * 60 * 24));
            message += ` (${days}ì¼ê°„ ë°ì´í„°)`;
        }
        
        console.log(message);
    }
    
    // í˜ì´ì§€ ë¡œë“œ ì‹œ í•„í„° ì´ˆê¸°í™”
    initializeFilters();
    loadTrendsData();
</script>
{% endblock %}

