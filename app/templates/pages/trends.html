{% extends "base.html" %}

{% block title %}트렌드 분석 - Community Admin{% endblock %}

{% block extra_css %}
<!-- Font Awesome CDN -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

<style>
    /* 워드클라우드 컨테이너 */
    .wordcloud-section {
        background: white;
        padding: 2rem;
        border-radius: 0.5rem;
        box-shadow: var(--shadow);
        margin-bottom: 2rem;
    }
    
    .wordcloud-section h3 {
        margin-bottom: 1rem;
        color: var(--text-color);
    }
    
    .wordcloud-container {
        min-height: 300px;
        max-height: 300px;
        background: var(--bg-color);
        border-radius: 0.5rem;
        padding: 2rem;
        display: flex;
        align-items: center;
        justify-content: center;
        position: relative;
        overflow: hidden;
    }
    
    #wordcloudCanvas {
        width: 100%;
        max-width: 1000px;
        height: 300px;
        margin: 0 auto;
    }
    
    /* 키워드 클라우드 개선 */
    .keywords-section {
        background: white;
        padding: 1.5rem;
        border-radius: 0.5rem;
        box-shadow: var(--shadow);
        margin-bottom: 2rem;
    }
    
    .keywords-section h3 {
        margin-bottom: 1rem;
    }
    
    /* 모양 선택 버튼 */
    .shape-btn {
        padding: 0.5rem 0.75rem;
        background: white;
        border: 2px solid var(--border-color);
        border-radius: 0.375rem;
        cursor: pointer;
        font-size: 1.2rem;
        transition: all 0.2s;
    }
    
    .shape-btn:hover {
        background: var(--primary-color);
        border-color: var(--primary-color);
        transform: scale(1.1);
    }
    
    .shape-btn.active {
        background: var(--primary-color);
        border-color: var(--primary-color);
        box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.2);
    }
    
    /* 필터 섹션 */
    .filter-section {
        background: white;
        padding: 1.5rem;
        border-radius: 0.5rem;
        box-shadow: var(--shadow);
        margin-bottom: 2rem;
    }
    
    .filter-grid {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 1rem;
    }
    
    .filter-item {
        display: flex;
        flex-direction: column;
    }
    
    .filter-item label {
        margin-bottom: 0.5rem;
        font-weight: 500;
        font-size: 0.875rem;
        color: var(--text-color);
    }
    
    .filter-item-wide {
        grid-column: span 2;
    }
    
    .filter-item-button {
        display: flex;
        flex-direction: column;
        justify-content: flex-end;
    }
    
    .btn-reset {
        padding: 0.5rem 1rem;
        background: white;
        border: 1px solid var(--border-color);
        border-radius: 0.375rem;
        cursor: pointer;
        font-size: 0.875rem;
        transition: all 0.2s;
        color: var(--text-color);
    }
    
    .btn-reset:hover {
        background: var(--bg-color);
        border-color: var(--primary-color);
    }
    
    @media (max-width: 1024px) {
        .filter-grid {
            grid-template-columns: repeat(2, 1fr);
        }
        .filter-item-wide {
            grid-column: span 2;
        }
    }
    
    @media (max-width: 768px) {
        .filter-grid {
            grid-template-columns: 1fr;
        }
        .filter-item-wide {
            grid-column: span 1;
        }
    }
    
    /* 타임라인 차트 섹션 */
    .timeline-chart-section {
        background: white;
        padding: 1.5rem;
        border-radius: 0.5rem;
        box-shadow: var(--shadow);
        margin-bottom: 2rem;
    }
    
    .chart-container {
        position: relative;
        height: 400px;
        padding: 1rem;
        background: var(--bg-color);
        border-radius: 0.5rem;
    }
    
    .chart-container canvas {
        max-height: 100%;
    }
    
    /* 통계 카드 그리드 */
    .stats-cards-grid {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 1.5rem;
        margin-bottom: 2rem;
    }
    
    .stats-card {
        background: white;
        padding: 1.5rem;
        border-radius: 0.5rem;
        box-shadow: var(--shadow);
        display: flex;
        align-items: center;
        gap: 1rem;
        transition: transform 0.2s, box-shadow 0.2s;
    }
    
    .stats-card:hover {
        transform: translateY(-2px);
        box-shadow: var(--shadow-lg);
    }
    
    .stats-card-icon {
        width: 60px;
        height: 60px;
        border-radius: 0.5rem;
        display: flex;
        align-items: center;
        justify-content: center;
        background: linear-gradient(135deg, var(--primary-color) 0%, #6366F1 100%);
        color: white;
        font-size: 1.5rem;
        flex-shrink: 0;
    }
    
    .stats-icon-success {
        background: linear-gradient(135deg, var(--secondary-color) 0%, #059669 100%);
    }
    
    .stats-icon-warning {
        background: linear-gradient(135deg, var(--warning-color) 0%, #D97706 100%);
    }
    
    .stats-icon-danger {
        background: linear-gradient(135deg, var(--danger-color) 0%, #DC2626 100%);
    }
    
    .stats-card-content {
        flex: 1;
        min-width: 0;
    }
    
    .stats-card-label {
        font-size: 0.875rem;
        color: var(--text-light);
        margin-bottom: 0.5rem;
        font-weight: 500;
    }
    
    .stats-card-value {
        font-size: 2rem;
        font-weight: 700;
        color: var(--text-color);
        line-height: 1;
    }
    
    .stats-card-keyword {
        font-size: 1.5rem;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }
    
    @media (max-width: 1200px) {
        .stats-cards-grid {
            grid-template-columns: repeat(2, 1fr);
        }
    }
    
    @media (max-width: 768px) {
        .stats-cards-grid {
            grid-template-columns: 1fr;
        }
        
        .stats-card-value {
            font-size: 1.5rem;
        }
    }
    
    /* 트렌드 요약 섹션 */
    .trends-summary {
        background: white;
        padding: 1.5rem;
        border-radius: 0.5rem;
        box-shadow: var(--shadow);
        margin-bottom: 2rem;
    }
    
    .trends-summary h3 {
        margin-bottom: 1rem;
    }
    
    .summary-grid {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 1rem;
    }
    
    .summary-item {
        display: flex;
        flex-direction: column;
        padding: 1rem;
        background: var(--bg-color);
        border-radius: 0.375rem;
    }
    
    .summary-label {
        font-size: 0.875rem;
        color: var(--text-light);
        margin-bottom: 0.5rem;
    }
    
    .summary-value {
        font-size: 1.5rem;
        font-weight: 700;
        color: var(--primary-color);
    }
    
    @media (max-width: 768px) {
        .summary-grid {
            grid-template-columns: 1fr;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="page-header">
    <h1>트렌드 대시보드</h1>
    <p>주요 트렌드 및 키워드 분석</p>
</div>

<div class="dashboard-container">
    <!-- 통계 카드 그리드 -->
    <div class="stats-cards-grid">
        <div class="stats-card">
            <div class="stats-card-icon">
                <i class="fas fa-file-alt"></i>
            </div>
            <div class="stats-card-content">
                <div class="stats-card-label">총 게시글</div>
                <div class="stats-card-value" id="totalPosts">-</div>
            </div>
        </div>
        
        <div class="stats-card">
            <div class="stats-card-icon stats-icon-success">
                <i class="fas fa-comments"></i>
            </div>
            <div class="stats-card-content">
                <div class="stats-card-label">총 댓글</div>
                <div class="stats-card-value" id="totalComments">-</div>
            </div>
        </div>
        
        <div class="stats-card">
            <div class="stats-card-icon stats-icon-warning">
                <i class="fas fa-tags"></i>
            </div>
            <div class="stats-card-content">
                <div class="stats-card-label">추출된 키워드</div>
                <div class="stats-card-value" id="totalKeywords">-</div>
            </div>
        </div>
        
        <div class="stats-card">
            <div class="stats-card-icon stats-icon-danger">
                <i class="fas fa-fire"></i>
            </div>
            <div class="stats-card-content">
                <div class="stats-card-label">인기 키워드</div>
                <div class="stats-card-value stats-card-keyword" id="topKeyword">-</div>
            </div>
        </div>
    </div>

    <!-- 필터 섹션 -->
    <div class="filter-section" style="display: none;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
            <h3 style="margin: 0;">🔍 분석 필터</h3>
            <button onclick="resetFilters()" class="btn-reset" title="필터 초기화">
                🔄 초기화
            </button>
        </div>
        
        <div class="filter-grid">
            <!-- 날짜 필터 -->
            <div class="filter-item">
                <label for="startDate">시작 날짜</label>
                <input type="datetime-local" id="startDate" class="form-control">
            </div>
            
            <div class="filter-item">
                <label for="endDate">종료 날짜</label>
                <input type="datetime-local" id="endDate" class="form-control">
            </div>
            
            <!-- 커뮤니티/게시판 필터 -->
            <div class="filter-item">
                <label for="communityFilter">커뮤니티</label>
                <select id="communityFilter" class="form-control">
                    <option value="">전체</option>
                </select>
            </div>
            
            <div class="filter-item">
                <label for="boardFilter">게시판</label>
                <select id="boardFilter" class="form-control">
                    <option value="">전체</option>
                </select>
            </div>
            
            <!-- 키워드 필터 -->
            <div class="filter-item filter-item-wide">
                <label for="keywordsFilter">키워드 (쉼표로 구분)</label>
                <input type="text" id="keywordsFilter" class="form-control" placeholder="예: AI, 머신러닝, 클라우드">
            </div>
            
            <!-- 집계 단위 -->
            <div class="filter-item">
                <label for="granularity">집계 단위</label>
                <select id="granularity" class="form-control">
                    <option value="1h">1시간</option>
                    <option value="1d" selected>1일</option>
                    <option value="1w">1주</option>
                </select>
            </div>
            
            <!-- 적용 버튼 -->
            <div class="filter-item filter-item-button">
                <label>&nbsp;</label>
                <button onclick="applyFilters()" class="btn btn-primary" style="width: 100%;">
                    🔎 필터 적용
                </button>
            </div>
        </div>
    </div>

    <!-- 트렌드 요약 (추가) -->
    <div class="trends-summary">
        <h3>트렌드 요약</h3>
        <div id="trendsSummary" class="loading">데이터 로딩 중...</div>
    </div>

    <!-- 워드클라우드 섹션 -->
    <div class="wordcloud-section">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
            <h3 style="margin: 0;">🌐 워드클라우드</h3>
            <div style="display: flex; gap: 0.5rem;">
            </div>
        </div>
        <div class="wordcloud-container">
            <div id="wordcloudCanvas"></div>
        </div>
    </div>

    <div class="keywords-section">
        <h3>인기 키워드</h3>
        <div id="keywordsCloud" class="keywords-cloud"></div>
    </div>

    <!-- 키워드 타임라인 차트 -->
    <div class="timeline-chart-section">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
            <h3 style="margin: 0;">📈 키워드 타임라인</h3>
            <div style="font-size: 0.875rem; color: var(--text-light);">
                상위 5개 키워드의 시간별 추이
            </div>
        </div>
        <div class="chart-container">
            <canvas id="timelineChart" height="100"></canvas>
        </div>
    </div>

    <div class="trends-table">
        <h3>상세 트렌드</h3>
        <table id="trendsTable">
            <thead>
                <tr>
                    <th>순위</th>
                    <th>키워드</th>
                    <th>언급 수</th>
                    <th>증감률</th>
                    <th>카테고리</th>
                </tr>
            </thead>
            <tbody id="trendsTableBody">
                <tr><td colspan="5" class="loading">데이터 로딩 중...</td></tr>
            </tbody>
        </table>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- WordCloud.js CDN -->
<script src="https://cdn.jsdelivr.net/npm/wordcloud@1.2.2/src/wordcloud2.js"></script>

<!-- Chart.js CDN -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3.0.0/dist/chartjs-adapter-date-fns.bundle.min.js"></script>

<script>
    let wordcloudInstance = null;
    let currentWordcloudData = null;
    let currentShape = 'cardioid';  // 기본값을 하트 모양으로!
    let timelineChart = null;

    async function loadTrendsData() {
        console.log('🔄 트렌드 데이터 로딩 시작...');
        
        // ✅ 실제 API에서 데이터 가져오기 (dad.dothome.co.kr 연동)
        try {
            const data = await apiRequest('/api/trends');
            console.log('📦 API 응답 받음:', data);
            
            // 각 업데이트 함수를 개별적으로 try-catch
            try {
                updateStatsCards(data);
            } catch (err) {
                console.error('❌ Stats Cards 업데이트 실패:', err);
            }
            
            try {
            updateTrendsSummary(data);
            } catch (err) {
                console.error('❌ Trends Summary 업데이트 실패:', err);
            }
            
            try {
            updateKeywordsCloud(data);
            } catch (err) {
                console.error('❌ Keywords Cloud 업데이트 실패:', err);
            }
            
            try {
                updateWordcloud(data);
            } catch (err) {
                console.error('❌ Wordcloud 업데이트 실패:', err);
            }
            
            try {
                updateTimelineChart(data);
            } catch (err) {
                console.error('❌ Timeline Chart 업데이트 실패:', err);
            }
            
            try {
            updateTrendsTable(data);
            } catch (err) {
                console.error('❌ Trends Table 업데이트 실패:', err);
            }
            
            console.log('✅ 실제 데이터 로드 완료! source:', data.source);
        } catch (error) {
            console.error('❌ API 호출 실패:', error);
            // 에러 시에만 더미 데이터 사용
            loadDummyData();
        }
    }

    // 더미 데이터로 워드클라우드 테스트
    function loadDummyData() {
        console.log('더미 데이터로 워드클라우드를 표시합니다.');
        
        const dummyData = {
            summary: {
                total_trends: 75,
                new_trends: 12,
                rising_trends: 28
            },
            keywords: [
                // 핫한 기술 키워드 (50개 이상)
                { word: 'AI', count: 150 },
                { word: '머신러닝', count: 145 },
                { word: '딥러닝', count: 140 },
                { word: 'ChatGPT', count: 138 },
                { word: '생성AI', count: 135 },
                { word: '데이터분석', count: 130 },
                { word: '클라우드', count: 125 },
                { word: 'AWS', count: 120 },
                { word: '보안', count: 115 },
                { word: '블록체인', count: 110 },
                { word: '개발', count: 105 },
                { word: '프론트엔드', count: 100 },
                { word: '백엔드', count: 95 },
                { word: 'React', count: 90 },
                { word: 'Vue', count: 85 },
                { word: 'Next.js', count: 82 },
                { word: 'TypeScript', count: 80 },
                { word: 'JavaScript', count: 78 },
                { word: 'Python', count: 76 },
                { word: 'Java', count: 74 },
                { word: 'Kotlin', count: 72 },
                { word: 'Swift', count: 70 },
                { word: 'Go', count: 68 },
                { word: 'Rust', count: 66 },
                { word: '데이터베이스', count: 65 },
                { word: 'MongoDB', count: 63 },
                { word: 'PostgreSQL', count: 61 },
                { word: 'Redis', count: 59 },
                { word: 'API', count: 57 },
                { word: 'REST', count: 55 },
                { word: 'GraphQL', count: 53 },
                { word: '마이크로서비스', count: 51 },
                { word: '컨테이너', count: 50 },
                { word: 'Docker', count: 48 },
                { word: 'Kubernetes', count: 46 },
                { word: 'DevOps', count: 45 },
                { word: 'CI/CD', count: 43 },
                { word: 'Git', count: 41 },
                { word: 'GitHub', count: 40 },
                { word: '모니터링', count: 38 },
                { word: '로깅', count: 36 },
                { word: '성능최적화', count: 35 },
                { word: '사용자경험', count: 34 },
                { word: 'UX/UI', count: 33 },
                { word: '디자인시스템', count: 32 },
                { word: '반응형', count: 31 },
                { word: '접근성', count: 30 },
                { word: 'SEO', count: 29 },
                { word: '테스트', count: 28 },
                { word: 'Jest', count: 27 },
                { word: '배포', count: 26 },
                { word: '자동화', count: 25 },
                { word: '스케일링', count: 24 },
                { word: '로드밸런싱', count: 23 },
                { word: '캐싱', count: 22 },
                { word: '비동기', count: 21 },
                { word: '웹소켓', count: 20 },
                { word: 'gRPC', count: 19 },
                { word: '서버리스', count: 18 },
                { word: 'Lambda', count: 17 },
                { word: 'Firebase', count: 16 },
                { word: 'Supabase', count: 15 },
                { word: 'Vercel', count: 14 },
                { word: 'Netlify', count: 13 },
                { word: 'Tailwind', count: 12 },
                { word: 'Styled', count: 11 },
                { word: 'Sass', count: 10 },
                { word: 'Webpack', count: 9 },
                { word: 'Vite', count: 8 },
                { word: 'ESLint', count: 7 },
                { word: 'Prettier', count: 6 },
                { word: 'Agile', count: 5 },
                { word: 'Scrum', count: 4 }
            ],
            trends: [
                { keyword: 'AI', mentions: 25, change: 25.5, category: '기술' },
                { keyword: '머신러닝', mentions: 18, change: 18.3, category: '기술' },
                { keyword: 'ChatGPT', mentions: 45, change: 45.2, category: '트렌드' },
                { keyword: '클라우드', mentions: 12, change: 12.7, category: '인프라' },
                { keyword: '보안', mentions: 8, change: 8.4, category: '보안' }
            ]
        };

        updateStatsCards(dummyData);  // 통계 카드 추가
        updateTrendsSummary(dummyData);
        updateKeywordsCloud(dummyData);
        updateWordcloud(dummyData);
        updateTimelineChart(dummyData);
        updateTrendsTable(dummyData);
    }
    
    // 통계 카드 업데이트 함수 (⭐ 실제 데이터 사용!)
    function updateStatsCards(data) {
        // ⭐ 총 게시글 = 실제 게시글 수 (실제 데이터!)
        const totalPosts = data.summary?.total_posts || 0;
        document.getElementById('totalPosts').textContent = totalPosts.toLocaleString();
        
        // ⭐ 총 댓글 = 실제 댓글 수 (실제 데이터!)
        const totalComments = data.summary?.total_comments || 0;
        document.getElementById('totalComments').textContent = totalComments.toLocaleString();
        
        // ⭐ 추출된 키워드 = 고유 키워드 수 (실제 데이터!)
        const uniqueKeywords = data.summary?.unique_keywords || 0;
        document.getElementById('totalKeywords').textContent = uniqueKeywords.toLocaleString();
        
        // ⭐ 1위 인기 키워드 (실제 데이터!)
        const topKeyword = data.keywords && data.keywords.length > 0 
            ? data.keywords[0].word 
            : '-';
        document.getElementById('topKeyword').textContent = topKeyword;
        
        console.log('✅ 통계 카드 업데이트 완료 (실제 데이터):', {
            totalPosts,
            totalComments,
            uniqueKeywords,
            topKeyword
        });
    }
    
    // 타임라인 차트 렌더링 함수 (⭐ 실제 데이터 사용!)
    function updateTimelineChart(data) {
        const canvas = document.getElementById('timelineChart');
        
        if (!canvas) {
            console.error('타임라인 차트 캔버스를 찾을 수 없습니다.');
            return;
        }
        
        const ctx = canvas.getContext('2d');
        
        // 기존 차트 제거
        if (timelineChart) {
            timelineChart.destroy();
        }
        
        // ⭐ 실제 타임라인 데이터 사용!
        let datasets;
        if (data.timeline && data.timeline.length > 0) {
            datasets = [{
                label: '총 검색 횟수',
                data: data.timeline.map(item => ({
                    x: item.date,
                    y: item.count
                })),
                borderColor: '#4F46E5',
                backgroundColor: 'rgba(79, 70, 229, 0.1)',
                borderWidth: 3,
                fill: true,
                tension: 0.3,
                pointRadius: 5,
                pointHoverRadius: 7
            }];
            console.log('✅ 타임라인 차트 데이터:', data.timeline.length + '개 포인트');
        } else {
            // 데이터가 없을 경우 메시지 표시
            console.log('⚠️ 타임라인 데이터가 없습니다.');
            datasets = [{
                label: '검색 횟수',
                data: [],
                borderColor: '#4F46E5',
                backgroundColor: 'rgba(79, 70, 229, 0.1)',
            }];
        }
        
        // Chart.js 설정
        timelineChart = new Chart(ctx, {
            type: 'line',
            data: { datasets },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                interaction: {
                    mode: 'index',
                    intersect: false
                },
                plugins: {
                    legend: {
                        position: 'top',
                        labels: {
                            usePointStyle: true,
                            padding: 15,
                            font: {
                                size: 12
                            }
                        }
                    },
                    tooltip: {
                        backgroundColor: 'rgba(0, 0, 0, 0.8)',
                        padding: 12,
                        titleFont: {
                            size: 14
                        },
                        bodyFont: {
                            size: 13
                        },
                        callbacks: {
                            label: function(context) {
                                return context.dataset.label + ': ' + context.parsed.y.toLocaleString() + '회';
                            }
                        }
                    }
                },
                scales: {
                    x: {
                        type: 'time',
                        time: {
                            unit: 'day',
                            displayFormats: {
                                day: 'MM/dd'
                            }
                        },
                        title: {
                            display: true,
                            text: '날짜',
                            font: {
                                size: 12
                            }
                        },
                        grid: {
                            color: 'rgba(0, 0, 0, 0.05)'
                        }
                    },
                    y: {
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: '언급 횟수',
                            font: {
                                size: 12
                            }
                        },
                        grid: {
                            color: 'rgba(0, 0, 0, 0.05)'
                        },
                        ticks: {
                            callback: function(value) {
                                return value.toLocaleString();
                            }
                        }
                    }
                }
            }
        });
        
        console.log('✅ 타임라인 차트 렌더링 완료!');
    }
    
    // 차트 색상 헬퍼 함수
    function getChartColor(index, alpha = 1) {
        const colors = [
            `rgba(79, 70, 229, ${alpha})`,   // 보라
            `rgba(16, 185, 129, ${alpha})`,  // 초록
            `rgba(245, 158, 11, ${alpha})`,  // 주황
            `rgba(239, 68, 68, ${alpha})`,   // 빨강
            `rgba(59, 130, 246, ${alpha})`,  // 파랑
            `rgba(139, 92, 246, ${alpha})`,  // 보라2
            `rgba(236, 72, 153, ${alpha})`,  // 분홍
            `rgba(20, 184, 166, ${alpha})`   // 청록
        ];
        return colors[index % colors.length];
    }

    function updateTrendsSummary(data) {
        const summaryDiv = document.getElementById('trendsSummary');
        
        if (!data || !data.summary) {
            summaryDiv.innerHTML = '<p>요약 데이터가 없습니다.</p>';
            return;
        }

        const summary = data.summary;
        summaryDiv.innerHTML = `
            <div class="summary-grid">
                <div class="summary-item">
                    <span class="summary-label">총 트렌드</span>
                    <span class="summary-value">${summary.total_trends || 0}</span>
                </div>
                <div class="summary-item">
                    <span class="summary-label">신규 트렌드</span>
                    <span class="summary-value">${summary.new_trends || 0}</span>
                </div>
                <div class="summary-item">
                    <span class="summary-label">상승 트렌드</span>
                    <span class="summary-value">${summary.rising_trends || 0}</span>
                </div>
            </div>
        `;
    }

    function updateKeywordsCloud(data) {
        const cloudDiv = document.getElementById('keywordsCloud');
        
        if (!data || !data.keywords || data.keywords.length === 0) {
            cloudDiv.innerHTML = '<p>키워드 데이터가 없습니다.</p>';
            return;
        }

        // 상위 15개만 표시하고 크기를 훨씬 작게
        const topKeywords = data.keywords.slice(0, 15);
        cloudDiv.innerHTML = topKeywords.map(keyword => {
            // 크기를 매우 작게 조정 (0.65rem ~ 0.85rem)
            const size = Math.min(Math.max(keyword.count / 250, 0.65), 0.85);
            return `<span class="keyword-tag" style="font-size: ${size}rem; padding: 0.25rem 0.5rem;">${keyword.word}</span>`;
        }).join('');
    }

    function updateWordcloud(data, shape = currentShape) {
        const container = document.getElementById('wordcloudCanvas');
        
        if (!container) {
            console.error('❌ 워드클라우드 컨테이너를 찾을 수 없습니다.');
            return;
        }
        
        // 기존 워드클라우드 초기화
        container.innerHTML = '';
        
        // 데이터 검증
        console.log('📊 워드클라우드 데이터 확인:', {
            hasData: !!data,
            hasKeywords: !!(data && data.keywords),
            keywordCount: data && data.keywords ? data.keywords.length : 0,
            firstKeyword: data && data.keywords && data.keywords[0]
        });
        
        if (!data || !data.keywords || data.keywords.length === 0) {
            container.innerHTML = '<p class="loading">⚠️ 키워드 데이터가 없습니다.</p>';
            console.warn('⚠️ 키워드 데이터 없음');
            return;
        }

        // WordCloud.js 형식으로 데이터 변환
        // [단어, 빈도수] 형식의 배열로 변환
        const wordcloudData = data.keywords.map(keyword => {
            return [keyword.word, keyword.count || keyword.frequency || 1];
        });
        
        console.log('✅ 워드클라우드 데이터 변환 완료:', wordcloudData.slice(0, 5));
        
        // 현재 데이터 저장
        currentWordcloudData = wordcloudData;
        currentShape = shape;

        try {
            // WordCloud2 렌더링 (전역 함수명 확인)
            // wordcloud2.js는 전역에 WordCloud 함수를 등록합니다
            if (typeof WordCloud === 'undefined') {
                throw new Error('WordCloud 라이브러리가 로드되지 않았습니다.');
            }
            
            WordCloud(container, {
                list: wordcloudData.slice(0, 50),  // 상위 50개만 사용
                // 글자 크기 조정 - 가독성 확보
                gridSize: 8,  // 간격 좁게 (더 많이 표시)
                weightFactor: 3,  // 글자 크기 적당하게 (보이도록 조정)
                fontFamily: 'Pretendard, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif',
                fontWeight: '600',
                color: function(word, weight, fontSize) {
                    // 큰 글씨(빈도수 높음): 진한 파란색, 작은 글씨: 밝은 파란색
                    return fontSize > 20 ? '#2563eb' : '#3b82f6';
                },
                backgroundColor: 'transparent',
                // 모양 설정 (circle이 가장 많이 표시됨)
                shape: 'circle',  // circle이 가장 효율적
                rotateRatio: 0.5,
                rotationSteps: 2,
                drawOutOfBound: false,
                shrinkToFit: true,
                clearCanvas: true,
                wait: 0
            });
            
            console.log('워드클라우드 렌더링 완료:', wordcloudData.length, '개 단어', '(모양:', shape + ')');
        } catch (error) {
            console.error('워드클라우드 렌더링 실패:', error);
            container.innerHTML = '<p class="loading">워드클라우드를 표시할 수 없습니다.</p>';
        }
    }
    
    // 워드클라우드 모양 변경 함수
    function changeWordcloudShape(shape) {
        if (!currentWordcloudData) {
            console.warn('워드클라우드 데이터가 없습니다.');
            return;
        }
        
        // 활성 버튼 표시
        document.querySelectorAll('.shape-btn').forEach(btn => btn.classList.remove('active'));
        event.target.classList.add('active');
        
        // 워드클라우드 다시 렌더링
        const container = document.getElementById('wordcloudCanvas');
        container.innerHTML = '';
        
        try {
            if (typeof WordCloud === 'undefined') {
                throw new Error('WordCloud 라이브러리가 로드되지 않았습니다.');
            }
            
            WordCloud(container, {
                list: currentWordcloudData.slice(0, 50),  // 상위 50개만
                gridSize: 16,  // 간격 더 넓게
                weightFactor: 0.05,  // 글자 크기 극소 (사용자 요청: 0.35 → 0.05)
                fontFamily: 'Pretendard, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif',
                fontWeight: '400',
                color: function(word, weight, fontSize) {
                    // 큰 글씨(빈도수 높음): 진한 파란색, 작은 글씨: 밝은 파란색
                    return fontSize > 20 ? '#2563eb' : '#3b82f6';
                },
                backgroundColor: 'transparent',
                shape: shape,
                ellipticity: 0.7,  // 하트 세로 비율
                rotateRatio: 0.3,
                rotationSteps: 2,
                minSize: 4,
                maxSize: 18,
                drawOutOfBound: false,
                shrinkToFit: true,
                clearCanvas: true,
                wait: 0
            });
            
            currentShape = shape;
            console.log('워드클라우드 모양 변경:', shape);
        } catch (error) {
            console.error('워드클라우드 렌더링 실패:', error);
            container.innerHTML = '<p class="loading">워드클라우드를 표시할 수 없습니다.</p>';
        }
    }

    function updateTrendsTable(data) {
        const tbody = document.getElementById('trendsTableBody');
        
        console.log('📊 상세 트렌드 테이블 업데이트:', {
            hasData: !!data,
            hasTrends: !!(data && data.trends),
            trendsCount: data && data.trends ? data.trends.length : 0,
            firstTrend: data && data.trends && data.trends[0]
        });
        
        if (!data || !data.trends || data.trends.length === 0) {
            tbody.innerHTML = '<tr><td colspan="5">⚠️ 트렌드 데이터가 없습니다.</td></tr>';
            console.warn('⚠️ 트렌드 데이터 없음');
            return;
        }

        tbody.innerHTML = data.trends.map((trend, index) => `
            <tr>
                <td>${index + 1}</td>
                <td><strong>${trend.keyword || 'N/A'}</strong></td>
                <td>${(trend.mentions || 0).toLocaleString()}</td>
                <td class="${trend.change >= 0 ? 'positive' : 'negative'}">
                    ${trend.change >= 0 ? '▲' : '▼'} ${Math.abs(trend.change || 0).toFixed(1)}%
                </td>
                <td>${trend.category || 'N/A'}</td>
            </tr>
        `).join('');
        
        console.log('✅ 상세 트렌드 테이블 업데이트 완료!', data.trends.length + '개 항목');
    }

    // 필터 초기화 함수
    function initializeFilters() {
        // 기본 날짜 설정 (최근 7일)
        const now = new Date();
        const weekAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
        
        document.getElementById('startDate').value = weekAgo.toISOString().slice(0, 16);
        document.getElementById('endDate').value = now.toISOString().slice(0, 16);
        
        // 커뮤니티 목록 로드 (더미 데이터)
        loadCommunityOptions();
    }
    
    // 커뮤니티 옵션 로드
    function loadCommunityOptions() {
        const communitySelect = document.getElementById('communityFilter');
        const dummyCommunities = [
            '테크 커뮤니티',
            '개발자 포럼',
            'AI 연구소',
            '클라우드 사용자 모임',
            '오픈소스 커뮤니티'
        ];
        
        communitySelect.innerHTML = '<option value="">전체</option>' + 
            dummyCommunities.map(name => `<option value="${name}">${name}</option>`).join('');
    }
    
    // 필터 적용
    async function applyFilters() {
        const startDate = document.getElementById('startDate').value;
        const endDate = document.getElementById('endDate').value;
        const community = document.getElementById('communityFilter').value;
        const board = document.getElementById('boardFilter').value;
        const keywords = document.getElementById('keywordsFilter').value;
        const granularity = document.getElementById('granularity').value;
        
        console.log('필터 적용:', {
            startDate,
            endDate,
            community,
            board,
            keywords,
            granularity
        });
        
        // ✅ 실제 API 호출 (필터 적용 시에도 실제 데이터 사용)
        try {
            // 필터 파라미터 구성 (현재는 limit만 사용, 나중에 확장 가능)
            const params = new URLSearchParams();
            params.append('limit', '100');
            
            const data = await apiRequest(`/api/trends?${params.toString()}`);
            
            // 데이터 업데이트
            updateStatsCards(data);        // ⭐ 통계 카드 업데이트
            updateTrendsSummary(data);
            updateKeywordsCloud(data);
            updateWordcloud(data);
            updateTimelineChart(data);     // ⭐ 타임라인 차트 업데이트
            updateTrendsTable(data);
            
            console.log('✅ 필터 적용된 실제 데이터 로드 성공! source:', data.source);
            
            // 사용자 피드백
            showFilterAppliedMessage();
        } catch (error) {
            console.error('❌ 필터 적용 실패:', error);
            alert('필터를 적용하는 중 오류가 발생했습니다.');
        }
    }
    
    // 필터 초기화
    function resetFilters() {
        document.getElementById('startDate').value = '';
        document.getElementById('endDate').value = '';
        document.getElementById('communityFilter').value = '';
        document.getElementById('boardFilter').value = '';
        document.getElementById('keywordsFilter').value = '';
        document.getElementById('granularity').value = '1d';
        
        initializeFilters();
        loadDummyData();
        
        console.log('필터 초기화 완료');
    }
    
    // 필터 적용 메시지
    function showFilterAppliedMessage() {
        const startDate = document.getElementById('startDate').value;
        const endDate = document.getElementById('endDate').value;
        
        let message = '필터가 적용되었습니다';
        if (startDate && endDate) {
            const start = new Date(startDate);
            const end = new Date(endDate);
            const days = Math.round((end - start) / (1000 * 60 * 60 * 24));
            message += ` (${days}일간 데이터)`;
        }
        
        console.log(message);
    }
    
    // 페이지 로드 시 필터 초기화
    initializeFilters();
    loadTrendsData();
</script>
{% endblock %}

