<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI ì±„íŒ… - Community Admin</title>
    <link rel="icon" type="image/png" href="{{ url_for('static', path='/img/sub_home.png') }}">
    <link rel="stylesheet" href="{{ url_for('static', path='/css/app.css') }}">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen', 'Ubuntu', 'Cantarell', sans-serif;
            background-color: #FFFFFF;
            color: #1F2937;
            height: 100vh;
            overflow: hidden;
        }

        /* ë„¤ë¹„ê²Œì´ì…˜ ë°” ìˆ¨ê¸°ê¸° */
        .navbar {
            display: none;
        }

        /* ì¼ì¼ë³´ê³ ì„œ ì „ìš© ìŠ¤íƒ€ì¼ */
        .daily-report-bubble {
            max-width: 100% !important;
            padding: 0 !important;
            background: transparent !important;
            box-shadow: none !important;
        }
        
        .daily-report-container .summary-card {
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        
        .daily-report-container .summary-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }
        
        .report-section {
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        
        .report-section:hover {
            transform: translateY(-1px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.15) !important;
        }
        
        .status-item {
            transition: transform 0.2s ease, background-color 0.2s ease;
        }
        
        .status-item:hover {
            transform: scale(1.02);
            background: #E5E7EB !important;
        }
        
        .today-activity {
            position: relative;
            overflow: hidden;
        }
        
        .today-activity::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.5s ease;
        }
        
        .today-activity:hover::before {
            left: 100%;
        }

        /* ë©”ì¸ ì»¨í…Œì´ë„ˆ - ì´ˆê¸°ì—ëŠ” ë‹¨ì¼ íŒ¨ë„ */
        .main-container {
            display: flex;
            flex-direction: column;
            height: 100vh;
            transition: all 0.3s ease;
        }

        /* Split Viewë¡œ ì „í™˜ ì‹œ */
        .main-container.split-view {
            display: grid !important;
            grid-template-columns: 70% 4px calc(30% - 4px);
        }
        
        .main-container.split-view .chat-panel {
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* ì™¼ìª½ íŒ¨ë„ (ë„êµ¬ í˜ì´ì§€) */
        .left-panel {
            display: none;
            background-color: white;
            border-right: 1px solid #E5E7EB;
            overflow: hidden;
        }

        .main-container.split-view .left-panel.active {
            display: flex;
            flex-direction: column;
        }

        .left-panel iframe {
            width: 100%;
            height: 100%;
            border: none;
            flex: 1;
        }
        
        /* ì™¼ìª½ íŒ¨ë„ì— ë¶„ì„ ê²°ê³¼ê°€ í•¨ê»˜ í‘œì‹œë  ë•Œ */
        .left-panel.with-analysis iframe {
            height: 50%;
            flex: none;
        }
        
        .left-panel .analysis-summary {
            height: 50%;
            overflow-y: auto;
            border-top: 2px solid #E5E7EB;
            background: #F9FAFB;
        }

        /* Execution Panel ì œê±°ë¨ - ê²€ìƒ‰ ê²°ê³¼ëŠ” ì™¼ìª½ board_search.htmlì—ë§Œ í‘œì‹œ */

        /* ì±„íŒ… íŒ¨ë„ */
        .chat-panel {
            display: flex;
            flex-direction: column;
            height: 100vh;
            background-color: #FFFFFF;
            max-width: 100%;
            margin: 0 auto;
            overflow: hidden;
        }
        
        /* Split viewì¼ ë•Œ ì±„íŒ… íŒ¨ë„ */
        .main-container.split-view .chat-panel {
            width: 100%;
            max-width: 100%;
            margin: 0;
            overflow: hidden;
        }

        /* ì±„íŒ… í—¤ë” - ë” ë¯¸ë‹ˆë©€í•˜ê²Œ */
        .chat-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem 1.5rem;
            border-bottom: 1px solid #F0F0F0;
            background: #FFFFFF;
            position: sticky;
            top: 0;
            z-index: 10;
            flex-shrink: 0;
        }
        
        /* Split viewì¼ ë•Œ í—¤ë” */
        .main-container.split-view .chat-header {
            padding: 0.75rem 1rem;
        }

        .chat-header-title {
            font-size: 1rem;
            font-weight: 600;
            color: #1F2937;
            margin: 0;
        }

        .chat-header-actions {
            display: flex;
            gap: 0.5rem;
        }

        .btn {
            padding: 0.5rem 0.75rem;
            border-radius: 0.375rem;
            border: none;
            background: transparent;
            color: #6B7280;
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 0.375rem;
            transition: all 0.2s;
        }

        .btn:hover {
            background: #F9FAFB;
            color: #374151;
        }

        .btn-secondary {
            background: transparent;
        }

        /* ì±„íŒ… ë©”ì‹œì§€ ì˜ì—­ */
        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 1.5rem;
            display: flex;
            flex-direction: column;
            background: #FFFFFF;
            width: 900px;
            max-width: 900px;
            margin: 0 auto;
            min-height: 0;
        }
        
        /* Split viewì¼ ë•ŒëŠ” flexë¡œ ë³€ê²½ */
        .main-container.split-view .chat-messages {
            flex: 1;
            min-height: 0;
            width: 100%;
            max-width: 100%;
            margin: 0;
            padding: 1rem;
            box-sizing: border-box;
        }
        
        .chat-messages .message {
            margin-bottom: 1.5rem;
        }
        
        .chat-messages .message:last-child {
            margin-bottom: 0;
        }

        .chat-empty {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: #9CA3AF;
            text-align: center;
            padding: 2rem;
        }

        .chat-empty-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
            opacity: 0.4;
        }

        .chat-empty-text {
            font-size: 0.9375rem;
            line-height: 1.6;
            color: #6B7280;
        }

        /* ë©”ì‹œì§€ ìŠ¤íƒ€ì¼ */
        .message {
            display: flex;
            animation: fadeIn 0.3s ease-in;
            max-width: 100%;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .message.user {
            justify-content: flex-end;
        }

        .message.bot {
            justify-content: flex-start;
        }

        .message-bubble {
            max-width: 700px;
            padding: 14px 18px;
            border-radius: 1.25rem;
            line-height: 1.6;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
            word-wrap: break-word;
            overflow-wrap: break-word;
        }
        
        /* Split viewì¼ ë•Œ ë©”ì‹œì§€ ë²„ë¸” */
        .main-container.split-view .message-bubble {
            max-width: 90%;
        }

        .message.user .message-bubble {
            background: #2563EB;
            color: white;
            border-bottom-right-radius: 0.25rem;
            margin-left: auto;
        }

        .message.bot .message-bubble {
            background: #F7F7F8;
            color: #1F2937;
            border-bottom-left-radius: 0.25rem;
            border: 1px solid #E5E7EB;
        }

        .message-content {
            font-size: 0.9375rem;
            white-space: pre-wrap;
            word-wrap: break-word;
            line-height: 1.75;
        }

        .message.user .message-content {
            color: #FFFFFF;
        }

        .message.bot .message-content {
            color: #1F2937;
        }

        .tool-badge {
            display: inline-block;
            padding: 4px 10px;
            background: #EFF6FF;
            border: 1px solid #BFDBFE;
            border-radius: 0.5rem;
            font-size: 0.75rem;
            color: #1E40AF;
            margin-top: 10px;
            font-weight: 500;
        }

        .page-action-btn {
            display: inline-block;
            margin-top: 10px;
            padding: 8px 16px;
            background: #2563EB;
            color: white;
            border-radius: 0.5rem;
            text-decoration: none;
            font-size: 0.8125rem;
            font-weight: 600;
            transition: background 0.2s;
        }

        .page-action-btn:hover {
            background: #1D4ED8;
        }

        /* ì…ë ¥ ì˜ì—­ */
        .chat-input-container {
            border-top: 1px solid #F0F0F0;
            padding: 1rem 1.5rem;
            background: #FFFFFF;
            position: sticky;
            bottom: 0;
            z-index: 10;
            flex-shrink: 0;
            box-sizing: border-box;
        }
        
        /* Split viewì¼ ë•Œ ì…ë ¥ ì˜ì—­ */
        .main-container.split-view .chat-input-container {
            padding: 1rem;
            position: relative;
        }

        .chat-input-wrapper {
            width: 900px;
            max-width: 900px;
            margin: 0 auto;
        }
        
        /* Split viewì¼ ë•Œ ì…ë ¥ ì˜ì—­ ë˜í¼ */
        .main-container.split-view .chat-input-wrapper {
            width: 100%;
            max-width: 100%;
            margin: 0;
        }

        .chat-input-box {
            display: flex;
            gap: 0.75rem;
            align-items: flex-end;
            background: #FFFFFF;
            border: 1px solid #D1D5DB;
            border-radius: 1.5rem;
            padding: 0.75rem 1.25rem;
            max-width: 100%;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
            transition: all 0.2s;
        }

        .chat-input-box:focus-within {
            border-color: #2563EB;
            box-shadow: 0 2px 12px rgba(37, 99, 235, 0.1);
        }

        .chat-input {
            flex: 1;
            border: none;
            background: transparent;
            resize: none;
            font-size: 0.9375rem;
            font-family: inherit;
            outline: none;
            max-height: 120px;
            overflow-y: auto;
            line-height: 1.6;
            color: #1F2937;
        }

        .chat-input::placeholder {
            color: #9CA3AF;
        }

        .chat-send-btn {
            width: 32px;
            height: 32px;
            background: #2563EB;
            color: white;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            flex-shrink: 0;
        }

        .chat-send-btn:hover:not(:disabled) {
            background: #1D4ED8;
            transform: scale(1.05);
        }

        .chat-send-btn:disabled {
            background: #D1D5DB;
            cursor: not-allowed;
            transform: none;
        }

        .chat-send-btn svg {
            width: 18px;
            height: 18px;
        }

        /* ìŠ¤í¬ë¡¤ ë²„íŠ¼ */
        .scroll-to-bottom {
            position: fixed;
            bottom: 100px;
            right: 20px;
            width: 40px;
            height: 40px;
            background: #2563EB;
            color: white;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            display: none;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            transition: all 0.2s;
            z-index: 100;
        }

        .scroll-to-bottom:hover {
            background: #1D4ED8;
            transform: translateY(-2px);
        }

        .scroll-to-bottom.visible {
            display: flex;
        }

        /* ë°˜ì‘í˜• */
        @media (max-width: 1024px) {
            .main-container.split-view {
                grid-template-columns: 1fr;
                grid-template-rows: 50% 50%;
            }
            
            .left-panel {
                border-right: none;
                border-bottom: 1px solid #E5E7EB;
            }
            
            .chat-messages {
                width: 100%;
                max-width: 100%;
            }
            
            .main-container.split-view .chat-messages {
                flex: 1;
            }
            
            .chat-input-wrapper {
                width: 100%;
                max-width: 100%;
            }
            
            .message-bubble {
                max-width: 85%;
            }
        }
        
        /* Split viewì—ì„œ ìŠ¤í¬ë¡¤ ë²„íŠ¼ ìœ„ì¹˜ ì¡°ì • */
        .main-container.split-view .scroll-to-bottom {
            right: calc(30% / 2);
            transform: translateX(50%);
        }
        
        /* ë¦¬ì‚¬ì´ì¦ˆ í•¸ë“¤ */
        .resize-handle {
            display: none;
            width: 4px;
            background: #E5E7EB;
            cursor: col-resize;
            transition: background 0.2s;
            z-index: 20;
            position: relative;
        }
        
        .resize-handle:hover {
            background: #2563EB;
        }
        
        .resize-handle:active {
            background: #1D4ED8;
        }
        
        .main-container.split-view .resize-handle {
            display: block;
        }
        
        /* Analysis Result Panel (ë¶„ì„ ì‹¤í–‰ ê²°ê³¼) */
        .analysis-result-panel {
            display: none;
            background-color: #FFFFFF;
            color: #1F2937;
            height: 100%;
            overflow-y: auto;
            padding: 1.5rem;
        }
        
        .main-container.split-view .analysis-result-panel.active {
            display: block;
        }
        
        .analysis-loading {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            min-height: 400px;
        }
        
        .analysis-loading-spinner {
            width: 50px;
            height: 50px;
            border: 4px solid #E5E7EB;
            border-top: 4px solid #2563EB;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .analysis-loading-text {
            margin-top: 1rem;
            color: #6B7280;
            font-size: 0.9375rem;
        }
        
        /* ë¶„ì„ ê²°ê³¼ ì»¨í…ì¸  */
        .analysis-content {
            display: none;
        }
        
        .analysis-content.show {
            display: block;
        }
        
        .analysis-header {
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid #E5E7EB;
        }
        
        .analysis-header h2 {
            font-size: 1.5rem;
            color: #1F2937;
            margin-bottom: 0.5rem;
        }
        
        .analysis-metrics {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 1.5rem;
        }
        
        .metric-card {
            background: #F9FAFB;
            padding: 1rem;
            border-radius: 0.5rem;
            border: 1px solid #E5E7EB;
        }
        
        .metric-label {
            font-size: 0.875rem;
            color: #6B7280;
            margin-bottom: 0.5rem;
        }
        
        .metric-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: #2563EB;
        }
    </style>
</head>
<body>
    {% include "components/nav.html" %}
    
    <!-- ë©”ì¸ ì»¨í…Œì´ë„ˆ -->
    <div class="main-container" id="mainContainer">
        <!-- ì™¼ìª½ íŒ¨ë„ (ë„êµ¬ í˜ì´ì§€ iframe) -->
        <div class="left-panel" id="leftPanel">
            <iframe id="toolFrame" src="about:blank"></iframe>
            <!-- ë¶„ì„ ê²°ê³¼ ìš”ì•½ (ì´íƒˆë¥  ë“±) -->
            <div class="analysis-summary" id="analysisSummary" style="display: none;"></div>
        </div>

        <!-- Execution Panel ì œê±° (ê²€ìƒ‰ ê²°ê³¼ëŠ” ì™¼ìª½ board_search.htmlì—ë§Œ í‘œì‹œ) -->
        
        <!-- Analysis Result Panel (ë¶„ì„ ì‹¤í–‰ ê²°ê³¼ìš©) -->
        <div class="analysis-result-panel" id="analysisResultPanel"></div>
        
        <!-- ë¦¬ì‚¬ì´ì¦ˆ í•¸ë“¤ -->
        <div class="resize-handle" id="resizeHandle"></div>
        
        <!-- ì±„íŒ… íŒ¨ë„ -->
        <div class="chat-panel">
            <!-- í—¤ë” -->
            <div class="chat-header">
                <div class="chat-header-left">
                    <h1 class="chat-header-title">WebMaster AI Agent</h1>
                </div>
                <div class="chat-header-actions">
                    <button id="newChatBtn" class="btn btn-secondary" title="ìƒˆ ëŒ€í™”">
                        <span>â• ìƒˆ ëŒ€í™”</span>
                    </button>
                    <a href="/" class="btn btn-primary" title="í™ˆìœ¼ë¡œ" style="background: #2563EB; color: white; text-decoration: none;">
                        <span>ğŸ  í™ˆìœ¼ë¡œ</span>
                    </a>
                </div>
            </div>

            <!-- ë©”ì‹œì§€ ì˜ì—­ -->
            <div id="chatMessages" class="chat-messages">
                <div class="chat-empty">
                    <div class="chat-empty-icon">ğŸ’¬</div>
                    <div class="chat-empty-text">
                        ì§ˆë¬¸ì„ ì…ë ¥í•˜ë©´ AIê°€ ë‹µë³€í•´ë“œë¦½ë‹ˆë‹¤.
                    </div>
                </div>
            </div>

            <!-- ì…ë ¥ ì˜ì—­ -->
            <div class="chat-input-container">
                <div class="chat-input-wrapper">
                    <div class="chat-input-box">
                        <textarea 
                            id="chatInput" 
                            class="chat-input" 
                            placeholder="ë¬´ì—‡ì´ë“  ë¬¼ì–´ë³´ì„¸ìš”"
                            rows="1"
                        ></textarea>
                        <button id="chatSendBtn" class="chat-send-btn" title="ì „ì†¡">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M22 2L11 13M22 2l-7 20-4-9-9-4 20-7z"/>
                            </svg>
                        </button>
                    </div>
                </div>
            </div>

            <!-- ìŠ¤í¬ë¡¤ ë²„íŠ¼ -->
            <button id="scrollToBottom" class="scroll-to-bottom" title="ë§¨ ì•„ë˜ë¡œ">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 20px; height: 20px;">
                    <path d="M19 9l-7 7-7-7"/>
                </svg>
            </button>
        </div>
    </div>

    <script src="{{ url_for('static', path='/js/app.js') }}"></script>
    
    <script>
        const API_BASE_URL = window.location.origin;
        let isProcessing = false;
        let sessionId = null;
        let currentToolId = null;
        
        // ê²€ìƒ‰ ìƒíƒœ ì €ì¥ (ëª©ë¡ ëŒì•„ê°€ê¸°ìš©)
        let lastSearchData = null;

        // ë„êµ¬ë³„ í˜ì´ì§€ ë§¤í•‘
        const toolPageMap = {
            'semantic_search_tool': '/board/search',
            'churn_analysis_tool': '/churn',
            'ethics_check_tool': '/ethics_dashboard',
            'match_reports_tool': '/admin/reports',
            'trends_analysis_tool': '/trends'
        };

        // ì´ˆê¸°í™”
        document.addEventListener('DOMContentLoaded', function() {
            sessionId = generateSessionId();
            
            // URLì—ì„œ ì´ˆê¸° ì§ˆë¬¸ ê°€ì ¸ì˜¤ê¸°
            const urlParams = new URLSearchParams(window.location.search);
            const initialQuery = urlParams.get('q');
            if (initialQuery) {
                document.getElementById('chatInput').value = initialQuery;
                setTimeout(() => sendMessage(), 500);
            }
            
            // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
            document.getElementById('chatSendBtn').addEventListener('click', sendMessage);
            document.getElementById('chatInput').addEventListener('keydown', function(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });
            document.getElementById('newChatBtn').addEventListener('click', resetChat);
            document.getElementById('scrollToBottom').addEventListener('click', scrollToBottom);
            
            // í…ìŠ¤íŠ¸ ì˜ì—­ ìë™ ë†’ì´ ì¡°ì ˆ
            const textarea = document.getElementById('chatInput');
            textarea.addEventListener('input', function() {
                this.style.height = 'auto';
                this.style.height = Math.min(this.scrollHeight, 120) + 'px';
            });

            // ìŠ¤í¬ë¡¤ ë²„íŠ¼ í‘œì‹œ/ìˆ¨ê¹€
            const messagesContainer = document.getElementById('chatMessages');
            messagesContainer.addEventListener('scroll', function() {
                const scrollBtn = document.getElementById('scrollToBottom');
                const isAtBottom = messagesContainer.scrollHeight - messagesContainer.scrollTop <= messagesContainer.clientHeight + 50;
                scrollBtn.classList.toggle('visible', !isAtBottom);
            });
            
            // ë¦¬ì‚¬ì´ì¦ˆ í•¸ë“¤ ì´ë²¤íŠ¸
            initResizeHandle();
        });
        
        // ë¦¬ì‚¬ì´ì¦ˆ í•¸ë“¤ ì´ˆê¸°í™”
        function initResizeHandle() {
            const resizeHandle = document.getElementById('resizeHandle');
            const mainContainer = document.getElementById('mainContainer');
            let isResizing = false;
            let startX = 0;
            let startLeftWidth = 0;
            
            resizeHandle.addEventListener('mousedown', function(e) {
                isResizing = true;
                startX = e.clientX;
                const leftPanel = document.querySelector('.left-panel.active, .analysis-result-panel.active');
                startLeftWidth = leftPanel ? leftPanel.offsetWidth : window.innerWidth * 0.7;
                
                document.body.style.cursor = 'col-resize';
                document.body.style.userSelect = 'none';
            });
            
            document.addEventListener('mousemove', function(e) {
                if (!isResizing) return;
                
                const diffX = e.clientX - startX;
                const newLeftWidth = ((startLeftWidth + diffX) / window.innerWidth) * 100;
                
                // ìµœì†Œ/ìµœëŒ€ ì œí•œ (50% ~ 85%)
                if (newLeftWidth >= 50 && newLeftWidth <= 85) {
                    const rightWidth = 100 - newLeftWidth - 0.4; // 4px for handle
                    mainContainer.style.gridTemplateColumns = `${newLeftWidth}% 4px ${rightWidth}%`;
                }
            });
            
            document.addEventListener('mouseup', function() {
                if (isResizing) {
                    isResizing = false;
                    document.body.style.cursor = '';
                    document.body.style.userSelect = '';
                }
            });
        }

        // ì„¸ì…˜ ID ìƒì„±
        function generateSessionId() {
            return 'session_' + Math.random().toString(36).substr(2, 9) + '_' + Date.now();
        }

        // iframe ë¡œë”© ì™„ë£Œ ì—¬ë¶€ ì¶”ì 
        let iframeLoaded = false;
        let pendingMessage = null;
        
        // Split View ì „í™˜
        function enableSplitView(toolId, panelType = 'auto') {
            console.log('enableSplitView í˜¸ì¶œ:', toolId, panelType);
            const mainContainer = document.getElementById('mainContainer');
            const leftPanel = document.getElementById('leftPanel');
            const analysisResultPanel = document.getElementById('analysisResultPanel');
            const toolFrame = document.getElementById('toolFrame');

            if (!mainContainer || !leftPanel || !analysisResultPanel) {
                console.error('í•„ìš”í•œ ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
                return;
            }

            // split-view í´ë˜ìŠ¤ ì¶”ê°€
            mainContainer.classList.add('split-view');
            
            // ì´ˆê¸° ê·¸ë¦¬ë“œ ì„¤ì • (70:30 - í˜ì´ì§€:ëŒ€í™”)
            mainContainer.style.gridTemplateColumns = '70% 4px calc(30% - 4px)';
            
            console.log('split-view í´ë˜ìŠ¤ ì¶”ê°€ë¨');

            // ëª¨ë“  íŒ¨ë„ ë¹„í™œì„±í™”
            leftPanel.classList.remove('active');
            analysisResultPanel.classList.remove('active');
            
            // panelTypeì— ë”°ë¼ íŒ¨ë„ ì„ íƒ
            if (panelType === 'analysis') {
                console.log('ë¶„ì„ ê²°ê³¼ íŒ¨ë„ í‘œì‹œ');
                analysisResultPanel.classList.add('active');
            } else {
                // iframeìœ¼ë¡œ í˜ì´ì§€ ë¡œë“œ (ê²€ìƒ‰ ê²°ê³¼ë„ board_search.htmlë¡œ í‘œì‹œ)
                console.log('ë„êµ¬ í˜ì´ì§€ ë¡œë“œ:', toolId);
                leftPanel.classList.add('active');
                
                const pageUrl = toolPageMap[toolId];
                console.log('í˜ì´ì§€ URL:', pageUrl);
                if (pageUrl) {
                    // iframeì´ ì´ë¯¸ ê°™ì€ í˜ì´ì§€ë¥¼ ë¡œë“œ ì¤‘ì´ë©´ onload ì´ë²¤íŠ¸ê°€ ë°œìƒí•˜ì§€ ì•Šì„ ìˆ˜ ìˆìŒ
                    if (toolFrame.src !== window.location.origin + pageUrl) {
                        iframeLoaded = false;
                        console.log('[DEBUG] iframe src ë³€ê²½, iframeLoaded = false');
                        
                        // onload ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
                        toolFrame.onload = function() {
                            console.log('[DEBUG] iframe onload ì´ë²¤íŠ¸ ë°œìƒ');
                            iframeLoaded = true;
                            
                            // ëŒ€ê¸° ì¤‘ì¸ ë©”ì‹œì§€ê°€ ìˆìœ¼ë©´ ì „ì†¡
                            if (pendingMessage) {
                                console.log('[DEBUG] ëŒ€ê¸° ì¤‘ì¸ ë©”ì‹œì§€ ì „ì†¡:', pendingMessage);
                                sendBoardCommand(pendingMessage.command, pendingMessage.data);
                                pendingMessage = null;
                            }
                        };
                        
                        toolFrame.src = pageUrl;
                        console.log('iframe src ì„¤ì •:', pageUrl);
                    } else {
                        console.log('[DEBUG] iframeì´ ì´ë¯¸ ê°™ì€ í˜ì´ì§€ ë¡œë“œ ì¤‘, iframeLoaded = true');
                        iframeLoaded = true;
                    }
                } else {
                    console.warn('ë„êµ¬ì— ëŒ€í•œ í˜ì´ì§€ URLì´ ì—†ìŠµë‹ˆë‹¤:', toolId);
                }
            }
        }

        // ë‹¨ì¼ íŒ¨ë„ë¡œ ë³µê·€
        function disableSplitView() {
            console.log('disableSplitView í˜¸ì¶œ');
            const mainContainer = document.getElementById('mainContainer');
            const leftPanel = document.getElementById('leftPanel');
            const analysisResultPanel = document.getElementById('analysisResultPanel');
            const analysisSummary = document.getElementById('analysisSummary');
            const toolFrame = document.getElementById('toolFrame');

            if (mainContainer) {
                mainContainer.classList.remove('split-view');
                mainContainer.style.gridTemplateColumns = '';
            }
            if (leftPanel) {
                leftPanel.classList.remove('active');
                leftPanel.classList.remove('with-analysis');
            }
            if (analysisResultPanel) {
                analysisResultPanel.classList.remove('active');
            }
            if (analysisSummary) {
                analysisSummary.style.display = 'none';
                analysisSummary.innerHTML = '';
            }
            if (toolFrame) {
                toolFrame.src = 'about:blank';
            }
            currentToolId = null;
        }
        
        // postMessageë¡œ iframeì— ë©”ì‹œì§€ ì „ì†¡
        function sendMessageToToolFrame(type, data) {
            const toolFrame = document.getElementById('toolFrame');
            if (toolFrame && toolFrame.contentWindow) {
                console.log('sendMessageToToolFrame:', type, data);
                toolFrame.contentWindow.postMessage({ type, data }, window.location.origin);
            } else {
                console.warn('toolFrame not ready for postMessage');
            }
        }
        
        // ê²Œì‹œíŒ ëª…ë ¹ ì „ì†¡
        function sendBoardCommand(command, data) {
            const toolFrame = document.getElementById('toolFrame');
            console.log('[DEBUG] sendBoardCommand í˜¸ì¶œ:', command, data);
            console.log('[DEBUG] toolFrame.src:', toolFrame ? toolFrame.src : 'null');
            console.log('[DEBUG] iframeLoaded:', iframeLoaded);
            
            if (!toolFrame) {
                console.error('[ERROR] toolFrameì´ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤');
                return;
            }
            
            if (!toolFrame.src.includes('/board/search')) {
                console.warn('[WARN] Board frameì´ /board/searchë¥¼ ë¡œë“œí•˜ì§€ ì•ŠìŒ');
                console.warn('[WARN] toolFrame.src:', toolFrame.src);
                return;
            }
            
            // iframeì´ ë¡œë”©ë˜ì§€ ì•Šì•˜ìœ¼ë©´ ëŒ€ê¸°
            if (!iframeLoaded) {
                console.log('[DEBUG] iframeì´ ì•„ì§ ë¡œë”© ì¤‘, ë©”ì‹œì§€ ëŒ€ê¸°ì—´ì— ì¶”ê°€');
                pendingMessage = { command, data };
                return;
            }
            
            console.log('[DEBUG] postMessage ì „ì†¡ ì¤‘...', {
                type: command,
                data: data,
                origin: window.location.origin
            });
            
            try {
                toolFrame.contentWindow.postMessage({
                    type: command,
                    data: data
                }, window.location.origin);
                console.log('[DEBUG] postMessage ì „ì†¡ ì™„ë£Œ');
            } catch (error) {
                console.error('[ERROR] postMessage ì „ì†¡ ì‹¤íŒ¨:', error);
            }
        }
        
        // ë¶„ì„ ì‹¤í–‰ í•¨ìˆ˜
        async function executeAction(endpoint, params, actionType = 'analysis') {
            console.log('executeAction í˜¸ì¶œ:', endpoint, params, actionType);
            
            // ì‹¤í–‰ ëª¨ë“œì—ì„œëŠ” í•­ìƒ analysisResultPanel ì‚¬ìš©
            const analysisResultPanel = document.getElementById('analysisResultPanel');
            
            // ë¡œë”© í‘œì‹œ
            const loadingText = actionType === 'report_action' ? 'ì‹ ê³ ë¥¼ ì²˜ë¦¬ ì¤‘ì…ë‹ˆë‹¤...' : 'ë¶„ì„ì„ ì‹¤í–‰ ì¤‘ì…ë‹ˆë‹¤...';
            analysisResultPanel.innerHTML = `
                <div class="analysis-loading">
                    <div class="analysis-loading-spinner"></div>
                    <div class="analysis-loading-text">${loadingText}</div>
                </div>
            `;
            
            try {
                const response = await fetch(`${API_BASE_URL}${endpoint}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(params)
                });
                
                if (!response.ok) {
                    throw new Error(`API ìš”ì²­ ì‹¤íŒ¨: ${response.status}`);
                }
                
                const data = await response.json();
                console.log('ì‹¤í–‰ ê²°ê³¼:', data);
                
                // ê²°ê³¼ ë Œë”ë§
                if (actionType === 'report_action') {
                    renderReportActionResult(data, params);
                } else {
                    renderAnalysisResult(data, endpoint);
                }
                
            } catch (error) {
                console.error('ì‹¤í–‰ ì˜¤ë¥˜:', error);
                analysisResultPanel.innerHTML = `
                    <div class="analysis-loading">
                        <div class="analysis-loading-text" style="color: #EF4444;">
                            âš ï¸ ì‹¤í–‰ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.<br>
                            ${error.message}
                        </div>
                    </div>
                `;
            }
        }
        
        // ì‹ ê³  ì•¡ì…˜ ê²°ê³¼ ë Œë”ë§
        function renderReportActionResult(data, params) {
            const analysisResultPanel = document.getElementById('analysisResultPanel');
            const isApprove = params.action === 'approve';
            const actionText = isApprove ? 'ìŠ¹ì¸' : 'ê±°ë¶€';
            const iconColor = isApprove ? '#10B981' : '#EF4444';
            const icon = isApprove ? 'âœ…' : 'âŒ';
            
            let html = `
                <div class="analysis-content show">
                    <div class="analysis-header">
                        <h2 style="color: ${iconColor};">${icon} ì‹ ê³  ${actionText} ì™„ë£Œ</h2>
                    </div>
                    
                    <div style="padding: 2rem; text-align: center;">
                        <div style="font-size: 4rem; margin-bottom: 1rem;">${icon}</div>
                        <div style="font-size: 1.25rem; font-weight: 600; color: #1F2937; margin-bottom: 0.5rem;">
                            ${data.message || `ì‹ ê³ ê°€ ${actionText}ë˜ì—ˆìŠµë‹ˆë‹¤`}
                        </div>
            `;
            
            if (data.success) {
                html += `
                        <div style="margin-top: 1.5rem; padding: 1rem; background: #F9FAFB; border-radius: 0.5rem; text-align: left;">
                            <div style="font-weight: 600; margin-bottom: 0.5rem;">ì²˜ë¦¬ ì •ë³´:</div>
                            <div style="color: #6B7280; font-size: 0.875rem;">
                                â€¢ ì²˜ë¦¬ ê²°ê³¼: <span style="color: ${iconColor}; font-weight: 600;">${actionText}</span><br>
                                ${params.note ? `â€¢ ì²˜ë¦¬ ì‚¬ìœ : ${escapeHtml(params.note)}<br>` : ''}
                                â€¢ ì²˜ë¦¬ ì‹œê°„: ${new Date().toLocaleString('ko-KR')}
                            </div>
                        </div>
                `;
            }
            
            html += `
                    </div>
                </div>
            `;
            
            analysisResultPanel.innerHTML = html;
            
            // ì™¼ìª½ íŒ¨ë„ì˜ ì‹ ê³  ëª©ë¡ ìƒˆë¡œê³ ì¹¨ (postMessage ì‚¬ìš©)
            const toolFrame = document.getElementById('toolFrame');
            if (toolFrame && toolFrame.src.includes('/admin/reports')) {
                setTimeout(() => {
                    sendMessageToToolFrame('reload_reports', {});
                }, 300); // ë¹ ë¥¸ ë°˜ì˜
            }
        }
        
        // ë¶„ì„ ê²°ê³¼ ë Œë”ë§
        function renderAnalysisResult(data, endpoint) {
            if (endpoint.includes('/churn/analysis/run')) {
                // ì´íƒˆ ë¶„ì„ ì‹¤í–‰ ê²°ê³¼ëŠ” analysisResultPanelì— ë Œë”ë§
                const analysisResultPanel = document.getElementById('analysisResultPanel');
                renderChurnAnalysisResult(data, analysisResultPanel);
            } else if (endpoint.includes('/ethics/analyze')) {
                // ë¹„ìœ¤ë¦¬ ë¶„ì„ ê²°ê³¼ëŠ” analysisResultPanelì— ë Œë”ë§
                const analysisResultPanel = document.getElementById('analysisResultPanel');
                renderEthicsAnalysisResult(data, analysisResultPanel);
            } else {
                // ê¸°ë³¸ JSON ë Œë”ë§
                const analysisResultPanel = document.getElementById('analysisResultPanel');
                analysisResultPanel.innerHTML = `
                    <div class="analysis-content show">
                        <div class="analysis-header">
                            <h2>ë¶„ì„ ê²°ê³¼</h2>
                        </div>
                        <pre style="background: #F9FAFB; padding: 1rem; border-radius: 0.5rem; overflow: auto;">
${JSON.stringify(data, null, 2)}
                        </pre>
                    </div>
                `;
            }
        }
        
        // ì´íƒˆ ë¶„ì„ ê²°ê³¼ ë Œë”ë§
        function renderChurnAnalysisResult(data, container) {
            const metrics = data.metrics || {};
            const activeUsers = metrics.active_users || 0;
            const churnedUsers = metrics.churned_users || 0;
            const churnRate = metrics.churn_rate || 0;
            const reactivatedUsers = metrics.reactivated_users || 0;
            const longTermInactive = metrics.long_term_inactive || 0;
            const insights = data.insights || [];
            const topRisks = data.top_risks || [];
            
            let html = `
                <div class="analysis-content show">
                    <div class="analysis-header">
                        <h2>ğŸ“Š ì´íƒˆ ë¶„ì„ ê²°ê³¼</h2>
                        <p style="color: #6B7280; font-size: 0.875rem;">
                            ê¸°ê°„: ${data.start_month || 'N/A'} ~ ${data.end_month || 'N/A'}
                        </p>
                    </div>
                    
                    <div class="analysis-metrics" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
                        <div class="metric-card">
                            <div class="metric-label">í™œì„± ì‚¬ìš©ì</div>
                            <div class="metric-value">${activeUsers.toLocaleString()}</div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-label">ì¬í™œì„± ì‚¬ìš©ì</div>
                            <div class="metric-value" style="color: #10B981;">${reactivatedUsers.toLocaleString()}</div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-label">ì´íƒˆ ì‚¬ìš©ì</div>
                            <div class="metric-value" style="color: #EF4444;">${churnedUsers.toLocaleString()}</div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-label">ì´íƒˆë¥ </div>
                            <div class="metric-value" style="color: #F59E0B;">${churnRate.toFixed(1)}%</div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-label">ì¥ê¸° ë¯¸ì ‘ì†</div>
                            <div class="metric-value" style="color: #6B7280;">${longTermInactive.toLocaleString()}</div>
                        </div>
                    </div>
            `;
            
            // AI ì¸ì‚¬ì´íŠ¸ ë¦¬í¬íŠ¸
            if (insights && insights.length > 0) {
                html += `
                    <div style="margin-top: 1.5rem; padding: 1.25rem; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 0.75rem; color: white;">
                        <h3 style="font-size: 1.125rem; margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                            <span style="font-size: 1.5rem;">ğŸ¤–</span> AI ê¸°ë°˜ ì¸ì‚¬ì´íŠ¸ ë¦¬í¬íŠ¸
                        </h3>
                        <ul style="list-style: none; padding: 0; margin: 0;">
                `;
                
                insights.forEach((insight, idx) => {
                    html += `
                        <li style="padding: 0.75rem 0; border-bottom: 1px solid rgba(255,255,255,0.2); display: flex; gap: 0.75rem;">
                            <span style="flex-shrink: 0; width: 1.5rem; height: 1.5rem; background: rgba(255,255,255,0.2); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 0.875rem; font-weight: 600;">
                                ${idx + 1}
                            </span>
                            <span style="flex: 1; line-height: 1.6;">${escapeHtml(insight)}</span>
                        </li>
                    `;
                });
                
                html += `
                        </ul>
                    </div>
                `;
            }
            
            // ê¶Œì¥ ì•¡ì…˜ ì„¹ì…˜
            const actions = data.actions || [];
            if (actions && actions.length > 0) {
                html += `
                    <div style="margin-top: 1.5rem; padding: 1.25rem; background: linear-gradient(135deg, #10b981 0%, #059669 100%); border-radius: 0.75rem; color: white;">
                        <h3 style="font-size: 1.125rem; margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                            <span style="font-size: 1.5rem;">ğŸ’¡</span> ê¶Œì¥ ì•¡ì…˜
                        </h3>
                        <ul style="list-style: none; padding: 0; margin: 0;">
                `;
                
                actions.forEach((action, idx) => {
                    html += `
                        <li style="padding: 0.75rem 0; border-bottom: 1px solid rgba(255,255,255,0.2); display: flex; gap: 0.75rem;">
                            <span style="flex-shrink: 0; width: 1.5rem; height: 1.5rem; background: rgba(255,255,255,0.2); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 0.875rem; font-weight: 600;">
                                ${idx + 1}
                            </span>
                            <span style="flex: 1; line-height: 1.6;">${escapeHtml(action)}</span>
                        </li>
                    `;
                });
                
                html += `
                        </ul>
                    </div>
                `;
            }
            
            // Top ìœ„í—˜ ìš”ì¸
            if (topRisks && topRisks.length > 0) {
                html += `
                    <div style="margin-top: 1.5rem;">
                        <h3 style="font-size: 1.125rem; margin-bottom: 1rem; color: #1F2937; display: flex; align-items: center; gap: 0.5rem;">
                            <span style="color: #EF4444;">âš ï¸</span> ì£¼ìš” ìœ„í—˜ ìš”ì¸ (Top 3)
                        </h3>
                        <div style="display: flex; flex-direction: column; gap: 0.75rem;">
                `;
                
                topRisks.forEach((risk, idx) => {
                    const colors = ['#EF4444', '#F59E0B', '#F97316'];
                    const color = colors[idx] || '#6B7280';
                    html += `
                        <div style="padding: 1rem; background: #F9FAFB; border-left: 4px solid ${color}; border-radius: 0.375rem;">
                            <div style="font-weight: 600; color: #1F2937; margin-bottom: 0.25rem;">
                                ${idx + 1}. ${escapeHtml(risk.factor || risk.description || 'ì•Œ ìˆ˜ ì—†ìŒ')}
                            </div>
                            <div style="font-size: 0.875rem; color: #6B7280;">
                                ì˜í–¥ë„: <span style="color: ${color}; font-weight: 600;">${(risk.impact || risk.churn_rate || 0).toFixed(1)}%</span>
                            </div>
                        </div>
                    `;
                });
                
                html += `
                        </div>
                    </div>
                `;
            }
            
            // ì„¸ê·¸ë¨¼íŠ¸ë³„ ë¶„ì„ ê²°ê³¼
            const segments = data.segments || {};
            if (Object.keys(segments).length > 0) {
                html += `
                    <div style="margin-top: 1.5rem;">
                        <h3 style="font-size: 1.125rem; margin-bottom: 1rem; color: #1F2937;">ì„¸ê·¸ë¨¼íŠ¸ë³„ ë¶„ì„</h3>
                `;
                
                // ê° ì„¸ê·¸ë¨¼íŠ¸ íƒ€ì… ì²˜ë¦¬
                const segmentNames = {
                    'gender': 'ì„±ë³„',
                    'age_band': 'ì—°ë ¹ëŒ€',
                    'channel': 'ì±„ë„',
                    'action_type': 'ì´ë²¤íŠ¸ íƒ€ì…'
                };
                
                for (const [segmentType, segmentData] of Object.entries(segments)) {
                    if (segmentData && segmentData.length > 0) {
                        html += `
                            <div style="margin-bottom: 2rem;">
                                <h4 style="font-size: 1rem; margin-bottom: 0.75rem; color: #374151; font-weight: 600;">
                                    ${segmentNames[segmentType] || segmentType}
                                </h4>
                                <div>
                                    <table style="width: 100%; border-collapse: collapse; background: white; border-radius: 0.5rem; overflow: hidden; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                                        <thead>
                                            <tr style="background: #F9FAFB; border-bottom: 2px solid #E5E7EB;">
                                                <th style="padding: 0.75rem; text-align: left; font-weight: 600; color: #374151;">ê°’</th>
                                                <th style="padding: 0.75rem; text-align: right; font-weight: 600; color: #374151;">í˜„ì¬ í™œì„±</th>
                                                <th style="padding: 0.75rem; text-align: right; font-weight: 600; color: #374151;">ì´ì „ í™œì„±</th>
                                                <th style="padding: 0.75rem; text-align: right; font-weight: 600; color: #374151;">ì´íƒˆì</th>
                                                <th style="padding: 0.75rem; text-align: right; font-weight: 600; color: #374151;">ì´íƒˆë¥ </th>
                                            </tr>
                                        </thead>
                                        <tbody>
                        `;
                        
                        segmentData.forEach(seg => {
                            const rate = seg.churn_rate || 0;
                            const color = rate > 50 ? '#EF4444' : rate > 30 ? '#F59E0B' : '#10B981';
                            const isUncertain = seg.is_uncertain || false;
                            
                            html += `
                                <tr style="border-bottom: 1px solid #E5E7EB;">
                                    <td style="padding: 0.75rem; font-weight: 500;">
                                        ${seg.segment_value || 'N/A'}
                                        ${isUncertain ? '<span style="color: #6B7280; font-size: 0.75rem; margin-left: 0.5rem;">(í‘œë³¸ ë¶€ì¡±)</span>' : ''}
                                    </td>
                                    <td style="padding: 0.75rem; text-align: right;">${(seg.current_active || 0).toLocaleString()}</td>
                                    <td style="padding: 0.75rem; text-align: right;">${(seg.previous_active || 0).toLocaleString()}</td>
                                    <td style="padding: 0.75rem; text-align: right; color: #EF4444;">${(seg.churned_users || 0).toLocaleString()}</td>
                                    <td style="padding: 0.75rem; text-align: right; color: ${color}; font-weight: 600;">${rate.toFixed(1)}%</td>
                                </tr>
                            `;
                        });
                        
                        html += `
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        `;
                    }
                }
                
                html += `</div>`;
            }
            
            html += `</div>`;
            container.innerHTML = html;
        }
        
        // ë¹„ìœ¤ë¦¬ ë¶„ì„ ê²°ê³¼ ë Œë”ë§
        function renderEthicsAnalysisResult(data, container) {
            const score = data.score || 0;
            const spamScore = data.spam || 0;
            
            const scoreColor = score >= 70 ? '#EF4444' : score >= 40 ? '#F59E0B' : '#10B981';
            const spamColor = spamScore >= 70 ? '#EF4444' : spamScore >= 40 ? '#F59E0B' : '#10B981';
            
            container.innerHTML = `
                <div class="analysis-content show">
                    <div class="analysis-header">
                        <h2>âš ï¸ ë¹„ìœ¤ë¦¬/ìŠ¤íŒ¸ ë¶„ì„ ê²°ê³¼</h2>
                    </div>
                    
                    <div class="analysis-metrics">
                        <div class="metric-card">
                            <div class="metric-label">ë¹„ìœ¤ë¦¬ ì ìˆ˜</div>
                            <div class="metric-value" style="color: ${scoreColor};">${score}</div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-label">ìŠ¤íŒ¸ ì ìˆ˜</div>
                            <div class="metric-value" style="color: ${spamColor};">${spamScore}</div>
                        </div>
                    </div>
                    
                    <div style="margin-top: 1.5rem; padding: 1rem; background: #F9FAFB; border-radius: 0.5rem;">
                        <h3 style="font-size: 1rem; margin-bottom: 0.5rem; color: #1F2937;">ë¶„ì„ëœ í…ìŠ¤íŠ¸</h3>
                        <p style="color: #4B5563; line-height: 1.6;">${escapeHtml(data.text || '')}</p>
                    </div>
                </div>
            `;
        }

        // ì¼ì¼ ë³´ê³ ì„œ ë Œë”ë§
        function renderDailyReport(reportText, container) {
            // ë³´ê³ ì„œ í…ìŠ¤íŠ¸ë¥¼ íŒŒì‹±í•˜ì—¬ êµ¬ì¡°í™”ëœ ë°ì´í„°ë¡œ ë³€í™˜
            const lines = reportText.split('\n');
            const today = new Date().toLocaleDateString('ko-KR', { 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric',
                weekday: 'long'
            });
            
            // ì„¹ì…˜ë³„ ë°ì´í„° ì¶”ì¶œ
            let reportData = {
                date: today,
                reports: { total: 0, pending: 0, completed: 0, rejected: 0, todayNew: 0, todayProcessed: 0 },
                ethics: { total: 0, highRisk: 0, spam: 0 },
                churn: { rate: 0, users: 0, churned: 0 },
                trends: []
            };
            
            // ë” ìœ ì—°í•œ íŒŒì‹± (ëª¨ë“  ê°€ëŠ¥í•œ íŒ¨í„´ ì‹œë„)
            for (let i = 0; i < lines.length; i++) {
                const line = lines[i].trim();
                
                // ì‹ ê³  ê´€ë ¨ ë°ì´í„° íŒŒì‹± - ë” ìœ ì—°í•œ íŒ¨í„´
                // ì´ ì‹ ê³  ê±´ìˆ˜: "â€¢ ì´ ì‹ ê³  ê±´ìˆ˜: 62ê±´" ë˜ëŠ” "ì´ ì‹ ê³  ê±´ìˆ˜: 1,234ê±´" ë“± ë‹¤ì–‘í•œ í˜•ì‹
                if (line.includes('ì´ ì‹ ê³  ê±´ìˆ˜')) {
                    // ë‹¤ì–‘í•œ íŒ¨í„´ ì‹œë„: "â€¢ ì´ ì‹ ê³  ê±´ìˆ˜: 62ê±´", "ì´ ì‹ ê³  ê±´ìˆ˜: 1,234ê±´", "ì´ ì‹ ê³  ê±´ìˆ˜ 62ê±´" ë“±
                    // â€¢ ê¸°í˜¸, ì½œë¡ , ê³µë°± ë“± ë‹¤ì–‘í•œ í˜•ì‹ ì§€ì›
                    const patterns = [
                        /[â€¢\s]*ì´\s*ì‹ ê³ \s*ê±´ìˆ˜[:\s]+(\d+(?:,\d+)*)\s*ê±´/i,
                        /[â€¢\s]*ì´\s*ì‹ ê³ \s*ê±´ìˆ˜[:\s]+(\d+(?:,\d+)*)/i,
                        /ì´\s*ì‹ ê³ \s*ê±´ìˆ˜.*?(\d+(?:,\d+)*)\s*ê±´/i,
                        /ì´\s*ì‹ ê³ \s*ê±´ìˆ˜.*?(\d+(?:,\d+)*)/i
                    ];
                    
                    for (const pattern of patterns) {
                        const match = line.match(pattern);
                        if (match && match[1]) {
                            const numStr = match[1].replace(/,/g, '');
                            if (numStr && !isNaN(parseInt(numStr))) {
                                reportData.reports.total = parseInt(numStr);
                                console.log('ì´ ì‹ ê³  ê±´ìˆ˜ íŒŒì‹±ë¨:', reportData.reports.total, 'ì›ë³¸ ë¼ì¸:', line);
                                break;
                            }
                        }
                    }
                } else if (line.includes('ëŒ€ê¸°ì¤‘') && (line.includes('ê±´') || /\d+/.test(line))) {
                    const match = line.match(/(\d+(?:,\d+)*)\s*ê±´/);
                    if (match) {
                        reportData.reports.pending = parseInt(match[1].replace(/,/g, ''));
                        console.log('ëŒ€ê¸°ì¤‘ íŒŒì‹±ë¨:', reportData.reports.pending);
                    }
                } else if (line.includes('ì²˜ë¦¬ì™„ë£Œ') && (line.includes('ê±´') || /\d+/.test(line))) {
                    const match = line.match(/(\d+(?:,\d+)*)\s*ê±´/);
                    if (match) {
                        reportData.reports.completed = parseInt(match[1].replace(/,/g, ''));
                        console.log('ì²˜ë¦¬ì™„ë£Œ íŒŒì‹±ë¨:', reportData.reports.completed);
                    }
                } else if (line.includes('ê±°ë¶€ë¨') && (line.includes('ê±´') || /\d+/.test(line))) {
                    const match = line.match(/(\d+(?:,\d+)*)\s*ê±´/);
                    if (match) {
                        reportData.reports.rejected = parseInt(match[1].replace(/,/g, ''));
                        console.log('ê±°ë¶€ë¨ íŒŒì‹±ë¨:', reportData.reports.rejected);
                    }
                } else if (line.includes('ì‹ ê·œ ì ‘ìˆ˜') && (line.includes('ê±´') || /\d+/.test(line))) {
                    const match = line.match(/(\d+(?:,\d+)*)\s*ê±´/);
                    if (match) {
                        reportData.reports.todayNew = parseInt(match[1].replace(/,/g, ''));
                        console.log('ì‹ ê·œ ì ‘ìˆ˜ íŒŒì‹±ë¨:', reportData.reports.todayNew);
                    }
                } else if (line.includes('ì²˜ë¦¬ ì™„ë£Œ') && (line.includes('ê±´') || /\d+/.test(line))) {
                    const match = line.match(/(\d+(?:,\d+)*)\s*ê±´/);
                    if (match) {
                        reportData.reports.todayProcessed = parseInt(match[1].replace(/,/g, ''));
                        console.log('ì²˜ë¦¬ ì™„ë£Œ íŒŒì‹±ë¨:', reportData.reports.todayProcessed);
                    }
                }
                
                // ì´íƒˆë¥  ë°ì´í„° íŒŒì‹± - ë” ìœ ì—°í•œ íŒ¨í„´
                else if (line.includes('ì´íƒˆë¥ ') && line.includes('%')) {
                    const match = line.match(/([\d.]+)%/);
                    if (match) {
                        reportData.churn.rate = parseFloat(match[1]);
                        console.log('ì´íƒˆë¥  íŒŒì‹±ë¨:', reportData.churn.rate);
                    }
                }
                
                // ë¹„ìœ¤ë¦¬/ìŠ¤íŒ¸ ë°ì´í„° íŒŒì‹± - ë” ìœ ì—°í•œ íŒ¨í„´
                else if (line.includes('ê³ ìœ„í—˜') && line.includes('ê±´')) {
                    const match = line.match(/(\d+)\s*ê±´/);
                    if (match) {
                        reportData.ethics.highRisk = parseInt(match[1]);
                        console.log('ê³ ìœ„í—˜ ì½˜í…ì¸  íŒŒì‹±ë¨:', reportData.ethics.highRisk);
                    }
                } else if (line.includes('ìŠ¤íŒ¸') && line.includes('ê±´')) {
                    const match = line.match(/(\d+)\s*ê±´/);
                    if (match) {
                        reportData.ethics.spam = parseInt(match[1]);
                        console.log('ìŠ¤íŒ¸ ê°ì§€ íŒŒì‹±ë¨:', reportData.ethics.spam);
                    }
                } else if (line.includes('ë¶„ì„ëœ') && line.includes('ê±´')) {
                    const match = line.match(/(\d+(?:,\d+)*)\s*ê±´/);
                    if (match) {
                        reportData.ethics.total = parseInt(match[1].replace(/,/g, ''));
                        console.log('ë¶„ì„ëœ ì½˜í…ì¸  íŒŒì‹±ë¨:', reportData.ethics.total);
                    }
                }
            }
            
            // ë””ë²„ê¹…ìš© ë¡œê·¸
            console.log('ì›ë³¸ ë³´ê³ ì„œ í…ìŠ¤íŠ¸:', reportText);
            console.log('íŒŒì‹±ëœ ë³´ê³ ì„œ ë°ì´í„°:', reportData);
            console.log('í…ìŠ¤íŠ¸ ë¼ì¸ë“¤:', lines);
            
            container.innerHTML = `
                <div class="daily-report-container" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 2rem; border-radius: 1rem; color: white; margin-bottom: 1rem;">
                    <div class="report-header" style="text-align: center; margin-bottom: 2rem;">
                        <h1 style="font-size: 2rem; margin-bottom: 0.5rem; font-weight: 700;">ğŸ“‹ ì¼ì¼ ìš´ì˜ ë³´ê³ ì„œ</h1>
                        <p style="font-size: 1.125rem; opacity: 0.9;">${reportData.date}</p>
                    </div>
                    
                    <!-- í•µì‹¬ ì§€í‘œ ìš”ì•½ -->
                    <div class="summary-metrics" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 2rem;">
                        <div class="summary-card" style="background: rgba(255,255,255,0.15); padding: 1.5rem; border-radius: 0.75rem; text-align: center; backdrop-filter: blur(10px);">
                            <div style="font-size: 2rem; margin-bottom: 0.5rem;">ğŸ“¢</div>
                            <div style="font-size: 1.5rem; font-weight: 600; margin-bottom: 0.25rem;">${reportData.reports.total}</div>
                            <div style="opacity: 0.8;">ì´ ì‹ ê³  ê±´ìˆ˜</div>
                        </div>
                        <div class="summary-card" style="background: rgba(255,255,255,0.15); padding: 1.5rem; border-radius: 0.75rem; text-align: center; backdrop-filter: blur(10px);">
                            <div style="font-size: 2rem; margin-bottom: 0.5rem;">â³</div>
                            <div style="font-size: 1.5rem; font-weight: 600; margin-bottom: 0.25rem;">${reportData.reports.pending}</div>
                            <div style="opacity: 0.8;">ëŒ€ê¸°ì¤‘</div>
                        </div>
                        <div class="summary-card" style="background: rgba(255,255,255,0.15); padding: 1.5rem; border-radius: 0.75rem; text-align: center; backdrop-filter: blur(10px);">
                            <div style="font-size: 2rem; margin-bottom: 0.5rem;">ğŸ“ˆ</div>
                            <div style="font-size: 1.5rem; font-weight: 600; margin-bottom: 0.25rem;">${reportData.churn.rate.toFixed(1)}%</div>
                            <div style="opacity: 0.8;">ì´íƒˆë¥ </div>
                        </div>
                        <div class="summary-card" style="background: rgba(255,255,255,0.15); padding: 1.5rem; border-radius: 0.75rem; text-align: center; backdrop-filter: blur(10px);">
                            <div style="font-size: 2rem; margin-bottom: 0.5rem;">ğŸ“¥</div>
                            <div style="font-size: 1.5rem; font-weight: 600; margin-bottom: 0.25rem;">${reportData.reports.todayNew}</div>
                            <div style="opacity: 0.8;">ì˜¤ëŠ˜ ì‹ ê·œ ì ‘ìˆ˜</div>
                        </div>
                    </div>
                </div>
                
                <!-- ìƒì„¸ ì„¹ì…˜ë“¤ -->
                <div class="report-sections" style="display: grid; gap: 1.5rem;">
                    <!-- ì‹ ê³  í˜„í™© ì„¹ì…˜ -->
                    <div class="report-section" style="background: white; padding: 1.5rem; border-radius: 0.75rem; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
                        <div class="section-header" style="display: flex; align-items: center; margin-bottom: 1rem; padding-bottom: 0.75rem; border-bottom: 2px solid #E5E7EB;">
                            <span style="font-size: 1.5rem; margin-right: 0.75rem;">ğŸ“¢</span>
                            <h3 style="font-size: 1.25rem; font-weight: 600; color: #1F2937;">ì‹ ê³  ë° ì²˜ë¦¬ í˜„í™©</h3>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem; margin-bottom: 1rem;">
                            <div class="status-item" style="text-align: center; padding: 1rem; background: #F9FAFB; border-radius: 0.5rem;">
                                <div style="font-size: 1.25rem; font-weight: 600; color: #1F2937;">${reportData.reports.completed}</div>
                                <div style="font-size: 0.875rem; color: #10B981;">âœ… ì²˜ë¦¬ì™„ë£Œ</div>
                            </div>
                            <div class="status-item" style="text-align: center; padding: 1rem; background: #F9FAFB; border-radius: 0.5rem;">
                                <div style="font-size: 1.25rem; font-weight: 600; color: #1F2937;">${reportData.reports.pending}</div>
                                <div style="font-size: 0.875rem; color: #F59E0B;">â³ ëŒ€ê¸°ì¤‘</div>
                            </div>
                            <div class="status-item" style="text-align: center; padding: 1rem; background: #F9FAFB; border-radius: 0.5rem;">
                                <div style="font-size: 1.25rem; font-weight: 600; color: #1F2937;">${reportData.reports.rejected}</div>
                                <div style="font-size: 0.875rem; color: #EF4444;">âŒ ê±°ë¶€ë¨</div>
                            </div>
                        </div>
                        
                        <div class="today-activity" style="background: linear-gradient(135deg, #10B981, #059669); padding: 1rem; border-radius: 0.5rem; color: white;">
                            <h4 style="margin-bottom: 0.75rem; font-weight: 600;">ì˜¤ëŠ˜ì˜ í™œë™</h4>
                            <div style="display: flex; justify-content: space-between;">
                                <span>ğŸ“¥ ì‹ ê·œ ì ‘ìˆ˜: <strong>${reportData.reports.todayNew}ê±´</strong></span>
                                <span>âœ”ï¸ ì²˜ë¦¬ ì™„ë£Œ: <strong>${reportData.reports.todayProcessed}ê±´</strong></span>
                            </div>
                        </div>
                        
                        ${reportData.reports.pending > 10 ? `
                            <div style="margin-top: 1rem; padding: 0.75rem; background: #FEF3C7; border-left: 4px solid #F59E0B; border-radius: 0.375rem;">
                                <div style="color: #92400E; font-weight: 600;">âš ï¸ ì£¼ì˜ì‚¬í•­</div>
                                <div style="color: #78350F; font-size: 0.875rem;">ëŒ€ê¸°ì¤‘ì¸ ì‹ ê³ ê°€ 10ê±´ ì´ìƒì…ë‹ˆë‹¤. ë¹ ë¥¸ ì²˜ë¦¬ê°€ í•„ìš”í•©ë‹ˆë‹¤.</div>
                            </div>
                        ` : ''}
                    </div>
                    
                    <!-- ì´íƒˆë¥  í˜„í™© ì„¹ì…˜ -->
                    <div class="report-section" style="background: white; padding: 1.5rem; border-radius: 0.75rem; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
                        <div class="section-header" style="display: flex; align-items: center; margin-bottom: 1rem; padding-bottom: 0.75rem; border-bottom: 2px solid #E5E7EB;">
                            <span style="font-size: 1.5rem; margin-right: 0.75rem;">ğŸ“ˆ</span>
                            <h3 style="font-size: 1.25rem; font-weight: 600; color: #1F2937;">ì´íƒˆë¥  í˜„í™©</h3>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
                            <div style="text-align: center; padding: 1rem; background: linear-gradient(135deg, #F59E0B, #D97706); border-radius: 0.5rem; color: white;">
                                <div style="font-size: 1.5rem; font-weight: 600; margin-bottom: 0.25rem;">${reportData.churn.rate.toFixed(1)}%</div>
                                <div style="opacity: 0.9;">í˜„ì¬ ì´íƒˆë¥ </div>
                            </div>
                            <div style="text-align: center; padding: 1rem; background: #F9FAFB; border-radius: 0.5rem;">
                                <div style="font-size: 1.25rem; font-weight: 600; color: #1F2937; margin-bottom: 0.25rem;">ì–‘í˜¸</div>
                                <div style="font-size: 0.875rem; color: #6B7280;">ìƒíƒœ í‰ê°€</div>
                            </div>
                        </div>
                        
                        <div style="margin-top: 1rem; padding: 0.75rem; background: #EBF8FF; border-left: 4px solid #3B82F6; border-radius: 0.375rem;">
                            <div style="color: #1E40AF; font-weight: 600; font-size: 0.875rem;">ğŸ’¡ ì¸ì‚¬ì´íŠ¸</div>
                            <div style="color: #1E3A8A; font-size: 0.875rem; margin-top: 0.25rem;">ì´íƒˆë¥ ì´ ì•ˆì •ì ì¸ ìˆ˜ì¤€ì„ ìœ ì§€í•˜ê³  ìˆìŠµë‹ˆë‹¤. ì§€ì†ì ì¸ ëª¨ë‹ˆí„°ë§ì´ í•„ìš”í•©ë‹ˆë‹¤.</div>
                        </div>
                    </div>
                    
                    <!-- ë¹„ìœ¤ë¦¬/ìŠ¤íŒ¸ í˜„í™© ì„¹ì…˜ -->
                    <div class="report-section" style="background: white; padding: 1.5rem; border-radius: 0.75rem; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
                        <div class="section-header" style="display: flex; align-items: center; margin-bottom: 1rem; padding-bottom: 0.75rem; border-bottom: 2px solid #E5E7EB;">
                            <span style="font-size: 1.5rem; margin-right: 0.75rem;">âš ï¸</span>
                            <h3 style="font-size: 1.25rem; font-weight: 600; color: #1F2937;">ë¹„ìœ¤ë¦¬/ìŠ¤íŒ¸ í˜„í™©</h3>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem;">
                            <div style="text-align: center; padding: 1rem; background: #F9FAFB; border-radius: 0.5rem;">
                                <div style="font-size: 1.25rem; font-weight: 600; color: #1F2937;">${reportData.ethics.highRisk}</div>
                                <div style="font-size: 0.875rem; color: #EF4444;">ê³ ìœ„í—˜ ì½˜í…ì¸ </div>
                            </div>
                            <div style="text-align: center; padding: 1rem; background: #F9FAFB; border-radius: 0.5rem;">
                                <div style="font-size: 1.25rem; font-weight: 600; color: #1F2937;">${reportData.ethics.spam}</div>
                                <div style="font-size: 0.875rem; color: #F59E0B;">ìŠ¤íŒ¸ ê°ì§€</div>
                            </div>
                            <div style="text-align: center; padding: 1rem; background: linear-gradient(135deg, #10B981, #059669); border-radius: 0.5rem; color: white;">
                                <div style="font-size: 1.25rem; font-weight: 600;">${(reportData.ethics.highRisk === 0 && reportData.ethics.spam === 0) ? 'ì•ˆì „' : 'ì£¼ì˜'}</div>
                                <div style="font-size: 0.875rem; opacity: 0.9;">ì „ì²´ ìƒíƒœ</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- ì•¡ì…˜ ì•„ì´í…œ ì„¹ì…˜ -->
                    <div class="report-section" style="background: white; padding: 1.5rem; border-radius: 0.75rem; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
                        <div class="section-header" style="display: flex; align-items: center; margin-bottom: 1rem; padding-bottom: 0.75rem; border-bottom: 2px solid #E5E7EB;">
                            <span style="font-size: 1.5rem; margin-right: 0.75rem;">âœ…</span>
                            <h3 style="font-size: 1.25rem; font-weight: 600; color: #1F2937;">ì˜¤ëŠ˜ì˜ ì•¡ì…˜ ì•„ì´í…œ</h3>
                        </div>
                        
                        <div style="space-y: 0.75rem;">
                            ${reportData.reports.pending > 0 ? `
                                <div style="display: flex; align-items: center; padding: 0.75rem; background: #FEF3C7; border-radius: 0.5rem; margin-bottom: 0.75rem;">
                                    <span style="margin-right: 0.75rem; font-size: 1.25rem;">ğŸ”</span>
                                    <div>
                                        <div style="font-weight: 600; color: #92400E;">ëŒ€ê¸°ì¤‘ì¸ ì‹ ê³  ${reportData.reports.pending}ê±´ ê²€í† </div>
                                        <div style="font-size: 0.875rem; color: #78350F;">ìš°ì„ ìˆœìœ„: ë†’ìŒ</div>
                                    </div>
                                </div>
                            ` : ''}
                            
                            <div style="display: flex; align-items: center; padding: 0.75rem; background: #E0F2FE; border-radius: 0.5rem; margin-bottom: 0.75rem;">
                                <span style="margin-right: 0.75rem; font-size: 1.25rem;">ğŸ“Š</span>
                                <div>
                                    <div style="font-weight: 600; color: #0C4A6E;">ì£¼ê°„ íŠ¸ë Œë“œ ë¶„ì„ ë¦¬í¬íŠ¸ ì‘ì„±</div>
                                    <div style="font-size: 0.875rem; color: #075985;">ìš°ì„ ìˆœìœ„: ì¤‘ê°„</div>
                                </div>
                            </div>
                            
                            <div style="display: flex; align-items: center; padding: 0.75rem; background: #F0FDF4; border-radius: 0.5rem;">
                                <span style="margin-right: 0.75rem; font-size: 1.25rem;">ğŸ”„</span>
                                <div>
                                    <div style="font-weight: 600; color: #14532D;">ì‚¬ìš©ì í”¼ë“œë°± ìˆ˜ì§‘ ë° ë¶„ì„</div>
                                    <div style="font-size: 0.875rem; color: #166534;">ìš°ì„ ìˆœìœ„: ë‚®ìŒ</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- ì›ë³¸ ë³´ê³ ì„œ í…ìŠ¤íŠ¸ (ì ‘ì„ ìˆ˜ ìˆëŠ” í˜•íƒœ) -->
                    <div class="report-section" style="background: white; padding: 1.5rem; border-radius: 0.75rem; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
                        <div class="section-header" style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 1rem; padding-bottom: 0.75rem; border-bottom: 2px solid #E5E7EB;">
                            <div style="display: flex; align-items: center;">
                                <span style="font-size: 1.5rem; margin-right: 0.75rem;">ğŸ“„</span>
                                <h3 style="font-size: 1.25rem; font-weight: 600; color: #1F2937;">ìƒì„¸ ë³´ê³ ì„œ</h3>
                            </div>
                            <button onclick="toggleDetailReport()" style="background: #6366F1; color: white; border: none; padding: 0.5rem 1rem; border-radius: 0.375rem; font-size: 0.875rem; cursor: pointer;">
                                ìƒì„¸ ë³´ê¸°
                            </button>
                        </div>
                        
                        <div id="detailReportContent" style="display: none;">
                            <pre style="background: #F9FAFB; padding: 1rem; border-radius: 0.5rem; font-family: 'Courier New', monospace; font-size: 0.875rem; line-height: 1.6; color: #374151; white-space: pre-wrap; overflow-x: auto;">${escapeHtml(reportText)}</pre>
                        </div>
                    </div>
                </div>
            `;
        }
        
        // ìƒì„¸ ë³´ê³ ì„œ í† ê¸€ í•¨ìˆ˜
        function toggleDetailReport() {
            const content = document.getElementById('detailReportContent');
            const button = event.target;
            
            if (content.style.display === 'none') {
                content.style.display = 'block';
                button.textContent = 'ì ‘ê¸°';
            } else {
                content.style.display = 'none';
                button.textContent = 'ìƒì„¸ ë³´ê¸°';
            }
        }

        // ë©”ì‹œì§€ ì „ì†¡
        async function sendMessage() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();
            
            if (!message || isProcessing) return;

            isProcessing = true;
            document.getElementById('chatSendBtn').disabled = true;

            // ë¹ˆ í™”ë©´ ì œê±°
            const messagesContainer = document.getElementById('chatMessages');
            const emptyDiv = messagesContainer.querySelector('.chat-empty');
            if (emptyDiv) {
                emptyDiv.remove();
            }

            // ì‚¬ìš©ì ë©”ì‹œì§€ ì¶”ê°€
            addMessage('user', message);
            input.value = '';
            input.style.height = 'auto';

            // ë´‡ ì‘ë‹µ ìƒì„±
            await generateBotResponse(message);

            isProcessing = false;
            document.getElementById('chatSendBtn').disabled = false;
        }

        // ë©”ì‹œì§€ ì¶”ê°€
        function addMessage(type, content, toolBadge = null, pageUrl = null) {
            const messagesContainer = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${type}`;

            // ë©”íƒ€ë°ì´í„° ì œê±° (ì‚¬ìš©ìì—ê²Œ ë³´ì´ì§€ ì•Šë„ë¡)
            let displayContent = content;
            if (type === 'bot') {
                // ë©”íƒ€ë°ì´í„° íƒœê·¸ ì œê±°
                displayContent = displayContent.replace(/\n*\[BOARD_IDS\]:\s*\[.*?\]/g, '');
                displayContent = displayContent.replace(/\n*\[SEARCH_QUERY\]:\s*.+/g, '');
                displayContent = displayContent.replace(/\n*\[SEARCH_METADATA\]:\s*\{[\s\S]*?\}/g, '');
                displayContent = displayContent.trim();
            }

            // ì¼ì¼ë³´ê³ ì„œ íŠ¹ë³„ ì²˜ë¦¬
            if (type === 'bot' && window.isDailyReport && toolBadge === 'ì¼ì¼ ë³´ê³ ì„œ') {
                // ì¼ì¼ë³´ê³ ì„œ ì „ìš© ë Œë”ë§ ì‚¬ìš©
                const reportContainer = document.createElement('div');
                reportContainer.className = 'message-bubble daily-report-bubble';
                renderDailyReport(displayContent, reportContainer);
                messageDiv.appendChild(reportContainer);
                
                // ë„êµ¬ ë°°ì§€ ìˆ¨ê¹€ (ì¼ì¼ë³´ê³ ì„œëŠ” ë„êµ¬ ë°°ì§€ í‘œì‹œ ì•ˆ í•¨)
                
                // í”Œë˜ê·¸ ë¦¬ì…‹
                window.isDailyReport = false;
            } else {
                // ì¼ë°˜ ë©”ì‹œì§€ ì²˜ë¦¬
                let messageHTML = `
                    <div class="message-bubble">
                        <div class="message-content">${escapeHtml(displayContent)}</div>
                `;

                if (toolBadge) {
                    messageHTML += `<div class="tool-badge">ğŸ› ï¸ ${toolBadge}</div>`;
                }

                if (pageUrl) {
                    const pageName = getPageName(pageUrl);
                    messageHTML += `
                        <a href="${pageUrl}" class="page-action-btn" target="_blank">
                            ğŸ“Š ${pageName} ë°”ë¡œê°€ê¸°
                        </a>
                    `;
                }

                messageHTML += '</div>';
                messageDiv.innerHTML = messageHTML;
            }
            
            messagesContainer.appendChild(messageDiv);
            scrollToBottom();
        }

        // ë´‡ ì‘ë‹µ ìƒì„±
        async function generateBotResponse(userMessage) {
            // ë¡œë”© ë©”ì‹œì§€
            addMessage('bot', 'Agentê°€ ì§ˆë¬¸ì„ ë¶„ì„í•˜ê³  ë‹µë³€ì„ ìƒì„±í•˜ê³  ìˆìŠµë‹ˆë‹¤...', 'LangGraph ì²˜ë¦¬ ì¤‘ â—â—â—');

            try {
                const response = await fetch(`${API_BASE_URL}/api/agent/chat`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        query: userMessage,
                        session_id: sessionId
                    })
                });

                if (!response.ok) {
                    throw new Error('Agent ì‘ë‹µ ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                }

                const data = await response.json();

                // ë¡œë”© ë©”ì‹œì§€ ì œê±°
                const messages = document.getElementById('chatMessages');
                messages.removeChild(messages.lastChild);

                // ë””ë²„ê¹…
                console.log('Agent ì‘ë‹µ ë°ì´í„°:', data);
                console.log('tool_id:', data.tool_id);
                console.log('tool_used:', data.tool_used);
                console.log('action_type:', data.action_type);

                // ë„êµ¬ ì‚¬ìš© ì—¬ë¶€ í™•ì¸
                const hasTool = data.tool_used && 
                               data.tool_used !== 'ì—†ìŒ' &&
                               data.tool_used !== null &&
                               data.tool_used !== undefined;

                if (hasTool) {
                    let actualToolId = data.tool_id;
                    
                    // tool_idê°€ ì—†ìœ¼ë©´ tool_usedì—ì„œ ì—­ë§¤í•‘
                    if (!actualToolId || actualToolId === 'ì—†ìŒ' || actualToolId === null) {
                        const toolNameReverseMap = {
                            'ì˜ë¯¸ ê¸°ë°˜ ê²€ìƒ‰': 'semantic_search_tool',
                            'ì´íƒˆ ë¶„ì„': 'churn_analysis_tool',
                            'ë¹„ìœ¤ë¦¬/ìŠ¤íŒ¸ ë¶„ì„': 'ethics_check_tool',
                            'ì‹ ê³  í†µê³„': 'match_reports_tool',
                            'íŠ¸ë Œë“œ ë¶„ì„': 'trends_analysis_tool',
                            'ì´íƒˆ ë¶„ì„ ì‹¤í–‰': 'execute_churn_analysis_tool',
                            'ë¹„ìœ¤ë¦¬/ìŠ¤íŒ¸ ë¶„ì„ ì‹¤í–‰': 'execute_ethics_analysis_tool',
                            'ì‹ ê³  ìŠ¹ì¸': 'approve_report_tool',
                            'ì‹ ê³  ê±°ë¶€': 'reject_report_tool',
                            'ì¼ì¼ ë³´ê³ ì„œ': 'daily_report_tool'
                        };
                        actualToolId = toolNameReverseMap[data.tool_used] || data.tool_used;
                    }
                    
                    currentToolId = actualToolId;
                    
                    // action_typeì´ executeì¸ ê²½ìš° ì‹¤í–‰ ì²˜ë¦¬
                    if (data.action_type === 'execute' && data.execution_data) {
                        console.log('ì‹¤í–‰ ëª…ë ¹ ì²˜ë¦¬:', data.execution_data);
                        
                        const executionAction = data.execution_data.action;
                        
                        // í•„í„°ë§ ì•¡ì…˜ì¸ ê²½ìš°
                        if (executionAction === 'filter_reports') {
                            console.log('í•„í„°ë§ ì²˜ë¦¬:', data.execution_data.filter_params);
                            
                            // ì™¼ìª½ íŒ¨ë„ì— admin_reports í‘œì‹œ
                            enableSplitView('match_reports_tool', 'auto');
                            
                            // iframe ë¡œë“œ í›„ postMessageë¡œ í•„í„° ì ìš©
                            setTimeout(() => {
                                sendMessageToToolFrame('filter_reports', data.execution_data.filter_params);
                            }, 500);
                            
                            // í•„í„°ë§ ê²°ê³¼ ì¡°íšŒ ë° ìš”ì•½ í‘œì‹œ
                            executeFilterAction(data.execution_data.api_endpoint, data.execution_data.filter_params);
                            
                        } else if (executionAction === 'show_post_detail') {
                            // ê²Œì‹œê¸€ ìƒì„¸ë³´ê¸° ì•¡ì…˜ - iframeì„ ê²Œì‹œê¸€ ìƒì„¸ í˜ì´ì§€ë¡œ ë³€ê²½
                            console.log('[DEBUG] ê²Œì‹œê¸€ ìƒì„¸ë³´ê¸° ì²˜ë¦¬:', executionAction, data.execution_data.params);
                            
                            let postId = data.execution_data.params.post_id;
                            const relativePosition = data.execution_data.params.relative_position;
                            
                            console.log('[DEBUG] postId:', postId, 'relativePosition:', relativePosition);
                            
                            // relative_positionìœ¼ë¡œ postId ì°¾ê¸°
                            if (!postId && relativePosition) {
                                // ìœ„ì¹˜ ë§¤í•‘
                                const positionMap = {
                                    'ì²«ë²ˆì§¸': 0, 'ì²«ì§¸': 0, '1ë²ˆì§¸': 0, 'first': 0,
                                    'ë‘ë²ˆì§¸': 1, 'ë‘˜ì§¸': 1, '2ë²ˆì§¸': 1, 'second': 1,
                                    'ì„¸ë²ˆì§¸': 2, 'ì…‹ì§¸': 2, '3ë²ˆì§¸': 2, 'third': 2,
                                    'ë„¤ë²ˆì§¸': 3, 'ë„·ì§¸': 3, '4ë²ˆì§¸': 3, 'fourth': 3,
                                    'ë‹¤ì„¯ë²ˆì§¸': 4, 'ë‹¤ì„¯ì§¸': 4, '5ë²ˆì§¸': 4, 'fifth': 4,
                                    'ì—¬ì„¯ë²ˆì§¸': 5, 'ì—¬ì„¯ì§¸': 5, '6ë²ˆì§¸': 5, 'sixth': 5,
                                    'ì¼ê³±ë²ˆì§¸': 6, 'ì¼ê³±ì§¸': 6, '7ë²ˆì§¸': 6, 'seventh': 6,
                                    'ì—¬ëŸë²ˆì§¸': 7, 'ì—¬ëŸì§¸': 7, '8ë²ˆì§¸': 7, 'eighth': 7,
                                    'ì•„í™‰ë²ˆì§¸': 8, 'ì•„í™‰ì§¸': 8, '9ë²ˆì§¸': 8, 'ninth': 8,
                                    'ì—´ë²ˆì§¸': 9, 'ì—´ì§¸': 9, '10ë²ˆì§¸': 9, 'tenth': 9
                                };
                                
                                const index = positionMap[relativePosition.toLowerCase()];
                                
                                if (index !== undefined) {
                                    // ê²€ìƒ‰ ê²°ê³¼ì—ì„œ postId ì°¾ê¸°
                                    if (lastSearchData && lastSearchData.post_ids && lastSearchData.post_ids.length > index) {
                                        postId = lastSearchData.post_ids[index];
                                        console.log('[DEBUG] ê²€ìƒ‰ ê²°ê³¼ì—ì„œ postId ì°¾ìŒ:', postId);
                                    } else {
                                        console.log('[DEBUG] ê²€ìƒ‰ ê²°ê³¼ ì—†ìŒ, ê¸°ë³¸ ê²Œì‹œê¸€ ëª©ë¡ì—ì„œ ì°¾ê¸° ìœ„í•´ API í˜¸ì¶œ');
                                        // ì „ì²´ ê²Œì‹œê¸€ ëª©ë¡ì—ì„œ ì°¾ê¸°
                                        fetch('/api/board/posts?page=1&limit=50')
                                            .then(res => res.json())
                                            .then(result => {
                                                if (result.success && result.posts && result.posts.length > index) {
                                                    postId = result.posts[index].id;
                                                    console.log('[DEBUG] ì „ì²´ ëª©ë¡ì—ì„œ postId ì°¾ìŒ:', postId);
                                                    
                                                    // Split view í™œì„±í™” í›„ ìƒì„¸ í˜ì´ì§€ë¡œ ì´ë™
                                                    enableSplitView('semantic_search_tool', 'auto');
                                                    setTimeout(() => {
                                                        const toolFrame = document.getElementById('toolFrame');
                                                        toolFrame.src = `/board/${postId}`;
                                                        console.log('[DEBUG] iframeì„ ê²Œì‹œê¸€ ìƒì„¸ í˜ì´ì§€ë¡œ ë³€ê²½:', `/board/${postId}`);
                                                    }, 500);
                                                } else {
                                                    console.error('[ERROR] ê²Œì‹œê¸€ì„ ì°¾ì„ ìˆ˜ ì—†ìŒ');
                                                    addMessage('bot', `${relativePosition} ê²Œì‹œê¸€ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`);
                                                }
                                            })
                                            .catch(err => {
                                                console.error('[ERROR] API í˜¸ì¶œ ì‹¤íŒ¨:', err);
                                                addMessage('bot', 'ê²Œì‹œê¸€ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                                            });
                                        return; // async ì²˜ë¦¬ì´ë¯€ë¡œ ì—¬ê¸°ì„œ ì¢…ë£Œ
                                    }
                                }
                            }
                            
                            if (postId) {
                                // Split view í™œì„±í™” í›„ ìƒì„¸ í˜ì´ì§€ë¡œ ì´ë™
                                enableSplitView('semantic_search_tool', 'auto');
                                
                                setTimeout(() => {
                                    const toolFrame = document.getElementById('toolFrame');
                                    toolFrame.src = `/board/${postId}`;
                                    console.log('[DEBUG] iframeì„ ê²Œì‹œê¸€ ìƒì„¸ í˜ì´ì§€ë¡œ ë³€ê²½:', `/board/${postId}`);
                                }, 500);
                            } else {
                                console.error('[ERROR] postIdë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ');
                                addMessage('bot', 'ê²Œì‹œê¸€ ID ë˜ëŠ” ìœ„ì¹˜ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                            }
                            
                        } else if (executionAction === 'back_to_list') {
                            // ëª©ë¡ ëŒì•„ê°€ê¸° ì•¡ì…˜ ì²˜ë¦¬
                            console.log('ëª©ë¡ ëŒì•„ê°€ê¸° ì²˜ë¦¬:', executionAction, data.execution_data.params);
                            
                            const requestType = data.execution_data.params.request_type;
                            
                            if (requestType === 'show_search_results' && lastSearchData) {
                                // ì´ì „ ê²€ìƒ‰ ê²°ê³¼ê°€ ìˆìœ¼ë©´ board_search.htmlë¡œ ë³µì›
                                console.log('ê²€ìƒ‰ ê²°ê³¼ ë³µì›:', lastSearchData);
                                enableSplitView('semantic_search_tool', 'auto');
                                
                                setTimeout(() => {
                                    sendBoardCommand('load_search_results', lastSearchData);
                                }, 100);
                                
                            } else if (requestType === 'back_to_list' && lastSearchData) {
                                // ì´ì „ ëª©ë¡ìœ¼ë¡œ ëŒì•„ê°€ê¸° (ê²€ìƒ‰ ê²°ê³¼ê°€ ìˆìœ¼ë©´ ê²€ìƒ‰ ê²°ê³¼ë¡œ)
                                console.log('ì´ì „ ëª©ë¡ìœ¼ë¡œ ëŒì•„ê°€ê¸° (ê²€ìƒ‰ ê²°ê³¼):', lastSearchData);
                                enableSplitView('semantic_search_tool', 'auto');
                                
                                setTimeout(() => {
                                    sendBoardCommand('load_search_results', lastSearchData);
                                }, 100);
                                
                            } else {
                                // ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ê±°ë‚˜ ì¼ë°˜ ê²Œì‹œíŒ ëª©ë¡ ìš”ì²­
                                console.log('ì¼ë°˜ ê²Œì‹œíŒ ëª©ë¡ í‘œì‹œ');
                                enableSplitView('semantic_search_tool', 'auto');
                                
                                setTimeout(() => {
                                    const toolFrame = document.getElementById('toolFrame');
                                    toolFrame.src = '/board';
                                    console.log('ê²Œì‹œíŒ ëª©ë¡ ë¡œë“œ: /board');
                                }, 100);
                            }
                            
                        } else if (executionAction === 'filter_category' || executionAction === 'change_sort' || executionAction === 'navigate_page') {
                            // ê²Œì‹œíŒ ì¡°ì‘ ì•¡ì…˜
                            console.log('ê²Œì‹œíŒ ì¡°ì‘ ì²˜ë¦¬:', executionAction, data.execution_data.params);
                            
                            // ê²Œì‹œíŒì´ ì´ë¯¸ ë¡œë“œë˜ì–´ ìˆëŠ”ì§€ í™•ì¸
                            const toolFrame = document.getElementById('toolFrame');
                            if (toolFrame && toolFrame.src.includes('/board/search')) {
                                // ê²Œì‹œíŒ ëª…ë ¹ ì „ì†¡
                                setTimeout(() => {
                                    if (executionAction === 'filter_category') {
                                        sendBoardCommand('filter_category', { category: data.execution_data.params.category });
                                    } else if (executionAction === 'change_sort') {
                                        sendBoardCommand('change_sort', { sort_by: data.execution_data.params.sort_by });
                                    } else if (executionAction === 'navigate_page') {
                                        sendBoardCommand('navigate_page', { page: data.execution_data.params.page });
                                    }
                                }, 100);
                            } else {
                                // ê²Œì‹œíŒì´ ë¡œë“œë˜ì§€ ì•Šì€ ê²½ìš° ì•ˆë‚´
                                addMessage('bot', 'ë¨¼ì € ê²Œì‹œíŒì„ ê²€ìƒ‰í•˜ê±°ë‚˜ í‘œì‹œí•´ì£¼ì„¸ìš”.');
                            }
                            
                        } else {
                            // ë¶„ì„ ë˜ëŠ” ì‹ ê³  ì²˜ë¦¬ ì•¡ì…˜
                            // ì•¡ì…˜ íƒ€ì… íŒë‹¨
                            const isReportAction = actualToolId === 'approve_report_tool' || actualToolId === 'reject_report_tool';
                            const isChurnAnalysis = actualToolId === 'execute_churn_analysis_tool' || actualToolId === 'churn_analysis_tool';
                            const isEthicsAnalysis = actualToolId === 'execute_ethics_analysis_tool';
                            const actionType = isReportAction ? 'report_action' : 'analysis';
                            
                            // ì™¼ìª½ íŒ¨ë„ ì„¤ì •
                            if (isReportAction) {
                                // ì‹ ê³  ì²˜ë¦¬ì¸ ê²½ìš° ì™¼ìª½ì— ì‹ ê³  ëª©ë¡, ì˜¤ë¥¸ìª½ì— ì²˜ë¦¬ ê²°ê³¼
                                enableSplitView('match_reports_tool', 'auto');
                                // ì˜¤ë¥¸ìª½ ë¶„ì„ ê²°ê³¼ íŒ¨ë„ í™œì„±í™”
                                enableSplitView(data.execution_data.tool_id || actualToolId, 'analysis');
                            } else if (isChurnAnalysis) {
                                // ì´íƒˆë¥  ë¶„ì„ ì‹¤í–‰ì¸ ê²½ìš° ì™¼ìª½ì— ë¶„ì„ ê²°ê³¼ë§Œ í‘œì‹œ
                                enableSplitView('churn_analysis_tool', 'analysis');
                                // executeActionì—ì„œ analysisResultPanelì— ë Œë”ë§
                            } else if (isEthicsAnalysis) {
                                // ë¹„ìœ¤ë¦¬ ë¶„ì„ì¸ ê²½ìš° ì™¼ìª½ì— ë¹„ìœ¤ë¦¬ ëŒ€ì‹œë³´ë“œ, ì˜¤ë¥¸ìª½ì— ê²°ê³¼
                                enableSplitView('ethics_check_tool', 'auto');
                                enableSplitView(data.execution_data.tool_id || actualToolId, 'analysis');
                            }
                            
                            // API í˜¸ì¶œ ì‹¤í–‰
                            executeAction(data.execution_data.api_endpoint, data.execution_data.params, actionType);
                        }
                        
                    } else {
                        // ì¡°íšŒ ëª¨ë“œ
                        console.log('Split view í™œì„±í™” (ì¡°íšŒ):', actualToolId);
                        
                        // semantic_search_toolì€ ì™¼ìª½ íŒ¨ë„ì— ê²Œì‹œíŒ í‘œì‹œ
                        if (actualToolId === 'semantic_search_tool') {
                            enableSplitView(actualToolId, 'auto');
                            
                            // ê²€ìƒ‰ ê²°ê³¼ì—ì„œ ê²Œì‹œê¸€ ID, ê²€ìƒ‰ì–´, ë©”íƒ€ë°ì´í„° ì¶”ì¶œ
                            const boardIds = extractBoardIds(data.answer);
                            const searchQuery = extractSearchQuery(data.answer);
                            const searchMetadata = extractSearchMetadata(data.answer);
                            
                            console.log('[DEBUG] ì¶”ì¶œëœ board_ids:', boardIds);
                            console.log('[DEBUG] ì¶”ì¶œëœ search_query:', searchQuery);
                            console.log('[DEBUG] ì¶”ì¶œëœ search_metadata:', searchMetadata);
                            console.log('[DEBUG] Agent ì‘ë‹µ:', data.answer);
                            
                            // ê²€ìƒ‰ ìƒíƒœ ì €ì¥ (ëª©ë¡ ëŒì•„ê°€ê¸°ìš©)
                            lastSearchData = {
                                post_ids: boardIds,
                                search_query: searchQuery,
                                search_metadata: searchMetadata
                            };
                            console.log('[DEBUG] ê²€ìƒ‰ ìƒíƒœ ì €ì¥:', lastSearchData);
                            
                            // iframe ë¡œë“œ í›„ ê²€ìƒ‰ ê²°ê³¼ ì „ë‹¬
                            setTimeout(() => {
                                console.log('[DEBUG] sendBoardCommand í˜¸ì¶œ ì‹œë„');
                                sendBoardCommand('load_search_results', {
                                    post_ids: boardIds,
                                    search_query: searchQuery,
                                    search_metadata: searchMetadata
                                });
                            }, 1000);
                        } else if (actualToolId === 'daily_report_tool') {
                            // ì¼ì¼ ë³´ê³ ì„œ ë„êµ¬ëŠ” ë‹¨ì¼ íŒ¨ë„ ìœ ì§€ (ë„êµ¬ ë¯¸ì‚¬ìš© UI)
                            console.log('ì¼ì¼ ë³´ê³ ì„œ ë„êµ¬ - ë‹¨ì¼ íŒ¨ë„ ìœ ì§€');
                            disableSplitView();
                            
                            // ì¼ì¼ ë³´ê³ ì„œ íŠ¹ë³„ ë Œë”ë§ í”Œë˜ê·¸ ì„¤ì •
                            window.isDailyReport = true;
                        } else {
                            // ë‹¤ë¥¸ ë„êµ¬ëŠ” iframe
                            enableSplitView(actualToolId, 'auto');
                        }
                    }
                } else {
                    // ë„êµ¬ë¥¼ ì‚¬ìš©í•˜ì§€ ì•Šìœ¼ë©´ ë‹¨ì¼ íŒ¨ë„ ìœ ì§€
                    console.log('ë‹¨ì¼ íŒ¨ë„ ìœ ì§€ (ë„êµ¬ ë¯¸ì‚¬ìš©)');
                    disableSplitView();
                }

                // ìµœì¢… ì‘ë‹µ ì¶”ê°€
                addMessage('bot', data.answer, data.tool_used, data.page_url);

            } catch (error) {
                console.error('Agent ì‘ë‹µ ì˜¤ë¥˜:', error);
                
                // ë¡œë”© ë©”ì‹œì§€ ì œê±°
                const messages = document.getElementById('chatMessages');
                messages.removeChild(messages.lastChild);

                addMessage('bot', `âš ï¸ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ${error.message}\n\nì„œë²„ê°€ ì‹¤í–‰ ì¤‘ì¸ì§€ í™•ì¸í•˜ê³  OpenAI API í‚¤ê°€ ì˜¬ë°”ë¥¸ì§€ í™•ì¸í•´ì£¼ì„¸ìš”.`);
                disableSplitView();
            }
        }

        // renderSearchResults, parseSearchResults, openPostDetail í•¨ìˆ˜ ì œê±°ë¨
        // ê²€ìƒ‰ ê²°ê³¼ëŠ” ì™¼ìª½ board_search.htmlì—ì„œ ì²˜ë¦¬

        // HTML ì´ìŠ¤ì¼€ì´í”„
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        // ê²€ìƒ‰ ê²°ê³¼ì—ì„œ ê²Œì‹œê¸€ ID ëª©ë¡ ì¶”ì¶œ
        function extractBoardIds(answer) {
            try {
                console.log('[DEBUG] extractBoardIds í˜¸ì¶œ, answer ê¸¸ì´:', answer.length);
                
                // ë°©ë²• 1: [BOARD_IDS]: [1,2,3] í˜•ì‹
                const match = answer.match(/\[BOARD_IDS\]:\s*(\[.*?\])/);
                if (match) {
                    console.log('[DEBUG] BOARD_IDS íŒ¨í„´ ë§¤ì¹­ ì„±ê³µ:', match[1]);
                    const ids = JSON.parse(match[1]);
                    console.log('[DEBUG] íŒŒì‹±ëœ IDs:', ids);
                    return ids;
                }
                
                // ë°©ë²• 2: ì‘ë‹µì—ì„œ ìˆ«ì ID ì¶”ì¶œ ì‹œë„ (fallback)
                console.log('[DEBUG] BOARD_IDS íŒ¨í„´ ë§¤ì¹­ ì‹¤íŒ¨, fallback ì‹œë„');
                const idMatches = answer.match(/ê²Œì‹œê¸€\s+ID:\s*(\d+)/g);
                if (idMatches) {
                    const ids = idMatches.map(m => parseInt(m.match(/\d+/)[0]));
                    console.log('[DEBUG] Fallbackìœ¼ë¡œ ì¶”ì¶œëœ IDs:', ids);
                    return ids;
                }
                
                console.warn('[WARN] board_ids ì¶”ì¶œ ì‹¤íŒ¨');
                return [];
            } catch (e) {
                console.error('[ERROR] ê²Œì‹œê¸€ ID ì¶”ì¶œ ì‹¤íŒ¨:', e);
                return [];
            }
        }
        
        // ê²€ìƒ‰ ê²°ê³¼ì—ì„œ ê²€ìƒ‰ì–´ ì¶”ì¶œ
        function extractSearchQuery(answer) {
            try {
                const match = answer.match(/\[SEARCH_QUERY\]:\s*(.+)/);
                if (match) {
                    return match[1].trim();
                }
                return '';
            } catch (e) {
                console.error('ê²€ìƒ‰ì–´ ì¶”ì¶œ ì‹¤íŒ¨:', e);
                return '';
            }
        }
        
        // ê²€ìƒ‰ ê²°ê³¼ì—ì„œ ë©”íƒ€ë°ì´í„° ì¶”ì¶œ
        function extractSearchMetadata(answer) {
            try {
                // ë©€í‹°ë¼ì¸ ë§¤ì¹­ ì§€ì› ([\s\S]ëŠ” ê³µë°± í¬í•¨ ëª¨ë“  ë¬¸ì)
                const match = answer.match(/\[SEARCH_METADATA\]:\s*(\{[\s\S]*?\})/);
                if (match) {
                    console.log('[DEBUG] SEARCH_METADATA íŒ¨í„´ ë§¤ì¹­ ì„±ê³µ:', match[1]);
                    const metadata = JSON.parse(match[1]);
                    console.log('[DEBUG] íŒŒì‹±ëœ ë©”íƒ€ë°ì´í„°:', metadata);
                    return metadata;
                }
                
                console.log('[DEBUG] SEARCH_METADATA íŒ¨í„´ ë§¤ì¹­ ì‹¤íŒ¨');
                return {};
            } catch (e) {
                console.error('[ERROR] ê²€ìƒ‰ ë©”íƒ€ë°ì´í„° ì¶”ì¶œ ì‹¤íŒ¨:', e);
                return {};
            }
        }
        
        // ì´íƒˆë¥  ë¶„ì„ ê²°ê³¼ì—ì„œ ë°ì´í„° ì¶”ì¶œ
        function extractChurnAnalysisData(answer) {
            try {
                console.log('[DEBUG] extractChurnAnalysisData í˜¸ì¶œ, answer ê¸¸ì´:', answer.length);
                
                // CHURN_ANALYSIS_RESULT: ì ‘ë‘ì‚¬ë¡œ JSON ë°ì´í„° ì¶”ì¶œ
                const match = answer.match(/CHURN_ANALYSIS_RESULT:\s*(\{[\s\S]*?\})(?:\n|$)/);
                if (match) {
                    console.log('[DEBUG] CHURN_ANALYSIS_RESULT íŒ¨í„´ ë§¤ì¹­ ì„±ê³µ:', match[1]);
                    const churnData = JSON.parse(match[1]);
                    console.log('[DEBUG] íŒŒì‹±ëœ ì´íƒˆë¥  ë¶„ì„ ë°ì´í„°:', churnData);
                    return churnData;
                }
                
                console.log('[DEBUG] CHURN_ANALYSIS_RESULT íŒ¨í„´ ë§¤ì¹­ ì‹¤íŒ¨');
                return null;
            } catch (e) {
                console.error('[ERROR] ì´íƒˆë¥  ë¶„ì„ ë°ì´í„° ì¶”ì¶œ ì‹¤íŒ¨:', e);
                return null;
            }
        }
        
        // í•„í„°ë§ ì‹¤í–‰ í•¨ìˆ˜
        async function executeFilterAction(endpoint, filterParams) {
            console.log('executeFilterAction í˜¸ì¶œ:', endpoint, filterParams);
            
            const analysisResultPanel = document.getElementById('analysisResultPanel');
            
            // ë¡œë”© í‘œì‹œ
            analysisResultPanel.innerHTML = `
                <div class="analysis-loading">
                    <div class="analysis-loading-spinner"></div>
                    <div class="analysis-loading-text">í•„í„°ë§ ì¤‘ì…ë‹ˆë‹¤...</div>
                </div>
            `;
            
            try {
                // API íŒŒë¼ë¯¸í„° êµ¬ì„±
                const params = new URLSearchParams({ 
                    page: 1, 
                    limit: 100  // ì „ì²´ í†µê³„ë¥¼ ìœ„í•´ ë§ì´ ê°€ì ¸ì˜¤ê¸°
                });
                
                if (filterParams.status) {
                    params.append('status_filter', filterParams.status);
                }
                if (filterParams.type) {
                    params.append('type_filter', filterParams.type);
                }
                
                const response = await fetch(`${API_BASE_URL}${endpoint}?${params}`);
                
                if (!response.ok) {
                    throw new Error(`API ìš”ì²­ ì‹¤íŒ¨: ${response.status}`);
                }
                
                const data = await response.json();
                console.log('í•„í„°ë§ ê²°ê³¼:', data);
                
                // ê²°ê³¼ ë Œë”ë§
                renderFilterResult(data, filterParams);
                
            } catch (error) {
                console.error('í•„í„°ë§ ì˜¤ë¥˜:', error);
                analysisResultPanel.innerHTML = `
                    <div class="analysis-loading">
                        <div class="analysis-loading-text" style="color: #EF4444;">
                            âš ï¸ í•„í„°ë§ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.<br>
                            ${error.message}
                        </div>
                    </div>
                `;
            }
        }
        
        // í•„í„°ë§ ê²°ê³¼ ë Œë”ë§
        function renderFilterResult(data, filterParams) {
            const analysisResultPanel = document.getElementById('analysisResultPanel');
            
            if (!data.success || !data.reports) {
                analysisResultPanel.innerHTML = `
                    <div class="analysis-content show">
                        <div class="analysis-header">
                            <h2>ğŸ“‹ í•„í„°ë§ ê²°ê³¼</h2>
                        </div>
                        <div style="padding: 2rem; text-align: center; color: #6B7280;">
                            ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.
                        </div>
                    </div>
                `;
                return;
            }
            
            const reports = data.reports;
            const pagination = data.pagination || {};
            
            // ìƒíƒœëª… ë³€í™˜
            const statusDisplayMap = {
                'pending': 'ëŒ€ê¸°ì¤‘',
                'approved': 'ìŠ¹ì¸',
                'rejected': 'ê±°ë¶€',
                '': 'ì „ì²´'
            };
            
            const currentStatusDisplay = statusDisplayMap[filterParams.status || ''] || 'ì „ì²´';
            
            // ìƒíƒœë³„ í†µê³„ ê³„ì‚°
            const statusCount = {
                pending: 0,
                approved: 0,
                rejected: 0
            };
            
            reports.forEach(report => {
                if (statusCount.hasOwnProperty(report.status)) {
                    statusCount[report.status]++;
                }
            });
            
            // íƒ€ì…ë³„ í†µê³„
            const typeCount = {
                board: reports.filter(r => r.report_type === 'board').length,
                comment: reports.filter(r => r.report_type === 'comment').length
            };
            
            let html = `
                <div class="analysis-content show">
                    <div class="analysis-header">
                        <h2>ğŸ“‹ ì‹ ê³  í•„í„°ë§ ê²°ê³¼</h2>
                        <div style="font-size: 0.875rem; color: #6B7280; margin-top: 0.5rem;">
                            í•„í„°: ${currentStatusDisplay}
                        </div>
                    </div>
                    
                    <div style="padding: 1.5rem;">
                        <!-- ì „ì²´ ìš”ì•½ -->
                        <div style="background: #F9FAFB; border-radius: 0.75rem; padding: 1.5rem; margin-bottom: 1.5rem;">
                            <div style="font-weight: 600; font-size: 1.125rem; color: #1F2937; margin-bottom: 1rem;">
                                ğŸ“Š í†µê³„ ìš”ì•½
                            </div>
                            
                            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem; margin-bottom: 1rem;">
                                <div style="background: white; padding: 1rem; border-radius: 0.5rem; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                                    <div style="font-size: 0.875rem; color: #6B7280; margin-bottom: 0.25rem;">í•„í„°ë§ëœ ì‹ ê³ </div>
                                    <div style="font-size: 1.875rem; font-weight: 700; color: #2563EB;">${reports.length}ê±´</div>
                                </div>
                                <div style="background: white; padding: 1rem; border-radius: 0.5rem; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                                    <div style="font-size: 0.875rem; color: #6B7280; margin-bottom: 0.25rem;">ì „ì²´ ì‹ ê³ </div>
                                    <div style="font-size: 1.875rem; font-weight: 700; color: #1F2937;">${pagination.total || reports.length}ê±´</div>
                                </div>
                            </div>
                            
                            <!-- ìƒíƒœë³„ ë¶„í¬ -->
                            <div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid #E5E7EB;">
                                <div style="font-weight: 600; color: #1F2937; margin-bottom: 0.75rem;">ìƒíƒœë³„ ë¶„í¬</div>
                                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 0.75rem;">
                                    <div style="text-align: center; padding: 0.75rem; background: #FEF3C7; border-radius: 0.5rem;">
                                        <div style="font-size: 0.75rem; color: #92400E; margin-bottom: 0.25rem;">ëŒ€ê¸°ì¤‘</div>
                                        <div style="font-size: 1.25rem; font-weight: 700; color: #D97706;">${statusCount.pending}ê±´</div>
                                    </div>
                                    <div style="text-align: center; padding: 0.75rem; background: #D1FAE5; border-radius: 0.5rem;">
                                        <div style="font-size: 0.75rem; color: #065F46; margin-bottom: 0.25rem;">ìŠ¹ì¸</div>
                                        <div style="font-size: 1.25rem; font-weight: 700; color: #10B981;">${statusCount.approved}ê±´</div>
                                    </div>
                                    <div style="text-align: center; padding: 0.75rem; background: #FEE2E2; border-radius: 0.5rem;">
                                        <div style="font-size: 0.75rem; color: #991B1B; margin-bottom: 0.25rem;">ê±°ë¶€</div>
                                        <div style="font-size: 1.25rem; font-weight: 700; color: #EF4444;">${statusCount.rejected}ê±´</div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- íƒ€ì…ë³„ ë¶„í¬ -->
                            <div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid #E5E7EB;">
                                <div style="font-weight: 600; color: #1F2937; margin-bottom: 0.75rem;">íƒ€ì…ë³„ ë¶„í¬</div>
                                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 0.75rem;">
                                    <div style="display: flex; justify-content: space-between; padding: 0.5rem; background: white; border-radius: 0.5rem;">
                                        <span style="color: #6B7280; font-size: 0.875rem;">ğŸ“„ ê²Œì‹œê¸€</span>
                                        <span style="font-weight: 600; color: #1F2937;">${typeCount.board}ê±´</span>
                                    </div>
                                    <div style="display: flex; justify-content: space-between; padding: 0.5rem; background: white; border-radius: 0.5rem;">
                                        <span style="color: #6B7280; font-size: 0.875rem;">ğŸ’¬ ëŒ“ê¸€</span>
                                        <span style="font-weight: 600; color: #1F2937;">${typeCount.comment}ê±´</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- ì•ˆë‚´ ë©”ì‹œì§€ -->
                        <div style="padding: 1rem; background: #EFF6FF; border-left: 4px solid #2563EB; border-radius: 0.5rem;">
                            <div style="color: #1E40AF; font-size: 0.875rem;">
                                ğŸ’¡ ì™¼ìª½ íŒ¨ë„ì—ì„œ í•„í„°ë§ëœ ì‹ ê³  ëª©ë¡ì„ í™•ì¸í•˜ê³  ì§ì ‘ ì²˜ë¦¬í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            analysisResultPanel.innerHTML = html;
        }

        // í˜ì´ì§€ ì´ë¦„ ë§¤í•‘
        function getPageName(url) {
            const pageNames = {
                '/churn': 'ì´íƒˆ ë¶„ì„ ëŒ€ì‹œë³´ë“œ',
                '/ethics_dashboard': 'ë¹„ìœ¤ë¦¬/ìŠ¤íŒ¸ ëŒ€ì‹œë³´ë“œ',
                '/ethics_analyze': 'ë¹„ìœ¤ë¦¬/ìŠ¤íŒ¸ ë¶„ì„',
                '/reports': 'ì‹ ê³  ë¶„ë¥˜',
                '/trends': 'íŠ¸ë Œë“œ ë¶„ì„'
            };
            return pageNames[url] || 'ìƒì„¸ í˜ì´ì§€';
        }

        // ëŒ€í™” ì´ˆê¸°í™”
        async function resetChat() {
            if (confirm('ëŒ€í™” ë‚´ì—­ì„ ëª¨ë‘ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                try {
                    await fetch(`${API_BASE_URL}/api/agent/session/${sessionId}`, {
                        method: 'DELETE'
                    });
                } catch (error) {
                    console.error('ì„¸ì…˜ ì´ˆê¸°í™” ì‹¤íŒ¨:', error);
                }

                sessionId = generateSessionId();
                disableSplitView();

                const messagesContainer = document.getElementById('chatMessages');
                messagesContainer.innerHTML = `
                    <div class="chat-empty">
                        <div class="chat-empty-icon">ğŸ’¬</div>
                        <div class="chat-empty-text">
                            ëŒ€í™”ê°€ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.<br>ìƒˆë¡œìš´ ì§ˆë¬¸ì„ í•´ì£¼ì„¸ìš”.
                        </div>
                    </div>
                `;
                scrollToBottom();
            }
        }

        // ìŠ¤í¬ë¡¤
        function scrollToBottom() {
            const messagesContainer = document.getElementById('chatMessages');
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }
    </script>
</body>
</html>
