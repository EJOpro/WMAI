{% extends "base.html" %}

{% block title %}이탈 징후 관리자 대시보드 - Community Admin{% endblock %}

{% block extra_css %}
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
<style>
.risk-dashboard {
    padding: 20px;
    max-width: 1200px;
    margin: 0 auto;
}

.dashboard-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 30px;
    padding-bottom: 20px;
    border-bottom: 2px solid #e0e0e0;
}

.dashboard-header h1 {
    margin: 0;
    color: #333;
    display: flex;
    align-items: center;
    gap: 10px;
    font-size: 1.8em;
}

.stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
    gap: 20px;
    margin-bottom: 30px;
}

.stat-card {
    background: white;
    border-radius: 12px;
    padding: 25px;
    box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    text-align: center;
    border: 1px solid #e0e0e0;
    transition: transform 0.2s;
}

.stat-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 12px rgba(0,0,0,0.15);
}

.stat-card .stat-icon {
    font-size: 2.5em;
    margin-bottom: 15px;
}

.stat-card .stat-value {
    font-size: 2.2em;
    font-weight: bold;
    margin: 10px 0;
}

.stat-card .stat-label {
    color: #666;
    font-size: 0.9em;
    font-weight: 500;
}

.stat-card.total .stat-value { color: #007bff; }
.stat-card.high .stat-value { color: #dc3545; }
.stat-card.medium .stat-value { color: #ffc107; }
.stat-card.average .stat-value { color: #28a745; }

.risk-users-container {
    background: white;
    border-radius: 12px;
    padding: 25px;
    box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    border: 1px solid #e0e0e0;
}

.section-header {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-bottom: 25px;
    font-size: 1.3em;
    color: #333;
}

.user-card {
    border: 1px solid #e0e0e0;
    border-radius: 10px;
    padding: 20px;
    margin-bottom: 20px;
    transition: all 0.3s;
    background: #fafafa;
}

.user-card:hover {
    transform: translateY(-3px);
    box-shadow: 0 6px 15px rgba(0,0,0,0.1);
}

.user-card.high-risk {
    border-left: 5px solid #dc3545;
    background: #fff5f5;
}

.user-card.medium-risk {
    border-left: 5px solid #ffc107;
    background: #fffbf0;
}

.user-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 15px;
}

.user-info h3 {
    margin: 0;
    color: #333;
    display: flex;
    align-items: center;
    gap: 8px;
}

.user-info small {
    color: #666;
    display: block;
    margin-top: 5px;
}

.risk-badge {
    padding: 6px 16px;
    border-radius: 20px;
    font-weight: bold;
    font-size: 0.85em;
    text-transform: uppercase;
}

.risk-badge.HIGH {
    background: #dc3545;
    color: white;
}

.risk-badge.MEDIUM {
    background: #ffc107;
    color: #333;
}

.risk-score {
    font-size: 1.4em;
    font-weight: bold;
    margin-top: 8px;
}

.evidence-section {
    background: #f8f9fa;
    padding: 15px;
    border-radius: 8px;
    margin: 15px 0;
    border-left: 4px solid #007bff;
}

.evidence-section h4 {
    margin: 0 0 10px 0;
    color: #333;
    font-size: 0.95em;
    display: flex;
    align-items: center;
    gap: 8px;
}

.evidence-list {
    margin: 0;
    padding-left: 20px;
}

.evidence-list li {
    margin: 8px 0;
    color: #555;
    font-style: italic;
}

.info-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin: 12px 0;
    padding: 8px 0;
    border-bottom: 1px solid #eee;
}

.info-row:last-child {
    border-bottom: none;
}

.action-section {
    background: #e7f3ff;
    padding: 15px;
    border-radius: 8px;
    margin: 15px 0;
    border-left: 4px solid #17a2b8;
}

.action-section h4 {
    margin: 0 0 8px 0;
    color: #333;
    font-size: 0.95em;
    display: flex;
    align-items: center;
    gap: 8px;
}

.feedback-buttons {
    display: flex;
    gap: 12px;
    margin-top: 20px;
    padding-top: 15px;
    border-top: 1px solid #eee;
}

.btn-feedback {
    padding: 10px 24px;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    font-weight: 600;
    font-size: 0.9em;
    transition: all 0.3s;
    display: flex;
    align-items: center;
    gap: 8px;
}

.btn-confirm {
    background: #28a745;
    color: white;
}

.btn-confirm:hover {
    background: #218838;
    transform: translateY(-1px);
}

.btn-deny {
    background: #6c757d;
    color: white;
}

.btn-deny:hover {
    background: #5a6268;
    transform: translateY(-1px);
}

.loading {
    text-align: center;
    padding: 60px 20px;
    color: #666;
}

.refresh-btn {
    padding: 12px 24px;
    background: #007bff;
    color: white;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    font-size: 1em;
    font-weight: 600;
    display: flex;
    align-items: center;
    gap: 8px;
    transition: all 0.3s;
}

.refresh-btn:hover {
    background: #0056b3;
    transform: translateY(-1px);
}

.demo-notice {
    background: #fff3cd;
    border: 1px solid #ffeaa7;
    border-radius: 8px;
    padding: 15px;
    margin-bottom: 25px;
    display: flex;
    align-items: center;
    gap: 10px;
}

.demo-notice i {
    color: #856404;
    font-size: 1.2em;
}

@keyframes slideIn {
    from { transform: translateX(100%); opacity: 0; }
    to { transform: translateX(0); opacity: 1; }
}

@keyframes slideOut {
    from { transform: translateX(0); opacity: 1; }
    to { transform: translateX(100%); opacity: 0; }
}
</style>
{% endblock %}

{% block content %}
<div class="risk-dashboard">
    <!-- 실제 연동 안내 -->
    <div class="demo-notice" style="background: #d4edda; border-color: #c3e6cb;">
        <i class="fas fa-check-circle" style="color: #155724;"></i>
        <div style="color: #155724;">
            <strong>실시간 연동</strong> - RAG 파이프라인과 실시간으로 연동되어 실제 LLM 분석 결과를 표시합니다.
        </div>
    </div>

    <div class="dashboard-header">
        <h1>
            <i class="fas fa-exclamation-triangle" style="color: #dc3545;"></i>
            이탈 징후 관리자 대시보드
        </h1>
        <button class="refresh-btn" onclick="loadRiskUsers()">
            <i class="fas fa-sync-alt"></i>
            새로고침
        </button>
    </div>

    <!-- 통계 카드 -->
    <div class="stats-grid">
        <div class="stat-card total">
            <div class="stat-icon">
                <i class="fas fa-users" style="color: #007bff;"></i>
            </div>
            <div class="stat-value" id="totalUsers">-</div>
            <div class="stat-label">총 감지된 사용자</div>
        </div>
        <div class="stat-card high">
            <div class="stat-icon">
                <i class="fas fa-exclamation-circle" style="color: #dc3545;"></i>
            </div>
            <div class="stat-value" id="highRiskUsers">-</div>
            <div class="stat-label">고위험 사용자</div>
        </div>
        <div class="stat-card medium">
            <div class="stat-icon">
                <i class="fas fa-exclamation-triangle" style="color: #ffc107;"></i>
            </div>
            <div class="stat-value" id="mediumRiskUsers">-</div>
            <div class="stat-label">중위험 사용자</div>
        </div>
        <div class="stat-card average">
            <div class="stat-icon">
                <i class="fas fa-chart-line" style="color: #28a745;"></i>
            </div>
            <div class="stat-value" id="avgRiskScore">-</div>
            <div class="stat-label">평균 위험도</div>
        </div>
    </div>

    <!-- 고위험 사용자 리스트 -->
    <div class="risk-users-container">
        <div class="section-header">
            <i class="fas fa-list"></i>
            고위험 사용자 목록
        </div>
        <div id="loadingMessage" class="loading">
            <i class="fas fa-spinner fa-spin" style="font-size: 2em; color: #007bff;"></i>
            <p style="margin-top: 15px;">데이터 로딩 중...</p>
        </div>
        <div id="usersList"></div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// 페이지 로드 시 자동으로 데이터 불러오기
document.addEventListener('DOMContentLoaded', function() {
    loadRiskUsers();
    
    // 5분마다 자동 새로고침
    setInterval(loadRiskUsers, 5 * 60 * 1000);
});

// 고위험 사용자 목록 불러오기
async function loadRiskUsers() {
    const loadingEl = document.getElementById('loadingMessage');
    const usersListEl = document.getElementById('usersList');
    
    loadingEl.style.display = 'block';
    usersListEl.innerHTML = '';
    
    try {
        console.log('API 호출 시작...');
        const response = await fetch('/api/risk/top?limit=10');
        
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const data = await response.json();
        console.log('받은 데이터:', data);
        
        // 통계 업데이트
        document.getElementById('totalUsers').textContent = data.summary.total_users;
        document.getElementById('highRiskUsers').textContent = data.summary.high_priority_count;
        document.getElementById('mediumRiskUsers').textContent = data.summary.medium_priority_count;
        document.getElementById('avgRiskScore').textContent = data.summary.avg_risk_score.toFixed(2);
        
        // 사용자 카드 생성
        if (data.users && data.users.length > 0) {
            loadingEl.style.display = 'none';
            data.users.forEach(user => {
                const userCard = createUserCard(user);
                usersListEl.appendChild(userCard);
            });
        } else {
            loadingEl.innerHTML = '<p>감지된 고위험 사용자가 없습니다.</p>';
        }
    } catch (error) {
        console.error('Error loading risk users:', error);
        loadingEl.innerHTML = `
            <div style="color: #dc3545; text-align: center;">
                <i class="fas fa-exclamation-triangle" style="font-size: 2em; margin-bottom: 15px;"></i>
                <p><strong>데이터를 불러오는 중 오류가 발생했습니다.</strong></p>
                <p style="font-size: 0.9em; color: #666;">서버가 실행 중인지 확인해주세요.</p>
                <button class="refresh-btn" onclick="loadRiskUsers()" style="margin-top: 15px;">
                    <i class="fas fa-redo"></i> 다시 시도
                </button>
            </div>
        `;
    }
}

// 사용자 카드 생성
function createUserCard(user) {
    const card = document.createElement('div');
    card.className = `user-card ${user.priority.toLowerCase()}-risk`;
    card.setAttribute('data-chunk-id', user.chunk_id);
    
    const riskPercentage = (user.risk_score * 100).toFixed(0);
    const riskColor = user.priority === 'HIGH' ? '#dc3545' : '#ffc107';
    
    // confirmed 상태 처리
    const isConfirmed = user.confirmed;
    const cardStyle = isConfirmed ? 'opacity: 0.7; border-left-color: #28a745;' : '';
    const buttonDisabled = isConfirmed ? 'disabled' : '';
    const buttonStyle = isConfirmed ? 'background: #6c757d; cursor: not-allowed;' : '';
    
    card.innerHTML = `
        <div class="user-header">
            <div class="user-info">
                <h3>
                    <i class="fas fa-user-circle"></i>
                    ${user.username || user.user_id}
                </h3>
                <small>사용자 ID: ${user.user_id}</small>
                ${user.post_id ? `<small>게시글 ID: ${user.post_id}</small>` : ''}
            </div>
            <div style="text-align: right;">
                <span class="risk-badge ${user.priority}">${user.priority}</span>
                <div class="risk-score" style="color: ${riskColor};">
                    ${riskPercentage}%
                </div>
            </div>
        </div>
        
        <div class="evidence-section">
            <h4>
                <i class="fas fa-quote-left"></i>
                위험 문장 (${user.evidence_sentences.length}개)
            </h4>
            <ul class="evidence-list">
                ${user.evidence_sentences.map(sentence => 
                    `<li>"${sentence}"</li>`
                ).join('')}
            </ul>
        </div>
        
        <div class="info-row">
            <span><i class="fas fa-link"></i> 유사 패턴</span>
            <strong>${user.similar_patterns_count}개 발견</strong>
        </div>
        
        <div class="info-row">
            <span><i class="fas fa-clock"></i> 최근 활동</span>
            <span>${new Date(user.last_activity).toLocaleString('ko-KR')}</span>
        </div>
        
        <div class="action-section">
            <h4>
                <i class="fas fa-lightbulb"></i>
                제안 조치사항
            </h4>
            <p style="margin: 0; color: #555;">${user.suggested_action}</p>
        </div>
        
        <div class="feedback-buttons">
            <button class="btn-feedback btn-confirm" 
                    onclick="submitFeedback('${user.chunk_id}', true)" 
                    ${buttonDisabled} 
                    style="${buttonStyle}">
                <i class="fas fa-check"></i>
                ${isConfirmed ? '처리됨' : '위험 맞음'}
            </button>
            <button class="btn-feedback btn-deny" 
                    onclick="submitFeedback('${user.chunk_id}', false)" 
                    ${buttonDisabled} 
                    style="${buttonStyle}">
                <i class="fas fa-times"></i>
                ${isConfirmed ? '처리됨' : '위험 아님'}
            </button>
        </div>
        
        ${isConfirmed ? `
            <div style="position: absolute; top: 10px; right: 10px; background: #28a745; color: white; padding: 4px 8px; border-radius: 12px; font-size: 0.75em; font-weight: bold;">
                ${user.feedback_at ? '확인됨' : '처리됨'}
            </div>
        ` : ''}
    `;
    
    // confirmed 상태면 카드 스타일 적용
    if (isConfirmed) {
        card.style.cssText = cardStyle;
        card.style.position = 'relative';
    }
    
    return card;
}

// 피드백 제출
async function submitFeedback(chunkId, confirmed) {
    const button = event.target;
    const originalText = button.innerHTML;
    
    // 버튼 로딩 상태
    button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 처리중...';
    button.disabled = true;
    
    try {
        const response = await fetch('/api/risk/feedback', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                chunk_id: chunkId,
                confirmed: confirmed
            })
        });
        
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const data = await response.json();
        
        if (data.status === 'ok') {
            // 성공 메시지
            button.innerHTML = '<i class="fas fa-check"></i> 완료';
            button.style.background = '#28a745';
            
            // 알림 표시
            showNotification(
                `피드백이 처리되었습니다!`,
                `${data.action} - ${data.message}`,
                'success'
            );
            
            // 카드 상태 업데이트
            const card = button.closest('.user-card');
            if (card) {
                card.style.opacity = '0.7';
                card.style.borderLeftColor = '#28a745';
                
                // 상태 표시 추가
                const statusIndicator = document.createElement('div');
                statusIndicator.style.cssText = `
                    position: absolute;
                    top: 10px;
                    right: 10px;
                    background: #28a745;
                    color: white;
                    padding: 4px 8px;
                    border-radius: 12px;
                    font-size: 0.75em;
                    font-weight: bold;
                `;
                statusIndicator.textContent = confirmed ? '확인됨' : '무시됨';
                card.style.position = 'relative';
                card.appendChild(statusIndicator);
            }
            
            // 3초 후 원래 상태로 복원
            setTimeout(() => {
                button.innerHTML = originalText;
                button.disabled = true; // 처리 완료 후 비활성화 유지
                button.style.background = '#6c757d';
            }, 3000);
        }
    } catch (error) {
        console.error('Error submitting feedback:', error);
        
        // 에러 상태
        button.innerHTML = '<i class="fas fa-exclamation-triangle"></i> 오류';
        button.style.background = '#dc3545';
        
        showNotification(
            '오류 발생',
            '피드백 제출 중 오류가 발생했습니다.',
            'error'
        );
        
        // 3초 후 원래 상태로 복원
        setTimeout(() => {
            button.innerHTML = originalText;
            button.disabled = false;
            button.style.background = '';
        }, 3000);
    }
}

// 알림 표시 함수
function showNotification(title, message, type = 'info') {
    const notification = document.createElement('div');
    notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: ${type === 'success' ? '#d4edda' : type === 'error' ? '#f8d7da' : '#d1ecf1'};
        border: 1px solid ${type === 'success' ? '#c3e6cb' : type === 'error' ? '#f5c6cb' : '#bee5eb'};
        color: ${type === 'success' ? '#155724' : type === 'error' ? '#721c24' : '#0c5460'};
        padding: 15px 20px;
        border-radius: 8px;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        z-index: 1000;
        max-width: 300px;
        animation: slideIn 0.3s ease-out;
    `;
    
    notification.innerHTML = `
        <div style="font-weight: bold; margin-bottom: 5px;">${title}</div>
        <div style="font-size: 0.9em;">${message}</div>
    `;
    
    document.body.appendChild(notification);
    
    // 5초 후 자동 제거
    setTimeout(() => {
        notification.style.animation = 'slideOut 0.3s ease-in';
        setTimeout(() => {
            if (notification.parentNode) {
                notification.parentNode.removeChild(notification);
            }
        }, 300);
    }, 5000);
}
</script>
{% endblock %}
