{% extends "base.html" %}

{% block title %}í˜ì˜¤ì§€ìˆ˜ í‰ê°€ - Community Admin{% endblock %}

{% block content %}
<div class="page-header">
    <h1>ê²Œì‹œê¸€ í˜ì˜¤ì§€ìˆ˜ í‰ê°€</h1>
    <p>í…ìŠ¤íŠ¸ í˜ì˜¤ í‘œí˜„ ë¶„ì„ ë° ì‹œê°í™”</p>
</div>

<div class="hate-analysis-container">
    <div class="analysis-form">
        <h3>ë¶„ì„í•  í…ìŠ¤íŠ¸ ì…ë ¥</h3>
        <textarea 
            id="hateText" 
            class="form-control" 
            rows="10"
            placeholder="ë¶„ì„í•  ê²Œì‹œê¸€ ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”..."
        ></textarea>
        <button id="analyzeBtn" class="btn btn-primary btn-large">í˜ì˜¤ì§€ìˆ˜ ë¶„ì„</button>
    </div>

    <div class="analysis-result" id="analysisResult" style="display: none;">
        <div class="result-header">
            <h3>ë¶„ì„ ê²°ê³¼</h3>
            <div class="hate-score">
                <div class="score-label">í˜ì˜¤ì§€ìˆ˜</div>
                <div class="score-value" id="hateScore">-</div>
                <div class="score-bar">
                    <div class="score-fill" id="scoreFill"></div>
                </div>
            </div>
        </div>

        <div class="detected-expressions">
            <h4>ê°ì§€ëœ í˜ì˜¤ í‘œí˜„</h4>
            <div id="expressionsList" class="expressions-list"></div>
        </div>

        <div class="highlighted-text">
            <h4>ì›ë¬¸ (í•˜ì´ë¼ì´íŠ¸)</h4>
            <div id="highlightedText" class="text-highlight"></div>
        </div>

        <div class="recommendations">
            <h4>ê¶Œì¥ ì¡°ì¹˜</h4>
            <div id="recommendations" class="recommendations-list"></div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.getElementById('analyzeBtn').addEventListener('click', analyzeHateScore);

    async function analyzeHateScore() {
        const text = document.getElementById('hateText').value.trim();
        
        if (!text) {
            showAlert('ë¶„ì„í•  í…ìŠ¤íŠ¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”', 'warning');
            return;
        }

        const btn = document.getElementById('analyzeBtn');
        btn.disabled = true;
        btn.textContent = 'ë¶„ì„ ì¤‘...';

        try {
            const response = await apiRequest('/api/moderation/hate-score', {
                method: 'POST',
                body: JSON.stringify({ text })
            });

            displayAnalysisResult(response, text);
            document.getElementById('analysisResult').style.display = 'block';
        } catch (error) {
            showAlert('ë¶„ì„ ì‹¤íŒ¨: ' + error.message, 'error');
        } finally {
            btn.disabled = false;
            btn.textContent = 'í˜ì˜¤ì§€ìˆ˜ ë¶„ì„';
        }
    }

    function displayAnalysisResult(data, originalText) {
        if (!data) return;

        // í˜ì˜¤ì§€ìˆ˜ í‘œì‹œ
        const score = data.hate_score || 0;
        document.getElementById('hateScore').textContent = score.toFixed(1) + '/100';
        
        const scoreFill = document.getElementById('scoreFill');
        scoreFill.style.width = score + '%';
        scoreFill.className = 'score-fill ' + getScoreClass(score);

        // ê°ì§€ëœ í‘œí˜„
        const expressionsList = document.getElementById('expressionsList');
        if (data.detected_expressions && data.detected_expressions.length > 0) {
            expressionsList.innerHTML = data.detected_expressions.map(expr => `
                <div class="expression-item">
                    <span class="expression-text">"${expr.text}"</span>
                    <span class="expression-type">${expr.type}</span>
                    <span class="expression-severity severity-${expr.severity}">${expr.severity}</span>
                </div>
            `).join('');
        } else {
            expressionsList.innerHTML = '<p>ê°ì§€ëœ í˜ì˜¤ í‘œí˜„ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
        }

        // í•˜ì´ë¼ì´íŠ¸ëœ í…ìŠ¤íŠ¸
        let highlightedText = originalText;
        if (data.detected_expressions) {
            data.detected_expressions.forEach(expr => {
                const regex = new RegExp(expr.text.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'), 'gi');
                highlightedText = highlightedText.replace(regex, 
                    `<mark class="highlight-${expr.severity}">$&</mark>`);
            });
        }
        document.getElementById('highlightedText').innerHTML = highlightedText;

        // ê¶Œì¥ ì¡°ì¹˜
        const recommendations = document.getElementById('recommendations');
        if (data.recommendations && data.recommendations.length > 0) {
            recommendations.innerHTML = data.recommendations.map(rec => `
                <div class="recommendation-item">
                    <span class="rec-icon">${rec.priority === 'high' ? 'ğŸš¨' : rec.priority === 'medium' ? 'âš ï¸' : 'â„¹ï¸'}</span>
                    <span>${rec.message}</span>
                </div>
            `).join('');
        } else {
            recommendations.innerHTML = '<p>íŠ¹ë³„í•œ ì¡°ì¹˜ê°€ í•„ìš”í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.</p>';
        }
    }

    function getScoreClass(score) {
        if (score < 30) return 'score-low';
        if (score < 70) return 'score-medium';
        return 'score-high';
    }
</script>
{% endblock %}

