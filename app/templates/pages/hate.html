{% extends "base.html" %}

{% block title %}혐오지수 평가 - Community Admin{% endblock %}

{% block content %}
<div class="page-header">
    <h1>게시글 혐오지수 평가</h1>
    <p>텍스트 혐오 표현 분석 및 시각화</p>
</div>

<div class="hate-analysis-container">
    <div class="analysis-form">
        <h3>분석할 텍스트 입력</h3>
        <textarea 
            id="hateText" 
            class="form-control" 
            rows="10"
            placeholder="분석할 게시글 내용을 입력하세요..."
        ></textarea>
        <button id="analyzeBtn" class="btn btn-primary btn-large">혐오지수 분석</button>
    </div>

    <div class="analysis-result" id="analysisResult" style="display: none;">
        <div class="result-header">
            <h3>분석 결과</h3>
            <div class="hate-score">
                <div class="score-label">혐오지수</div>
                <div class="score-value" id="hateScore">-</div>
                <div class="score-bar">
                    <div class="score-fill" id="scoreFill"></div>
                </div>
            </div>
        </div>

        <div class="detected-expressions">
            <h4>감지된 혐오 표현</h4>
            <div id="expressionsList" class="expressions-list"></div>
        </div>

        <div class="highlighted-text">
            <h4>원문 (하이라이트)</h4>
            <div id="highlightedText" class="text-highlight"></div>
        </div>

        <div class="recommendations">
            <h4>권장 조치</h4>
            <div id="recommendations" class="recommendations-list"></div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.getElementById('analyzeBtn').addEventListener('click', analyzeHateScore);

    async function analyzeHateScore() {
        const text = document.getElementById('hateText').value.trim();
        
        if (!text) {
            showAlert('분석할 텍스트를 입력하세요', 'warning');
            return;
        }

        const btn = document.getElementById('analyzeBtn');
        btn.disabled = true;
        btn.textContent = '분석 중...';

        try {
            const response = await apiRequest('/api/moderation/hate-score', {
                method: 'POST',
                body: JSON.stringify({ text })
            });

            displayAnalysisResult(response, text);
            document.getElementById('analysisResult').style.display = 'block';
        } catch (error) {
            showAlert('분석 실패: ' + error.message, 'error');
        } finally {
            btn.disabled = false;
            btn.textContent = '혐오지수 분석';
        }
    }

    function displayAnalysisResult(data, originalText) {
        if (!data) return;

        // 혐오지수 표시
        const score = data.hate_score || 0;
        document.getElementById('hateScore').textContent = score.toFixed(1) + '/100';
        
        const scoreFill = document.getElementById('scoreFill');
        scoreFill.style.width = score + '%';
        scoreFill.className = 'score-fill ' + getScoreClass(score);

        // 감지된 표현
        const expressionsList = document.getElementById('expressionsList');
        if (data.detected_expressions && data.detected_expressions.length > 0) {
            expressionsList.innerHTML = data.detected_expressions.map(expr => `
                <div class="expression-item">
                    <span class="expression-text">"${expr.text}"</span>
                    <span class="expression-type">${expr.type}</span>
                    <span class="expression-severity severity-${expr.severity}">${expr.severity}</span>
                </div>
            `).join('');
        } else {
            expressionsList.innerHTML = '<p>감지된 혐오 표현이 없습니다.</p>';
        }

        // 하이라이트된 텍스트
        let highlightedText = originalText;
        if (data.detected_expressions) {
            data.detected_expressions.forEach(expr => {
                const regex = new RegExp(expr.text.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'), 'gi');
                highlightedText = highlightedText.replace(regex, 
                    `<mark class="highlight-${expr.severity}">$&</mark>`);
            });
        }
        document.getElementById('highlightedText').innerHTML = highlightedText;

        // 권장 조치
        const recommendations = document.getElementById('recommendations');
        if (data.recommendations && data.recommendations.length > 0) {
            recommendations.innerHTML = data.recommendations.map(rec => `
                <div class="recommendation-item">
                    <span class="rec-icon">${rec.priority === 'high' ? '🚨' : rec.priority === 'medium' ? '⚠️' : 'ℹ️'}</span>
                    <span>${rec.message}</span>
                </div>
            `).join('');
        } else {
            recommendations.innerHTML = '<p>특별한 조치가 필요하지 않습니다.</p>';
        }
    }

    function getScoreClass(score) {
        if (score < 30) return 'score-low';
        if (score < 70) return 'score-medium';
        return 'score-high';
    }
</script>
{% endblock %}

