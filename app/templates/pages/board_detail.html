<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ê²Œì‹œê¸€ - Community Admin</title>
    <link rel="icon" type="image/png" href="{{ url_for('static', path='/img/sub_home.png') }}">
    <link rel="stylesheet" href="{{ url_for('static', path='/css/app.css') }}">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body { background-color: #F9FAFB; }
        .header-bar {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: white;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            padding: 12px 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 1000;
        }
        .header-bar .logo {
            font-size: 18px;
            font-weight: 600;
            color: #1F2937;
            text-decoration: none;
        }
        .user-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .user-name {
            color: #374151;
            font-weight: 500;
        }
        .btn-header {
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            border: none;
            text-decoration: none;
            display: inline-block;
        }
        .btn-login {
            background: #3B82F6;
            color: white;
        }
        .btn-login:hover {
            background: #2563EB;
        }
        .btn-logout {
            background: #EF4444;
            color: white;
        }
        .btn-logout:hover {
            background: #DC2626;
        }
        .detail-container {
            max-width: 900px;
            margin: 40px auto;
            margin-top: 100px;
            padding: 0 20px;
        }
        .back-link {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 10px 16px;
            background: white;
            color: #374151;
            text-decoration: none;
            margin-bottom: 20px;
            border-radius: 8px;
            border: 1px solid #E5E7EB;
            font-weight: 500;
            font-size: 14px;
            transition: all 0.2s;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
        }
        .back-link:hover {
            background: #F9FAFB;
            border-color: #D1D5DB;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .post-card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            padding: 30px;
            margin-bottom: 30px;
        }
        .post-header {
            border-bottom: 1px solid #E5E7EB;
            padding-bottom: 20px;
            margin-bottom: 20px;
        }
        .post-category {
            display: inline-block;
            padding: 4px 12px;
            background: #DBEAFE;
            color: #1E40AF;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
            margin-bottom: 10px;
        }
        .post-title {
            font-size: 28px;
            color: #1F2937;
            margin: 0 0 12px 0;
        }
        .post-meta {
            display: flex;
            gap: 16px;
            color: #9CA3AF;
            font-size: 14px;
        }
        .post-content {
            font-size: 16px;
            line-height: 1.8;
            color: #374151;
            margin-bottom: 30px;
            white-space: pre-wrap;
            word-break: break-word;
        }
        .post-actions {
            display: flex;
            gap: 12px;
            padding-top: 20px;
            border-top: 1px solid #E5E7EB;
        }
        .btn {
            padding: 10px 20px;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            border: none;
            text-decoration: none;
            display: inline-block;
        }
        .btn-primary {
            background: #3B82F6;
            color: white;
        }
        .btn-primary:hover {
            background: #2563EB;
        }
        .btn-danger {
            background: #EF4444;
            color: white;
        }
        .btn-danger:hover {
            background: #DC2626;
        }
        .btn-secondary {
            background: #6B7280;
            color: white;
        }
        .btn-secondary:hover {
            background: #4B5563;
        }
        
        /* ëŒ“ê¸€ ìŠ¤íƒ€ì¼ */
        .comments-section {
            background: white;
            border-radius: 12px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            padding: 30px;
        }
        .comments-header {
            font-size: 20px;
            font-weight: 600;
            color: #1F2937;
            margin-bottom: 20px;
        }
        .comment-form {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 2px solid #E5E7EB;
        }
        .comment-form textarea {
            width: 100%;
            min-height: 100px;
            padding: 12px;
            border: 1px solid #D1D5DB;
            border-radius: 6px;
            font-size: 15px;
            box-sizing: border-box;
            resize: vertical;
            font-family: inherit;
        }
        .comment-form textarea:focus {
            outline: none;
            border-color: #3B82F6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
        .comment-form-actions {
            display: flex;
            justify-content: flex-end;
            gap: 8px;
            margin-top: 10px;
        }
        .comment-list {
            margin-top: 20px;
        }
        .comment-item {
            padding: 16px 0;
            border-bottom: 1px solid #E5E7EB;
        }
        .comment-item:last-child {
            border-bottom: none;
        }
        .comment-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 6px;
        }
        .comment-author {
            font-weight: 600;
            color: #374151;
            font-size: 16px;
        }
        .comment-date {
            color: #9CA3AF;
            font-size: 14px;
        }
        .comment-content {
            color: #4B5563;
            font-size: 16px;
            line-height: 1.6;
            margin-bottom: 6px;
            /* white-space: pre-wrap; */
            word-break: break-word;
        }
        .comment-actions {
            display: flex;
            gap: 12px;
            font-size: 13px;
        }
        .comment-action-btn {
            color: #6B7280;
            cursor: pointer;
            background: none;
            border: none;
            padding: 0;
            font-size: 14px;
        }
        .comment-action-btn:hover {
            color: #3B82F6;
        }
        .reply-section {
            margin-left: 40px;
            margin-top: 12px;
            padding-left: 16px;
            border-left: 2px solid #E5E7EB;
        }
        .reply-item {
            padding: 8px 0;
            border-bottom: 1px solid #F3F4F6;
        }
        .reply-item:last-child {
            border-bottom: none;
        }
        .loading {
            padding:0;
            text-align: center;
            color: #6B7280;
        }
        .edit-form {
            margin-top: 10px;
        }
        .edit-form textarea {
            width: 100%;
            min-height: 60px;
            padding: 10px;
            border: 1px solid #D1D5DB;
            border-radius: 6px;
            font-size: 14px;
            box-sizing: border-box;
            font-family: inherit;
        }
        .btn-sm {
            padding: 6px 12px;
            font-size: 15px;
        }
        .alert {
            padding: 12px;
            border-radius: 6px;
            margin-bottom: 20px;
        }
        .alert-error {
            background: #FEE2E2;
            color: #991B1B;
            border: 1px solid #FCA5A5;
        }
        .alert-success {
            background: #D1FAE5;
            color: #065F46;
            border: 1px solid #6EE7B7;
        }
        /* ì‹ ê³  ëª¨ë‹¬ ìŠ¤íƒ€ì¼ */
        .report-form {
            margin: 20px 0;
        }
        .form-group {
            margin-bottom: 20px;
        }
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #374151;
        }
        .form-select {
            width: 100%;
            padding: 10px;
            border: 1px solid #D1D5DB;
            border-radius: 6px;
            font-size: 14px;
            box-sizing: border-box;
        }
        .form-textarea {
            width: 100%;
            min-height: 100px;
            padding: 10px;
            border: 1px solid #D1D5DB;
            border-radius: 6px;
            font-size: 14px;
            resize: vertical;
            box-sizing: border-box;
        }
        .form-help {
            margin-top: 4px;
            font-size: 12px;
            color: #6B7280;
        }
        .btn-outline {
            background: white;
            color: #DC2626;
            border: 1px solid #DC2626;
        }
        .btn-outline:hover {
            background: #FEF2F2;
        }
        /* ë¡œë”© ìŠ¤í”¼ë„ˆ ì• ë‹ˆë©”ì´ì…˜ */
        .spinner {
            display: inline-block;
            margin-right: 6px;
            font-size: 1em;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="header-bar">
        <a href="/" class="logo">Community Admin</a>
        <div class="user-info" id="userInfoHeader">
            <span id="loadingUserHeader">ë¡œë”© ì¤‘...</span>
        </div>
    </div>
    
    <div class="detail-container">
        <a href="/board" class="back-link">â† ëª©ë¡ìœ¼ë¡œ</a>

        <div id="postContainer" class="loading">ê²Œì‹œê¸€ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>

        <div id="commentsContainer" style="display: none;">
            <div class="comments-section">
                <h3 class="comments-header">ëŒ“ê¸€ <span id="commentCount">0</span></h3>

                <div class="comment-list" id="commentList"></div>

                <div id="commentFormContainer"></div>
            </div>
        </div>
    </div>

    <script>
        const postId = window.location.pathname.split('/').pop();
        let currentUser = null;
        let postData = null;

        // ì‚¬ìš©ì ì •ë³´ í™•ì¸
        async function checkUser() {
            try {
                const response = await fetch('/api/auth/me');
                const data = await response.json();
                if (data.authenticated) {
                    currentUser = {
                        authenticated: true,
                        ...data.user
                    };
                }
            } catch (error) {
                console.error('Failed to check user:', error);
            }
        }

        // ê²Œì‹œê¸€ ë¡œë“œ
        async function loadPost() {
            try {
                const response = await fetch(`/api/board/posts/${postId}`);
                const data = await response.json();

                if (data.success) {
                    postData = data.post;
                    displayPost(data.post);
                    displayComments(data.comments);
                    document.getElementById('commentsContainer').style.display = 'block';
                } else {
                    document.getElementById('postContainer').innerHTML = '<div class="post-card">ê²Œì‹œê¸€ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤</div>';
                }
            } catch (error) {
                console.error('Failed to load post:', error);
                document.getElementById('postContainer').innerHTML = '<div class="post-card">ê²Œì‹œê¸€ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤</div>';
            }
        }

        // ê²Œì‹œê¸€ í‘œì‹œ
        function displayPost(post) {
            const categoryLabels = {
                'free': 'ììœ ê²Œì‹œíŒ',
                'notice': 'ê³µì§€ì‚¬í•­',
                'qna': 'ì§ˆë¬¸ë‹µë³€',
                'review': 'í›„ê¸°',
                'tips': 'íŒ/ë…¸í•˜ìš°'
            };

            const date = new Date(post.created_at);
            const dateStr = date.toLocaleString('ko-KR');

            // ë””ë²„ê¹…: ì‹ ê³  ë²„íŠ¼ í‘œì‹œ ì¡°ê±´ í™•ì¸
            console.log('ê²Œì‹œê¸€ ì‘ì„±ì ì—¬ë¶€:', post.is_author);
            console.log('í˜„ì¬ ì‚¬ìš©ì:', currentUser);
            
            let actions = '';
            if (post.is_author) {
                actions = `
                    <a href="/board/write?id=${post.id}" class="btn btn-primary">ìˆ˜ì •</a>
                    <button onclick="deletePost()" class="btn btn-danger">ì‚­ì œ</button>
                `;
            } else if (currentUser && currentUser.authenticated) {
                // ì‘ì„±ìê°€ ì•„ë‹Œ ë¡œê·¸ì¸ ì‚¬ìš©ìëŠ” ì‹ ê³  ë²„íŠ¼ í‘œì‹œ
                console.log('ì‹ ê³  ë²„íŠ¼ í‘œì‹œ!');
                actions = `<button id="reportBtn" onclick="openReportModal()" class="btn btn-outline"><i class="fas fa-flag"></i> ì‹ ê³ </button>`;
            }
            actions += `<button onclick="likePost()" class="btn btn-secondary">â¤ï¸ ì¢‹ì•„ìš” (${post.like_count})</button>`;

            const html = `
                <div class="post-card">
                    <div class="post-header">
                        <span class="post-category">${categoryLabels[post.category] || post.category}</span>
                        <h1 class="post-title">${post.title}</h1>
                        <div class="post-meta">
                            <span>ğŸ‘¤ ${post.author.username}</span>
                            <span>ğŸ“… ${dateStr}</span>
                            <span>ğŸ‘ï¸ ${post.view_count}</span>
                        </div>
                    </div>
                    <div class="post-content">${post.content}</div>
                    <div class="post-actions">
                        ${actions}
                    </div>
                </div>
            `;

            document.getElementById('postContainer').innerHTML = html;
        }

        // ëŒ“ê¸€ í‘œì‹œ
        function displayComments(comments) {
            const count = comments.reduce((total, c) => total + 1 + c.replies.length, 0);
            document.getElementById('commentCount').textContent = count;

            // ëŒ“ê¸€ ì‘ì„± í¼
            const formHtml = currentUser ? `
                <div class="comment-form">
                    <textarea id="commentContent" placeholder="ëŒ“ê¸€ì„ ì…ë ¥í•˜ì„¸ìš”..."></textarea>
                    <div class="comment-form-actions">
                        <button id="commentSubmitBtn" class="btn btn-primary btn-sm" onclick="submitComment()">ëŒ“ê¸€ ì‘ì„±</button>
                    </div>
                </div>
            ` : '<p style="color: #6B7280; padding: 20px; text-align: center;">ëŒ“ê¸€ì„ ì‘ì„±í•˜ë ¤ë©´ <a href="/login" style="color: #3B82F6;">ë¡œê·¸ì¸</a>í•˜ì„¸ìš”</p>';

            document.getElementById('commentFormContainer').innerHTML = formHtml;

            // ëŒ“ê¸€ ëª©ë¡
            const html = comments.map(comment => renderComment(comment)).join('');
            document.getElementById('commentList').innerHTML = html || '<p style="color: #9CA3AF; text-align: center; padding: 20px;">ì•„ì§ ëŒ“ê¸€ì´ ì—†ìŠµë‹ˆë‹¤</p>';
        }

        // ëŒ“ê¸€ ë Œë”ë§
        function renderComment(comment, isReply = false) {
            const date = new Date(comment.created_at);
            const dateStr = date.toLocaleString('ko-KR');
            const isAuthor = currentUser && currentUser.id === comment.author.id;

            let actions = '';
            if (isAuthor) {
                // ì‘ì„±ì: ìˆ˜ì •, ì‚­ì œ
                actions = `
                    <button class="comment-action-btn" onclick="editComment(${comment.id}, '${comment.content.replace(/'/g, "\\'")}')">ìˆ˜ì •</button>
                    <button class="comment-action-btn" onclick="deleteComment(${comment.id})">ì‚­ì œ</button>
                `;
            } else if (currentUser && currentUser.authenticated) {
                // ì‘ì„±ì ì•„ë‹˜ + ë¡œê·¸ì¸: ì‹ ê³ 
                // reportedComments Setì— ìˆëŠ”ì§€ í™•ì¸
                const isReported = reportedComments.has(comment.id);
                if (isReported) {
                    actions = `
                        <button class="comment-action-btn comment-report-btn" id="commentReportBtn-${comment.id}" disabled style="opacity: 0.6; cursor: not-allowed;">
                            <i class="fas fa-flag"></i> ì‹ ê³ ë¨
                        </button>
                    `;
                } else {
                    actions = `
                        <button class="comment-action-btn comment-report-btn" id="commentReportBtn-${comment.id}" onclick="openCommentReportModal(${comment.id})">
                            <i class="fas fa-flag"></i> ì‹ ê³ 
                        </button>
                    `;
                }
            }

            const replyBtn = currentUser && !isReply ? `
                <button class="comment-action-btn" onclick="showReplyForm(${comment.id})">ë‹µê¸€</button>
            ` : '';

            let repliesHtml = '';
            if (comment.replies && comment.replies.length > 0) {
                repliesHtml = `
                    <div class="reply-section">
                        ${comment.replies.map(reply => renderComment(reply, true)).join('')}
                    </div>
                `;
            }

            const itemClass = isReply ? 'reply-item' : 'comment-item';

            return `
                <div class="${itemClass}" id="comment-${comment.id}">
                    <div class="comment-header">
                        <span class="comment-author">${comment.author.username}</span>
                        <span class="comment-date">${dateStr}</span>
                    </div>
                    <div class="comment-content" id="comment-content-${comment.id}">${comment.content}</div>
                    <div class="comment-actions">
                        ${replyBtn}
                        ${actions}
                    </div>
                    <div id="reply-form-${comment.id}"></div>
                    ${repliesHtml}
                </div>
            `;
        }

        // ëŒ“ê¸€ ì‘ì„±
        async function submitComment(parentId = null) {
            const contentId = parentId ? `reply-content-${parentId}` : 'commentContent';
            const content = document.getElementById(contentId)?.value.trim();

            if (!content || content.length < 2) {
                alert('ëŒ“ê¸€ì€ 2ì ì´ìƒ ì…ë ¥í•´ì£¼ì„¸ìš”');
                return;
            }

            // ë²„íŠ¼ ì°¾ê¸° ë° ë¹„í™œì„±í™”
            const btnId = parentId ? `reply-btn-${parentId}` : 'commentSubmitBtn';
            const submitBtn = document.getElementById(btnId);
            const originalText = submitBtn ? submitBtn.textContent : '';
            
            if (submitBtn) {
                submitBtn.disabled = true;
                submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ë¹„ìœ¤ë¦¬/ìŠ¤íŒ¸ ë¶„ì„ ì¤‘...';
            }

            try {
                const response = await fetch(`/api/board/posts/${postId}/comments`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ content, parent_id: parentId })
                });

                const data = await response.json();

                if (response.ok && data.success) {
                    await loadPost();
                } else if (data.blocked) {
                    // ì°¨ë‹¨ëœ ê²½ìš°
                    alert(data.message || 'ëŒ“ê¸€ì´ ì°¨ë‹¨ë˜ì—ˆìŠµë‹ˆë‹¤');
                } else {
                    alert(data.detail || 'ëŒ“ê¸€ ì‘ì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤');
                }
            } catch (error) {
                console.error('Failed to submit comment:', error);
                alert('ëŒ“ê¸€ ì‘ì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤');
            } finally {
                // ë²„íŠ¼ ë‹¤ì‹œ í™œì„±í™”
                if (submitBtn) {
                    submitBtn.disabled = false;
                    submitBtn.textContent = originalText;
                }
            }
        }

        // ë‹µê¸€ í¼ í‘œì‹œ
        function showReplyForm(commentId) {
            const formContainer = document.getElementById(`reply-form-${commentId}`);
            formContainer.innerHTML = `
                <div class="edit-form">
                    <textarea id="reply-content-${commentId}" placeholder="ë‹µê¸€ì„ ì…ë ¥í•˜ì„¸ìš”..."></textarea>
                    <div style="display: flex; gap: 8px; margin-top: 8px;">
                        <button id="reply-btn-${commentId}" class="btn btn-primary btn-sm" onclick="submitComment(${commentId})">ì‘ì„±</button>
                        <button class="btn btn-secondary btn-sm" onclick="hideReplyForm(${commentId})">ì·¨ì†Œ</button>
                    </div>
                </div>
            `;
        }

        function hideReplyForm(commentId) {
            document.getElementById(`reply-form-${commentId}`).innerHTML = '';
        }

        // ëŒ“ê¸€ ìˆ˜ì •
        function editComment(commentId, currentContent) {
            const contentDiv = document.getElementById(`comment-content-${commentId}`);
            contentDiv.innerHTML = `
                <div class="edit-form">
                    <textarea id="edit-content-${commentId}">${currentContent}</textarea>
                    <div style="display: flex; gap: 8px; margin-top: 8px;">
                        <button class="btn btn-primary btn-sm" onclick="updateComment(${commentId})">ì €ì¥</button>
                        <button class="btn btn-secondary btn-sm" onclick="loadPost()">ì·¨ì†Œ</button>
                    </div>
                </div>
            `;
        }

        async function updateComment(commentId) {
            const content = document.getElementById(`edit-content-${commentId}`)?.value.trim();

            if (!content || content.length < 2) {
                alert('ëŒ“ê¸€ì€ 2ì ì´ìƒ ì…ë ¥í•´ì£¼ì„¸ìš”');
                return;
            }

            try {
                const response = await fetch(`/api/board/comments/${commentId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ content })
                });

                const data = await response.json();

                if (response.ok && data.success) {
                    await loadPost();
                } else {
                    alert(data.detail || 'ëŒ“ê¸€ ìˆ˜ì •ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤');
                }
            } catch (error) {
                console.error('Failed to update comment:', error);
                alert('ëŒ“ê¸€ ìˆ˜ì • ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤');
            }
        }

        // ëŒ“ê¸€ ì‚­ì œ
        async function deleteComment(commentId) {
            if (!confirm('ëŒ“ê¸€ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;

            try {
                const response = await fetch(`/api/board/comments/${commentId}`, {
                    method: 'DELETE'
                });

                const data = await response.json();

                if (response.ok && data.success) {
                    await loadPost();
                } else {
                    alert(data.detail || 'ëŒ“ê¸€ ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤');
                }
            } catch (error) {
                console.error('Failed to delete comment:', error);
                alert('ëŒ“ê¸€ ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤');
            }
        }

        // ê²Œì‹œê¸€ ì‚­ì œ
        async function deletePost() {
            if (!confirm('ê²Œì‹œê¸€ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;

            try {
                const response = await fetch(`/api/board/posts/${postId}`, {
                    method: 'DELETE'
                });

                const data = await response.json();

                if (response.ok && data.success) {
                    alert('ê²Œì‹œê¸€ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤');
                    location.href = '/board';
                } else {
                    alert(data.detail || 'ê²Œì‹œê¸€ ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤');
                }
            } catch (error) {
                console.error('Failed to delete post:', error);
                alert('ê²Œì‹œê¸€ ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤');
            }
        }

        // ì¢‹ì•„ìš”
        async function likePost() {
            if (!currentUser) {
                alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤');
                return;
            }

            try {
                const response = await fetch(`/api/board/posts/${postId}/like`, {
                    method: 'POST'
                });

                const data = await response.json();

                if (response.ok && data.success) {
                    await loadPost();
                } else {
                    alert(data.detail || 'ì¢‹ì•„ìš” ì²˜ë¦¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤');
                }
            } catch (error) {
                console.error('Failed to like post:', error);
                alert('ì¢‹ì•„ìš” ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤');
            }
        }

        // ===== ì‹ ê³  ê¸°ëŠ¥ =====
        let isReported = false;
        let reportedComments = new Set(); // ì‹ ê³ í•œ ëŒ“ê¸€ ID ì €ì¥
        let currentReportType = 'post'; // 'post' ë˜ëŠ” 'comment'
        let currentReportTargetId = null; // ì‹ ê³  ëŒ€ìƒ ID

        // ê²Œì‹œê¸€ ì‹ ê³  ìƒíƒœ í™•ì¸
        async function checkReportStatus() {
            try {
                const response = await fetch(`/api/board/posts/${postId}/report/check`);
                const data = await response.json();
                
                if (data.reported) {
                    isReported = true;
                    const reportBtn = document.getElementById('reportBtn');
                    if (reportBtn) {
                        reportBtn.innerHTML = '<i class="fas fa-flag"></i> ì‹ ê³ ë¨';
                        reportBtn.disabled = true;
                        reportBtn.style.opacity = '0.6';
                        reportBtn.style.cursor = 'not-allowed';
                    }
                }
            } catch (error) {
                console.error('Failed to check report status:', error);
            }
        }

        // ëŒ“ê¸€ ì‹ ê³  ìƒíƒœ í™•ì¸
        async function checkCommentReportStatus(commentId) {
            try {
                const response = await fetch(`/api/board/comments/${commentId}/report/check`);
                const data = await response.json();
                
                if (data.reported) {
                    reportedComments.add(commentId);
                    const reportBtn = document.getElementById(`commentReportBtn-${commentId}`);
                    if (reportBtn) {
                        reportBtn.innerHTML = '<i class="fas fa-flag"></i> ì‹ ê³ ë¨';
                        reportBtn.disabled = true;
                        reportBtn.style.opacity = '0.6';
                        reportBtn.style.cursor = 'not-allowed';
                    }
                }
            } catch (error) {
                console.error('Failed to check comment report status:', error);
            }
        }

        // ëª¨ë“  ëŒ“ê¸€ì˜ ì‹ ê³  ìƒíƒœ í™•ì¸
        async function checkAllCommentReportStatus() {
            if (!currentUser || !currentUser.authenticated) return;
            
            const commentBtns = document.querySelectorAll('.comment-report-btn');
            for (const btn of commentBtns) {
                const commentId = btn.id.replace('commentReportBtn-', '');
                if (commentId) {
                    await checkCommentReportStatus(parseInt(commentId));
                }
            }
        }

        // ê²Œì‹œê¸€ ì‹ ê³  ëª¨ë‹¬ ì—´ê¸°
        function openReportModal() {
            if (isReported) {
                alert('ì´ë¯¸ ì‹ ê³ í•œ ê²Œì‹œê¸€ì…ë‹ˆë‹¤');
                return;
            }
            currentReportType = 'post';
            currentReportTargetId = postId;
            document.getElementById('reportModal').style.display = 'flex';
            document.getElementById('reportModalTitle').textContent = 'ê²Œì‹œê¸€ ì‹ ê³ ';
            document.getElementById('reportReason').value = '';
            document.getElementById('reportDetail').value = '';
            updateCharCount();
        }

        // ëŒ“ê¸€ ì‹ ê³  ëª¨ë‹¬ ì—´ê¸°
        function openCommentReportModal(commentId) {
            if (reportedComments.has(commentId)) {
                alert('ì´ë¯¸ ì‹ ê³ í•œ ëŒ“ê¸€ì…ë‹ˆë‹¤');
                return;
            }
            currentReportType = 'comment';
            currentReportTargetId = commentId;
            document.getElementById('reportModal').style.display = 'flex';
            document.getElementById('reportModalTitle').textContent = 'ëŒ“ê¸€ ì‹ ê³ ';
            document.getElementById('reportReason').value = '';
            document.getElementById('reportDetail').value = '';
            updateCharCount();
        }

        // ì‹ ê³  ëª¨ë‹¬ ë‹«ê¸°
        function closeReportModal() {
            document.getElementById('reportModal').style.display = 'none';
            currentReportType = 'post';
            currentReportTargetId = null;
        }

        // ê¸€ì ìˆ˜ ì—…ë°ì´íŠ¸
        function updateCharCount() {
            const detail = document.getElementById('reportDetail').value;
            document.getElementById('charCount').textContent = detail.length;
        }

        // ì‹ ê³  ì œì¶œ (ê²Œì‹œê¸€ ë˜ëŠ” ëŒ“ê¸€)
        async function submitReport() {
            const reason = document.getElementById('reportReason').value;
            const detail = document.getElementById('reportDetail').value;
            
            if (!reason) {
                alert('ì‹ ê³  ì‚¬ìœ ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”');
                return;
            }
            
            try {
                // API ì—”ë“œí¬ì¸íŠ¸ ê²°ì •
                const apiUrl = currentReportType === 'post' 
                    ? `/api/board/posts/${currentReportTargetId}/report`
                    : `/api/board/comments/${currentReportTargetId}/report`;
                
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ reason, detail: detail || null })
                });
                
                const data = await response.json();
                
                if (response.ok && data.success) {
                    alert(data.message || 'ì‹ ê³ ê°€ ì ‘ìˆ˜ë˜ì—ˆìŠµë‹ˆë‹¤');
                    closeReportModal();
                    
                    if (currentReportType === 'post') {
                        // ê²Œì‹œê¸€ ì‹ ê³ 
                        isReported = true;
                        const reportBtn = document.getElementById('reportBtn');
                        if (reportBtn) {
                            reportBtn.innerHTML = '<i class="fas fa-flag"></i> ì‹ ê³ ë¨';
                            reportBtn.disabled = true;
                            reportBtn.style.opacity = '0.6';
                            reportBtn.style.cursor = 'not-allowed';
                        }
                    } else {
                        // ëŒ“ê¸€ ì‹ ê³  - Setì— ì¶”ê°€í•˜ê³  ì¦‰ì‹œ ë²„íŠ¼ ë¹„í™œì„±í™”
                        reportedComments.add(currentReportTargetId);
                        
                        // ë²„íŠ¼ ìƒíƒœ ì¦‰ì‹œ ì—…ë°ì´íŠ¸
                        const reportBtn = document.getElementById(`commentReportBtn-${currentReportTargetId}`);
                        if (reportBtn) {
                            reportBtn.innerHTML = '<i class="fas fa-flag"></i> ì‹ ê³ ë¨';
                            reportBtn.disabled = true;
                            reportBtn.style.opacity = '0.6';
                            reportBtn.style.cursor = 'not-allowed';
                            reportBtn.onclick = null;  // í´ë¦­ ì´ë²¤íŠ¸ ì œê±°
                        }
                    }
                } else {
                    alert(data.detail || 'ì‹ ê³  ì ‘ìˆ˜ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤');
                }
            } catch (error) {
                console.error('Failed to report:', error);
                alert('ì‹ ê³  ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤');
            }
        }

        // í—¤ë” ì‚¬ìš©ì ì •ë³´ ë¡œë“œ
        async function loadUserInfoHeader() {
            try {
                const response = await fetch('/api/auth/me');
                const data = await response.json();
                
                const userInfoDiv = document.getElementById('userInfoHeader');
                
                if (data.authenticated && data.user) {
                    // ê´€ë¦¬ì ì—¬ë¶€ í™•ì¸
                    const adminResponse = await fetch('/api/admin/me');
                    const adminData = await adminResponse.json();
                    
                    let adminButton = '';
                    if (adminData.is_admin) {
                        adminButton = `<a href="/admin/reports" class="btn-header" style="background: #8B5CF6; color: white;">âš™ï¸ ê´€ë¦¬ì</a>`;
                    }
                    
                    userInfoDiv.innerHTML = `
                        ${adminButton}
                        <span class="user-name">${data.user.username}ë‹˜</span>
                        <button class="btn-header btn-logout" onclick="logout()">ë¡œê·¸ì•„ì›ƒ</button>
                    `;
                } else {
                    userInfoDiv.innerHTML = `
                        <a href="/login" class="btn-header btn-login">ë¡œê·¸ì¸</a>
                        <a href="/register" class="btn-header btn-login" style="background: #6B7280;">íšŒì›ê°€ì…</a>
                    `;
                }
            } catch (error) {
                console.error('Failed to load user info:', error);
                document.getElementById('userInfoHeader').innerHTML = `
                    <a href="/login" class="btn-header btn-login">ë¡œê·¸ì¸</a>
                `;
            }
        }

        async function logout() {
            try {
                const response = await fetch('/api/auth/logout', {
                    method: 'POST'
                });
                
                if (response.ok) {
                    window.location.reload();
                }
            } catch (error) {
                console.error('Logout error:', error);
                alert('ë¡œê·¸ì•„ì›ƒ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤');
            }
        }

        // ì´ˆê¸°í™”
        (async () => {
            await loadUserInfoHeader();
            await checkUser();
            await loadPost();
            await checkReportStatus();
            await checkAllCommentReportStatus();
        })();
    </script>

    <!-- ì‹ ê³  ëª¨ë‹¬ -->
    <div id="reportModal" class="modal" style="display: none;">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h3><i class="fas fa-flag"></i> <span id="reportModalTitle">ê²Œì‹œê¸€ ì‹ ê³ </span></h3>
                <button onclick="closeReportModal()" class="btn-close">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <p>ë¶€ì ì ˆí•œ ì½˜í…ì¸ ë¥¼ ì‹ ê³ í•´ì£¼ì„¸ìš”. ê²€í†  í›„ ì¡°ì¹˜í•˜ê² ìŠµë‹ˆë‹¤.</p>
                <div class="report-form">
                    <div class="form-group">
                        <label for="reportReason">ì‹ ê³  ì‚¬ìœ  <span style="color: red;">*</span></label>
                        <select id="reportReason" class="form-select">
                            <option value="">ì‹ ê³  ì‚¬ìœ ë¥¼ ì„ íƒí•˜ì„¸ìš”</option>
                            <option value="ìš•ì„¤ ë° ë¹„ë°©">ìš•ì„¤ ë° ë¹„ë°©</option>
                            <option value="ë„ë°° ë° ê´‘ê³ ">ë„ë°° ë° ê´‘ê³ </option>
                            <option value="ì‚¬ìƒí™œ ì¹¨í•´">ì‚¬ìƒí™œ ì¹¨í•´</option>
                            <option value="ì €ì‘ê¶Œ ì¹¨í•´">ì €ì‘ê¶Œ ì¹¨í•´</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="reportDetail">ìƒì„¸ ì‚¬ìœ  (ì„ íƒ)</label>
                        <textarea id="reportDetail" class="form-textarea" placeholder="ì¶”ê°€ ì„¤ëª…ì´ í•„ìš”í•œ ê²½ìš° ì…ë ¥í•´ì£¼ì„¸ìš”" maxlength="500" oninput="updateCharCount()"></textarea>
                        <div class="form-help"><span id="charCount">0</span> / 500ì</div>
                    </div>
                </div>
                <div class="modal-actions">
                    <button onclick="submitReport()" class="btn btn-danger">
                        <i class="fas fa-flag"></i> ì‹ ê³ í•˜ê¸°
                    </button>
                    <button onclick="closeReportModal()" class="btn btn-secondary">
                        ì·¨ì†Œ
                    </button>
                </div>
            </div>
        </div>
    </div>
</body>
</html>

