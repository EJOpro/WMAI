<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ê²Œì‹œê¸€ - Community Admin</title>
    <link rel="icon" type="image/png" href="{{ url_for('static', path='/img/sub_home.png') }}">
    <link rel="stylesheet" href="{{ url_for('static', path='/css/app.css') }}">
    <style>
        body { background-color: #F9FAFB; }
        .detail-container {
            max-width: 900px;
            margin: 40px auto;
            padding: 0 20px;
        }
        .back-link {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 10px 16px;
            background: white;
            color: #374151;
            text-decoration: none;
            margin-bottom: 20px;
            border-radius: 8px;
            border: 1px solid #E5E7EB;
            font-weight: 500;
            font-size: 14px;
            transition: all 0.2s;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
        }
        .back-link:hover {
            background: #F9FAFB;
            border-color: #D1D5DB;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .post-card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            padding: 30px;
            margin-bottom: 30px;
        }
        .post-header {
            border-bottom: 1px solid #E5E7EB;
            padding-bottom: 20px;
            margin-bottom: 20px;
        }
        .post-category {
            display: inline-block;
            padding: 4px 12px;
            background: #DBEAFE;
            color: #1E40AF;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
            margin-bottom: 10px;
        }
        .post-title {
            font-size: 28px;
            color: #1F2937;
            margin: 0 0 12px 0;
        }
        .post-meta {
            display: flex;
            gap: 16px;
            color: #9CA3AF;
            font-size: 14px;
        }
        .post-content {
            font-size: 16px;
            line-height: 1.8;
            color: #374151;
            margin-bottom: 30px;
            white-space: pre-wrap;
            word-break: break-word;
        }
        .post-actions {
            display: flex;
            gap: 12px;
            padding-top: 20px;
            border-top: 1px solid #E5E7EB;
        }
        .btn {
            padding: 10px 20px;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            border: none;
            text-decoration: none;
            display: inline-block;
        }
        .btn-primary {
            background: #3B82F6;
            color: white;
        }
        .btn-primary:hover {
            background: #2563EB;
        }
        .btn-danger {
            background: #EF4444;
            color: white;
        }
        .btn-danger:hover {
            background: #DC2626;
        }
        .btn-secondary {
            background: #6B7280;
            color: white;
        }
        .btn-secondary:hover {
            background: #4B5563;
        }
        
        /* ëŒ“ê¸€ ìŠ¤íƒ€ì¼ */
        .comments-section {
            background: white;
            border-radius: 12px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            padding: 30px;
        }
        .comments-header {
            font-size: 20px;
            font-weight: 600;
            color: #1F2937;
            margin-bottom: 20px;
        }
        .comment-form {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 2px solid #E5E7EB;
        }
        .comment-form textarea {
            width: 100%;
            min-height: 100px;
            padding: 12px;
            border: 1px solid #D1D5DB;
            border-radius: 6px;
            font-size: 14px;
            box-sizing: border-box;
            resize: vertical;
            font-family: inherit;
        }
        .comment-form textarea:focus {
            outline: none;
            border-color: #3B82F6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
        .comment-form-actions {
            display: flex;
            justify-content: flex-end;
            gap: 8px;
            margin-top: 10px;
        }
        .comment-list {
            margin-top: 20px;
        }
        .comment-item {
            padding: 16px 0;
            border-bottom: 1px solid #E5E7EB;
        }
        .comment-item:last-child {
            border-bottom: none;
        }
        .comment-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 6px;
        }
        .comment-author {
            font-weight: 600;
            color: #374151;
            font-size: 16px;
        }
        .comment-date {
            color: #9CA3AF;
            font-size: 14px;
        }
        .comment-content {
            color: #4B5563;
            font-size: 16px;
            line-height: 1.6;
            margin-bottom: 6px;
            /* white-space: pre-wrap; */
            word-break: break-word;
        }
        .comment-actions {
            display: flex;
            gap: 12px;
            font-size: 13px;
        }
        .comment-action-btn {
            color: #6B7280;
            cursor: pointer;
            background: none;
            border: none;
            padding: 0;
        }
        .comment-action-btn:hover {
            color: #3B82F6;
        }
        .reply-section {
            margin-left: 40px;
            margin-top: 12px;
            padding-left: 16px;
            border-left: 2px solid #E5E7EB;
        }
        .reply-item {
            padding: 8px 0;
            border-bottom: 1px solid #F3F4F6;
        }
        .reply-item:last-child {
            border-bottom: none;
        }
        .loading {
            padding:0;
            text-align: center;
            color: #6B7280;
        }
        .edit-form {
            margin-top: 10px;
        }
        .edit-form textarea {
            width: 100%;
            min-height: 60px;
            padding: 10px;
            border: 1px solid #D1D5DB;
            border-radius: 6px;
            font-size: 14px;
            box-sizing: border-box;
            font-family: inherit;
        }
        .btn-sm {
            padding: 6px 12px;
            font-size: 15px;
        }
        .alert {
            padding: 12px;
            border-radius: 6px;
            margin-bottom: 20px;
        }
        .alert-error {
            background: #FEE2E2;
            color: #991B1B;
            border: 1px solid #FCA5A5;
        }
        .alert-success {
            background: #D1FAE5;
            color: #065F46;
            border: 1px solid #6EE7B7;
        }
    </style>
</head>
<body>
    <div class="detail-container">
        <a href="/board" class="back-link">â† ëª©ë¡ìœ¼ë¡œ</a>

        <div id="postContainer" class="loading">ê²Œì‹œê¸€ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>

        <div id="commentsContainer" style="display: none;">
            <div class="comments-section">
                <h3 class="comments-header">ëŒ“ê¸€ <span id="commentCount">0</span></h3>

                <div class="comment-list" id="commentList"></div>

                <div id="commentFormContainer"></div>
            </div>
        </div>
    </div>

    <script>
        const postId = window.location.pathname.split('/').pop();
        let currentUser = null;
        let postData = null;

        // ì‚¬ìš©ì ì •ë³´ í™•ì¸
        async function checkUser() {
            try {
                const response = await fetch('/api/auth/me');
                const data = await response.json();
                if (data.authenticated) {
                    currentUser = data.user;
                }
            } catch (error) {
                console.error('Failed to check user:', error);
            }
        }

        // ê²Œì‹œê¸€ ë¡œë“œ
        async function loadPost() {
            try {
                const response = await fetch(`/api/board/posts/${postId}`);
                const data = await response.json();

                if (data.success) {
                    postData = data.post;
                    displayPost(data.post);
                    displayComments(data.comments);
                    document.getElementById('commentsContainer').style.display = 'block';
                } else {
                    document.getElementById('postContainer').innerHTML = '<div class="post-card">ê²Œì‹œê¸€ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤</div>';
                }
            } catch (error) {
                console.error('Failed to load post:', error);
                document.getElementById('postContainer').innerHTML = '<div class="post-card">ê²Œì‹œê¸€ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤</div>';
            }
        }

        // ê²Œì‹œê¸€ í‘œì‹œ
        function displayPost(post) {
            const categoryLabels = {
                'free': 'ììœ ê²Œì‹œíŒ',
                'notice': 'ê³µì§€ì‚¬í•­',
                'qna': 'ì§ˆë¬¸ë‹µë³€',
                'review': 'í›„ê¸°',
                'tips': 'íŒ/ë…¸í•˜ìš°'
            };

            const date = new Date(post.created_at);
            const dateStr = date.toLocaleString('ko-KR');

            let actions = '';
            if (post.is_author) {
                actions = `
                    <a href="/board/write?id=${post.id}" class="btn btn-primary">ìˆ˜ì •</a>
                    <button onclick="deletePost()" class="btn btn-danger">ì‚­ì œ</button>
                `;
            }
            actions += `<button onclick="likePost()" class="btn btn-secondary">â¤ï¸ ì¢‹ì•„ìš” (${post.like_count})</button>`;

            const html = `
                <div class="post-card">
                    <div class="post-header">
                        <span class="post-category">${categoryLabels[post.category] || post.category}</span>
                        <h1 class="post-title">${post.title}</h1>
                        <div class="post-meta">
                            <span>ğŸ‘¤ ${post.author.username}</span>
                            <span>ğŸ“… ${dateStr}</span>
                            <span>ğŸ‘ï¸ ${post.view_count}</span>
                        </div>
                    </div>
                    <div class="post-content">${post.content}</div>
                    <div class="post-actions">
                        ${actions}
                    </div>
                </div>
            `;

            document.getElementById('postContainer').innerHTML = html;
        }

        // ëŒ“ê¸€ í‘œì‹œ
        function displayComments(comments) {
            const count = comments.reduce((total, c) => total + 1 + c.replies.length, 0);
            document.getElementById('commentCount').textContent = count;

            // ëŒ“ê¸€ ì‘ì„± í¼
            const formHtml = currentUser ? `
                <div class="comment-form">
                    <textarea id="commentContent" placeholder="ëŒ“ê¸€ì„ ì…ë ¥í•˜ì„¸ìš”..."></textarea>
                    <div class="comment-form-actions">
                        <button class="btn btn-primary btn-sm" onclick="submitComment()">ëŒ“ê¸€ ì‘ì„±</button>
                    </div>
                </div>
            ` : '<p style="color: #6B7280; padding: 20px; text-align: center;">ëŒ“ê¸€ì„ ì‘ì„±í•˜ë ¤ë©´ <a href="/login" style="color: #3B82F6;">ë¡œê·¸ì¸</a>í•˜ì„¸ìš”</p>';

            document.getElementById('commentFormContainer').innerHTML = formHtml;

            // ëŒ“ê¸€ ëª©ë¡
            const html = comments.map(comment => renderComment(comment)).join('');
            document.getElementById('commentList').innerHTML = html || '<p style="color: #9CA3AF; text-align: center; padding: 20px;">ì•„ì§ ëŒ“ê¸€ì´ ì—†ìŠµë‹ˆë‹¤</p>';
        }

        // ëŒ“ê¸€ ë Œë”ë§
        function renderComment(comment, isReply = false) {
            const date = new Date(comment.created_at);
            const dateStr = date.toLocaleString('ko-KR');
            const isAuthor = currentUser && currentUser.id === comment.author.id;

            const actions = isAuthor ? `
                <button class="comment-action-btn" onclick="editComment(${comment.id}, '${comment.content.replace(/'/g, "\\'")}')">ìˆ˜ì •</button>
                <button class="comment-action-btn" onclick="deleteComment(${comment.id})">ì‚­ì œ</button>
            ` : '';

            const replyBtn = currentUser && !isReply ? `
                <button class="comment-action-btn" onclick="showReplyForm(${comment.id})">ë‹µê¸€</button>
            ` : '';

            let repliesHtml = '';
            if (comment.replies && comment.replies.length > 0) {
                repliesHtml = `
                    <div class="reply-section">
                        ${comment.replies.map(reply => renderComment(reply, true)).join('')}
                    </div>
                `;
            }

            const itemClass = isReply ? 'reply-item' : 'comment-item';

            return `
                <div class="${itemClass}" id="comment-${comment.id}">
                    <div class="comment-header">
                        <span class="comment-author">${comment.author.username}</span>
                        <span class="comment-date">${dateStr}</span>
                    </div>
                    <div class="comment-content" id="comment-content-${comment.id}">${comment.content}</div>
                    <div class="comment-actions">
                        ${replyBtn}
                        ${actions}
                    </div>
                    <div id="reply-form-${comment.id}"></div>
                    ${repliesHtml}
                </div>
            `;
        }

        // ëŒ“ê¸€ ì‘ì„±
        async function submitComment(parentId = null) {
            const contentId = parentId ? `reply-content-${parentId}` : 'commentContent';
            const content = document.getElementById(contentId)?.value.trim();

            if (!content || content.length < 2) {
                alert('ëŒ“ê¸€ì€ 2ì ì´ìƒ ì…ë ¥í•´ì£¼ì„¸ìš”');
                return;
            }

            try {
                const response = await fetch(`/api/board/posts/${postId}/comments`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ content, parent_id: parentId })
                });

                const data = await response.json();

                if (response.ok && data.success) {
                    await loadPost();
                } else {
                    alert(data.detail || 'ëŒ“ê¸€ ì‘ì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤');
                }
            } catch (error) {
                console.error('Failed to submit comment:', error);
                alert('ëŒ“ê¸€ ì‘ì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤');
            }
        }

        // ë‹µê¸€ í¼ í‘œì‹œ
        function showReplyForm(commentId) {
            const formContainer = document.getElementById(`reply-form-${commentId}`);
            formContainer.innerHTML = `
                <div class="edit-form">
                    <textarea id="reply-content-${commentId}" placeholder="ë‹µê¸€ì„ ì…ë ¥í•˜ì„¸ìš”..."></textarea>
                    <div style="display: flex; gap: 8px; margin-top: 8px;">
                        <button class="btn btn-primary btn-sm" onclick="submitComment(${commentId})">ì‘ì„±</button>
                        <button class="btn btn-secondary btn-sm" onclick="hideReplyForm(${commentId})">ì·¨ì†Œ</button>
                    </div>
                </div>
            `;
        }

        function hideReplyForm(commentId) {
            document.getElementById(`reply-form-${commentId}`).innerHTML = '';
        }

        // ëŒ“ê¸€ ìˆ˜ì •
        function editComment(commentId, currentContent) {
            const contentDiv = document.getElementById(`comment-content-${commentId}`);
            contentDiv.innerHTML = `
                <div class="edit-form">
                    <textarea id="edit-content-${commentId}">${currentContent}</textarea>
                    <div style="display: flex; gap: 8px; margin-top: 8px;">
                        <button class="btn btn-primary btn-sm" onclick="updateComment(${commentId})">ì €ì¥</button>
                        <button class="btn btn-secondary btn-sm" onclick="loadPost()">ì·¨ì†Œ</button>
                    </div>
                </div>
            `;
        }

        async function updateComment(commentId) {
            const content = document.getElementById(`edit-content-${commentId}`)?.value.trim();

            if (!content || content.length < 2) {
                alert('ëŒ“ê¸€ì€ 2ì ì´ìƒ ì…ë ¥í•´ì£¼ì„¸ìš”');
                return;
            }

            try {
                const response = await fetch(`/api/board/comments/${commentId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ content })
                });

                const data = await response.json();

                if (response.ok && data.success) {
                    await loadPost();
                } else {
                    alert(data.detail || 'ëŒ“ê¸€ ìˆ˜ì •ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤');
                }
            } catch (error) {
                console.error('Failed to update comment:', error);
                alert('ëŒ“ê¸€ ìˆ˜ì • ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤');
            }
        }

        // ëŒ“ê¸€ ì‚­ì œ
        async function deleteComment(commentId) {
            if (!confirm('ëŒ“ê¸€ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;

            try {
                const response = await fetch(`/api/board/comments/${commentId}`, {
                    method: 'DELETE'
                });

                const data = await response.json();

                if (response.ok && data.success) {
                    await loadPost();
                } else {
                    alert(data.detail || 'ëŒ“ê¸€ ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤');
                }
            } catch (error) {
                console.error('Failed to delete comment:', error);
                alert('ëŒ“ê¸€ ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤');
            }
        }

        // ê²Œì‹œê¸€ ì‚­ì œ
        async function deletePost() {
            if (!confirm('ê²Œì‹œê¸€ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;

            try {
                const response = await fetch(`/api/board/posts/${postId}`, {
                    method: 'DELETE'
                });

                const data = await response.json();

                if (response.ok && data.success) {
                    alert('ê²Œì‹œê¸€ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤');
                    location.href = '/board';
                } else {
                    alert(data.detail || 'ê²Œì‹œê¸€ ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤');
                }
            } catch (error) {
                console.error('Failed to delete post:', error);
                alert('ê²Œì‹œê¸€ ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤');
            }
        }

        // ì¢‹ì•„ìš”
        async function likePost() {
            if (!currentUser) {
                alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤');
                return;
            }

            try {
                const response = await fetch(`/api/board/posts/${postId}/like`, {
                    method: 'POST'
                });

                const data = await response.json();

                if (response.ok && data.success) {
                    await loadPost();
                } else {
                    alert(data.detail || 'ì¢‹ì•„ìš” ì²˜ë¦¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤');
                }
            } catch (error) {
                console.error('Failed to like post:', error);
                alert('ì¢‹ì•„ìš” ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤');
            }
        }

        // ì´ˆê¸°í™”
        (async () => {
            await checkUser();
            await loadPost();
        })();
    </script>
</body>
</html>

